<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <title>RH - Férias - Kwanza Manipulus</title>
  <link rel="shortcut icon" type="image/x-icon" href="assets/img/logo.png">
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/fontawesome.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="assets/css/feathericon.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    :root { --primary-color:#2c3e50; --primary-dark:#1a252f; --accent-color:#0fd7d4; --accent-dark:#0ab5b3; --dark-bg:#000; --card-bg:#fff; --border-color:#dee2e6; --shadow-md:0 4px 6px rgba(0,0,0,0.07); --shadow-lg:0 10px 25px rgba(0,0,0,0.1); --transition-smooth:all .3s cubic-bezier(.4,0,.2,1);} 
    body{background:linear-gradient(135deg,#f5f7fa 0,#e8ecf1 100%);font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-size:14px;}
    .header{background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.04);border-bottom:1px solid #dee2e6;}
    .header-left{background:linear-gradient(135deg,#000 0,#000 100%)!important;}
    .sidebar{background:#000!important;box-shadow:2px 0 10px rgba(0,0,0,.3);} 
    .sidebar .sidebar-menu ul li a{color:#fff!important;opacity:.85;padding:12px 20px;border-radius:8px;margin:4px 10px;transition:.2s;} 
    .sidebar .sidebar-menu ul li a:hover{background:rgba(15,215,212,.1);transform:translateX(5px);} 
    .sidebar .sidebar-menu ul li.active>a{background:rgba(15,215,212,.2);border-left:3px solid #0fd7d4;font-weight:600;} 
    .sidebar .submenu_class li a{color:#f2f9ff!important;font-size:13px;opacity:.8;}
    
    .sidebar .sidebar-menu > ul > li > a i {
      color: #ffffff !important;
      font-size: 15px;
      margin-right: 6px;
    } 
    .card{border:none;border-radius:12px;box-shadow:var(--shadow-md);transition:var(--transition-smooth);background:#fff;} 
    .card:hover{box-shadow:var(--shadow-lg);} 
    .card-header{background:#2c3e50;border:none;border-radius:10px 10px 0 0!important;padding:12px 20px;} 
    .card-header h4{color:#fff!important;margin:0;font-weight:600;font-size:.95rem;} 
    .card-body{padding:24px;} 
    .card-table{background:#000!important;border:1px solid rgba(10,181,179,.3);box-shadow:0 4px 15px rgba(0,0,0,.3);} 
    .card-table .card-header{background:linear-gradient(135deg,#0ab5b3 0,#08a09e 100%)!important;border-bottom:2px solid #0ab5b3;} 
    .card-table .card-body{background:#000!important;padding:20px;} 
    .table{margin-bottom:0;background:#000!important;} 
    .table thead th{background:#1a1a1a!important;color:#0ab5b3!important;font-weight:600;font-size:.85rem;text-transform:uppercase;letter-spacing:.5px;border:1px solid rgba(10,181,179,.2)!important;padding:14px 12px;} 
    .table tbody tr{transition:.2s;background:#000!important;border-bottom:1px solid rgba(10,181,179,.1);} 
    .table tbody tr:hover{background:rgba(10,181,179,.1)!important;transform:scale(1.005);box-shadow:0 2px 8px rgba(10,181,179,.2);} 
    .table tbody td{padding:12px;vertical-align:middle;border-color:rgba(10,181,179,.1)!important;color:#e0e0e0!important;} 
    .btn-primary{background:#0fd7d4;border:none;border-radius:8px;padding:10px 24px;font-weight:600;letter-spacing:.3px;transition:var(--transition-smooth);box-shadow:0 4px 12px rgba(15,215,212,.25);color:#000;} 
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(15,215,212,.35);background:#0ab5b3;color:#fff;} 
    .page-wrapper .content.container-fluid{margin-top:30px;} 
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="header">
			<div class="header-left">
				<a href="dashboard.html" class="logo"> <img src="assets/img/kwanzaWhite.svg" width="50" height="70" alt="logo"> <span class="logoclass"></span> </a>
				<a href="dashboard.html" class="logo logo-small"> <img src="assets/img/kwanzaWhite.svg" alt="Logo" width="30" height="30"> </a>
			</div>
			<a href="javascript:void(0);" id="toggle_btn"> <i class="fe fe-text-align-left"></i> </a>
			<a class="mobile_btn" id="mobile_btn"> <i class="fas fa-bars"></i> </a>
			<ul class="nav user-menu">
				<li class="nav-item dropdown has-arrow">
					<a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown"> <span class="user-img"><img class="rounded-circle" src="assets/img/profiles/avatar-01.jpg" width="31" alt=""></span> </a>
					<div class="dropdown-menu">
						<div class="user-header">
							<div class="avatar avatar-sm"> <img src="foto do perfil" alt="User Image" class="avatar-img rounded-circle"> </div>
							<div class="user-text">
								<div class="muted" style="font-size:11px">Bem-vindo(a), </div>
								<h6><span id="userName">usuário</span></h6>
							</div>
						</div> <a class="dropdown-item" href="profile.html">Perfil</a> <a class="dropdown-item" href="settings.html">configurações da conta</a> <a class="dropdown-item" id="logoutBtn" href="#">Sair</a> </div>
				</li>
			</ul>
			<div class="top-nav-search">
				<form>
					<input type="text" class="form-control" placeholder="procurar">
					<button class="btn" type="submit"><i class="fas fa-search"></i></button>
				</form>
			</div>
		</div>
		<div class="sidebar" id="sidebar">
			<div class="sidebar-inner slimscroll">
				<div id="sidebar-menu" class="sidebar-menu">
					<ul>
						<li> <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a> </li>
						<li> <a href="clientes_clientes.html"><i class="fas fa-user"></i> <span>Clientes</span></a></li>
						<li class="submenu"> <a href="#" data-toggle="collapse"><i class="fas fa-user"></i> <span> Empresa </span> <span class="menu-arrow"></span></a>
							<ul class="submenu_class" style="display: none;">
								<li><a href="rh_funcionarios.html">Funcionários</a></li>
								<li><a href="rh_departamentos.html">Departamentos & Cargos</a></li>
								<li class="active"><a href="rh_ferias.html">Férias</a></li>
								<li><a href="users.html">Utilizadores</a></li>
							</ul>
						</li>
						
						<li class="submenu"> <a href="#" data-toggle="collapse"><i class="fas fa-user"></i> <span> Fornecedores</span> <span class="menu-arrow"></span></a>
							<ul class="submenu_class" style="display: none;">
								<li><a href="fornecedor.html">Lista de Fornecedores </a></li>
							</ul>
						</li>
						<li> <a href="financas.html#bancos"><i class="fas fa-university"></i> <span> Bancos</span></a> </li>
						<li> <a href="financas.html#pagamentos"><i class="fas fa-money-bill-alt"></i> <span> Pagamentos</span></a> </li>
            <li> <a href="faturas.html"><i class="fas fa-file-invoice"></i> <span>Faturas</span></a> </li>
						<li> <a href="projectos.html"><i class="fas fa-cube"></i> <span>Projectos Kwanza </span></a> </li>
					</ul>
				</div>
			</div>
		</div>
    <div class="page-wrapper">
      <div class="content container-fluid">
        <div class="page-header">
          <div class="row align-items-center">
            <div class="col">
              <h3 class="page-title">Férias</h3>
              <p class="text-muted mb-0">Gestão de pedidos de férias e ausências</p>
            </div>
            <div class="col-auto float-right ml-auto">
              <button class="btn btn-primary" id="btnNovoPedido"><i class="fa fa-plus"></i> Novo Pedido</button>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-3 mb-2">
            <select id="filtroFuncionario" class="form-control form-control-sm">
              <option value="">Todos os funcionários</option>
            </select>
          </div>
          <div class="col-md-3 mb-2">
            <select id="filtroEstado" class="form-control form-control-sm">
              <option value="">Todos os estados</option>
              <option value="PENDENTE">Pendentes</option>
              <option value="APROVADO">Aprovados</option>
              <option value="REJEITADO">Rejeitados</option>
            </select>
          </div>
        </div>

        <div class="card card-table">
          <div class="card-header">
            <h4 class="card-title">Pedidos de Férias</h4>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="tblFerias">
                <thead>
                  <tr>
                    <th>Funcionário</th>
                    <th>Início</th>
                    <th>Fim</th>
                    <th>Estado</th>
                    <th>Motivo</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal Pedido de Férias -->
  <div class="modal fade" id="modalFerias" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Pedido de Férias</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <form id="formFerias">
            <input type="hidden" id="ferias_id">
            <div class="form-group">
              <label>Funcionário *</label>
              <select id="ferias_id_funcionario" class="form-control form-control-sm" required>
                <option value="">Selecione</option>
              </select>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Data Início *</label>
                <input type="date" id="ferias_data_inicio" class="form-control form-control-sm" required>
              </div>
              <div class="form-group col-md-6">
                <label>Data Fim *</label>
                <input type="date" id="ferias_data_fim" class="form-control form-control-sm" required>
              </div>
            </div>
            <div class="form-group">
              <label>Motivo</label>
              <textarea id="ferias_motivo" class="form-control form-control-sm" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnSalvarFerias">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/jquery-3.5.1.min.js"></script>
  <script src="assets/js/popper.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <script src="assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/script.js"></script>
  <!-- Carrega o avatar do usuário -->
  <script src="js/profile-avatar.js"></script>
  <script>
    const token = localStorage.getItem('token');
    if(!token){ window.location.href = '/'; }

    let funcionarios = [];
    let feriasLista = [];
    let currentUser = null;

    function getFuncionarioNome(id){
      if(!id) return '';
      const f = funcionarios.find(x => String(x.id) === String(id));
      return f ? f.nome : '';
    }

    function renderFuncionariosSelects(){
      const selFiltro = document.getElementById('filtroFuncionario');
      const selForm = document.getElementById('ferias_id_funcionario');
      selFiltro.innerHTML = '<option value="">Todos os funcionários</option>' + funcionarios.map(f => `<option value="${f.id}">${f.nome}</option>`).join('');
      selForm.innerHTML = '<option value="">Selecione</option>' + funcionarios.map(f => `<option value="${f.id}">${f.nome}</option>`).join('');
    }

    async function fetchFuncionarios(){
      try{
        const res = await fetch('/api/empresa/funcionarios', { headers: { Authorization: `Bearer ${token}` } });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        funcionarios = Array.isArray(data) ? data : (data.items || []);
        renderFuncionariosSelects();
      }catch(e){ console.error('Erro ao carregar funcionarios', e); }
    }

    async function fetchFerias(){
      try{
        const params = new URLSearchParams();
        const idFunc = document.getElementById('filtroFuncionario').value;
        const estado = document.getElementById('filtroEstado').value;
        if(idFunc) params.append('id_funcionario', idFunc);
        if(estado) params.append('estado', estado);
        const url = '/api/rh/ferias' + (params.toString() ? ('?' + params.toString()) : '');
        const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        feriasLista = Array.isArray(data) ? data : (data.items || []);
        renderFerias();
      }catch(e){ console.error('Erro ao carregar ferias', e); }
    }

    function renderFerias(){
      const tbody = document.querySelector('#tblFerias tbody');
      tbody.innerHTML = feriasLista.map(p => `
        <tr>
          <td>${getFuncionarioNome(p.id_funcionario)}</td>
          <td>${p.data_inicio || ''}</td>
          <td>${p.data_fim || ''}</td>
          <td>${p.estado || ''}</td>
          <td>${p.motivo || ''}</td>
          <td>
            <button class="btn btn-sm btn-info btn-edit" data-id="${p.id}"><i class="fas fa-edit"></i></button>
            ${ (currentUser && (currentUser.tipo === 'admin' || currentUser.tipo === 'rh')) ? `
              <button class="btn btn-sm btn-success btn-aprovar" data-id="${p.id}"><i class="fas fa-check"></i></button>
              <button class="btn btn-sm btn-warning btn-rejeitar" data-id="${p.id}"><i class="fas fa-times"></i></button>
              <button class="btn btn-sm btn-danger btn-del" data-id="${p.id}"><i class="fas fa-trash"></i></button>
            ` : ''}
          </td>
        </tr>
      `).join('');
    }

    document.getElementById('filtroFuncionario').addEventListener('change', fetchFerias);
    document.getElementById('filtroEstado').addEventListener('change', fetchFerias);

    document.getElementById('btnNovoPedido').addEventListener('click', () => {
      const form = document.getElementById('formFerias');
      form.reset();
      document.getElementById('ferias_id').value = '';
      $('#modalFerias').modal('show');
    });

    document.getElementById('btnSalvarFerias').addEventListener('click', async () => {
      const id = document.getElementById('ferias_id').value;
      const payload = {
        id_funcionario: document.getElementById('ferias_id_funcionario').value,
        data_inicio: document.getElementById('ferias_data_inicio').value,
        data_fim: document.getElementById('ferias_data_fim').value,
        motivo: document.getElementById('ferias_motivo').value,
      };
      if(!payload.id_funcionario || !payload.data_inicio || !payload.data_fim){
        alert('Funcionário, data início e data fim são obrigatórios.');
        return;
      }
      try{
        let res;
        if(!id){
          res = await fetch('/api/rh/ferias', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
            body: JSON.stringify(payload),
          });
        }else{
          res = await fetch(`/api/rh/ferias/${encodeURIComponent(id)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
            body: JSON.stringify(payload),
          });
        }
        if(!res.ok) throw new Error(await res.text() || ('HTTP ' + res.status));
        $('#modalFerias').modal('hide');
        await fetchFerias();
      }catch(e){ alert('Erro ao salvar pedido de férias: ' + e.message); }
    });

    document.addEventListener('click', async (e) => {
      if(e.target.closest && e.target.closest('.btn-edit')){
        const id = e.target.closest('.btn-edit').getAttribute('data-id');
        const p = feriasLista.find(x => String(x.id) === String(id));
        if(!p) return;
        document.getElementById('ferias_id').value = p.id;
        document.getElementById('ferias_id_funcionario').value = p.id_funcionario;
        document.getElementById('ferias_data_inicio').value = p.data_inicio || '';
        document.getElementById('ferias_data_fim').value = p.data_fim || '';
        document.getElementById('ferias_motivo').value = p.motivo || '';
        $('#modalFerias').modal('show');
      }
      if(e.target.closest && e.target.closest('.btn-aprovar')){
        const id = e.target.closest('.btn-aprovar').getAttribute('data-id');
        if(!confirm('Aprovar este pedido de férias?')) return;
        try{
          const res = await fetch(`/api/rh/ferias/${encodeURIComponent(id)}/estado`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
            body: JSON.stringify({ estado: 'APROVADO' }),
          });
          if(!res.ok) throw new Error(await res.text() || ('HTTP ' + res.status));
          await fetchFerias();
        }catch(e){ alert('Erro ao aprovar férias: ' + e.message); }
      }
      if(e.target.closest && e.target.closest('.btn-rejeitar')){
        const id = e.target.closest('.btn-rejeitar').getAttribute('data-id');
        if(!confirm('Rejeitar este pedido de férias?')) return;
        try{
          const res = await fetch(`/api/rh/ferias/${encodeURIComponent(id)}/estado`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
            body: JSON.stringify({ estado: 'REJEITADO' }),
          });
          if(!res.ok) throw new Error(await res.text() || ('HTTP ' + res.status));
          await fetchFerias();
        }catch(e){ alert('Erro ao rejeitar férias: ' + e.message); }
      }
      if(e.target.closest && e.target.closest('.btn-del')){
        const id = e.target.closest('.btn-del').getAttribute('data-id');
        if(!confirm('Eliminar este pedido de férias?')) return;
        try{
          const res = await fetch(`/api/rh/ferias/${encodeURIComponent(id)}`, {
            method: 'DELETE',
            headers: { Authorization: `Bearer ${token}` },
          });
          if(!res.ok && res.status !== 204) throw new Error(await res.text() || ('HTTP ' + res.status));
          await fetchFerias();
        }catch(e){ alert('Erro ao eliminar férias: ' + e.message); }
      }
    });

    (async function init(){
      try{
        const resMe = await fetch('/api/users/me', { headers: { Authorization: `Bearer ${token}` } });
        if(!resMe.ok){ if(resMe.status === 401) window.location.href = '/'; return; }
        currentUser = await resMe.json();
        const el = document.getElementById('userName');
        if(el) el.textContent = currentUser?.nome || 'usuário';
        await fetchFuncionarios();
        await fetchFerias();
      }catch(e){ console.error('Erro ao iniciar página de férias', e); }
    })();
  </script>
</body>
</html>
