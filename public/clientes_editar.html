<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <title>Editar Cliente - Kwanzas Metal</title>
  <link rel="shortcut icon" type="image/x-icon" href="assets/img/logo.png">
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/fontawesome.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="assets/css/feathericon.min.css">
  <link rel="stylesheet" href="assets/plugins/morris/morris.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .sidebar{ color: white !important; }
    .header{ background-color: rgb(104, 171, 187); }
    .fas{ color: rgb(10, 153, 205) !important; }
    body{ color: rgb(6, 131, 227); }
    .header{
    background-color: white;
  }
  .header-left{
	background-color: black !important;
  }
  
    body{
      color: rgb(6, 131, 227);
    }
    .board1{
      border-radius: 12px;
      border: solid 1px  rgb(6, 131, 227);
      cursor: pointer;
    }
    /* UI refinements */
    .card.board1:hover{ box-shadow: 0 8px 20px rgba(0,0,0,0.08); transform: translateY(-2px); transition: all .2s ease; }
    /* Sidebar text colors */
    .sidebar .sidebar-menu ul li a{ color: white; opacity: .85; }
    .sidebar .sidebar-menu ul li a:hover{ color:#ffffff; opacity: 1; }
    .sidebar .submenu_class li a{ color:#f2f9ff; opacity:.8; }
    .sidebar .submenu_class li a:hover{ color:#0fd7d4; opacity:1; }
    .sidebar .sidebar-menu ul li.active > a, .sidebar .submenu_class li.active > a{ color:#ffffff; font-weight:600; }
    .page-header h1{ color:#066fe3; font-weight:600; }
    .card-metric{ color:#fff; border:0; }
    .metric-1{ background: linear-gradient(135deg,#042742,#08ecec); }
    .metric-2{ background: linear-gradient(135deg,#042742,#08ecec); }
    .metric-3{ background: linear-gradient(135deg,#042742,#08ecec); }
    .metric-4{ background: linear-gradient(135deg,#042742,#08ecec); }
    .card-metric .text-muted{ color: rgba(255,255,255,.85)!important; }
    .card-metric svg{ stroke:#fff!important; }
    .card-metric .card_widget_header{ color:#fff; }
  </style>
</head>
<body>
<div class="main-wrapper">
  <div class="header">
			<div class="header-left">
				<a href="dashboard.html" class="logo"> <img src="assets/img/kwanzaWhite.svg" width="50" height="70" alt="logo"> <span class="logoclass"></span> </a>
				<a href="dashboard.html" class="logo logo-small"> <img src="assets/img/kwanzaWhite.svg" alt="Logo" width="30" height="30"> </a>
			</div>
			<a href="javascript:void(0);" id="toggle_btn"> <i class="fe fe-text-align-left"></i> </a>
			<a class="mobile_btn" id="mobile_btn"> <i class="fas fa-bars"></i> </a>
			<ul class="nav user-menu">
				<li class="nav-item dropdown noti-dropdown">
					<a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown"> <i class="fe fe-bell"></i> <span class="badge badge-pill">0</span> </a>
					<div class="dropdown-menu notifications">
						<div class="topnav-dropdown-header"> <span class="notification-title">Notificações</span> <a href="javascript:void(0)" class="clear-noti"> Limpar Todos</a> </div>
						<div class="noti-content">
							
						</div>
						<div class="topnav-dropdown-footer"> <a href="#">Ver todas as Notificações</a> </div>
					</div>
				</li>
				<li class="nav-item dropdown has-arrow">
					<a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown"> <span class="user-img"><img class="rounded-circle" src="assets/img/profiles/avatar-01.jpg" width="31" alt=""></span> </a>
					<div class="dropdown-menu">
						<div class="user-header">
							<div class="avatar avatar-sm"> <img src="foto do perfil" alt="User Image" class="avatar-img rounded-circle"> </div>
							<div class="user-text">
								<div class="muted" style="font-size:11px">Bem-vindo(a), </div>
								<h6><span id="userName">usuário</span></h6>
							</div>
						</div> <a class="dropdown-item" href="profile.html">Perfil</a> <a class="dropdown-item" href="settings.html">configurações da conta</a> <a class="dropdown-item" id="logoutBtn" href="#">Sair</a> </div>
				</li>
			</ul>
			<div class="top-nav-search">
				<form>
					<input type="text" class="form-control" placeholder="procurar">
					<button class="btn" type="submit"><i class="fas fa-search"></i></button>
				</form>
			</div>
		</div>
		<div class="sidebar" id="sidebar">
			<div class="sidebar-inner slimscroll">
				<div id="sidebar-menu" class="sidebar-menu">
					<ul>
						<li class="active"> <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a> </li>
						<li class="list-divider"></li>
						<li class="submenu"> <a href="clientes_clientes.html"><i class="fas fa-user"></i> <span> Clientes </span> <span class="menu-arrow"></span></a>
							<ul class="submenu_class" style="display: none;">
								<li><a href="clientes_clientes.html">  Todos os clientes</a></li>
								<li><a href="clientes_editar.html"> Editar clientes </a></li>
								<li><a href="clientes_adicionar.html"> Adicionar clientes </a></li>
							</ul>
						</li>
						<li class="submenu"> <a href="#"><i class="fas fa-user"></i> <span> Empresa </span> <span class="menu-arrow"></span></a>
							<ul class="submenu_class" style="display: none;">
								<li><a href="rh_funcionarios.html">Funcionários</a></li>
								<li><a href="rh_departamentos.html">Departamentos & Cargos</a></li>
								<li><a href="rh_ferias.html">Férias</a></li>
								<li><a href="users.html">Utilizadores</a></li>
							</ul>
						</li>
						
						<li class="submenu"> <a href="fornecedor.html"><i class="fas fa-user"></i> <span> Fornecedores</span> <span class="menu-arrow"></span></a>
							<ul class="submenu_class" style="display: none;">
								<li><a href="fornecedor.html">Lista de Fornecedores </a></li>
							</ul>
						</li>
						<li> <a href="financas.html#bancos"><i class="fas fa-university"></i> <span> Bancos</span></a> </li>
						<li> <a href="financas.html#pagamentos"><i class="fas fa-money-bill-alt"></i> <span> Pagamentos</span></a> </li>
						<li> <a href="projectos.html"><i class="fas fa-cube"></i> <span>Projectos Kwanza </span></a> </li>
						<li class="list-divider"></li>
						<li class="list-divider"></li>
						<li class="menu-title mt-3"> <span>EXTRAS</span> </li>
					</ul>
				</div>
			</div>
		</div>

  <div class="page-wrapper">
    <div class="content container-fluid">
      <div class="page-header">
        <div class="row">
          <div class="col-sm-12 mt-5">
            <h1>Editar Cliente</h1>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <form id="formCliente">
            <input type="hidden" name="id" id="cliId" />
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Nome</label>
                <input name="nome" id="cliNome" class="form-control" required>
              </div>
              <div class="form-group col-md-6">
                <label>Email</label>
                <input name="email" id="cliEmail" type="email" class="form-control" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label>Telefone</label>
                <input name="telefone" id="cliTelefone" class="form-control">
              </div>
              <div class="form-group col-md-4">
                <label>NIF</label>
                <input name="nif" id="cliNif" class="form-control" required>
              </div>
              <div class="form-group col-md-4">
                <label>Estado</label>
                <select name="estado" id="cliEstado" class="form-control">
                  <option value="Ativo">Ativo</option>
                  <option value="Inativo">Inativo</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Endereço</label>
              <input name="endereco" id="cliEndereco" class="form-control">
            </div>
            <div class="text-right">
              <a href="clientes.html" class="btn btn-outline-secondary">Cancelar</a>
              <button type="button" id="btnAtualizar" class="btn btn-primary">Atualizar</button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="assets/js/jquery-3.5.1.min.js"></script>
<script src="assets/js/popper.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/api.js"></script>
<script src="assets/js/script.js"></script>
  <!-- Carrega o avatar do usuário -->
  <script src="js/profile-avatar.js"></script>
<style>
  .alerts-container{ position: fixed; top: 70px; right: 16px; z-index: 1080; width: 320px; }
</style>
<div class="alerts-container" id="alertsContainer"></div>
<script>
  async function checkAuth(){
    const token = localStorage.getItem('token');
    if(!token){ window.location.href = '/'; return; }
    const res = await fetch('/api/users/me', { headers: { Authorization: `Bearer ${token}` } });
    if (res.status === 401 || res.status === 403) { localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = '/'; }
  }
  checkAuth();

  function showAlert(message, variant = 'success', timeout = 3000){
    const container = document.getElementById('alertsContainer');
    if(!container) return window.alert(message);
    const id = 'al_'+Date.now()+Math.random().toString(16).slice(2);
    const el = document.createElement('div');
    el.id = id;
    el.className = `alert alert-${variant} alert-dismissible fade show mb-2`;
    el.role = 'alert';
    el.innerHTML = `
      <div>${message}</div>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>`;
    container.appendChild(el);
    if(timeout){ setTimeout(() => { try{ $(el).alert('close'); }catch{} el.remove(); }, timeout); }
  }

  function getParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  // Carrega dados reais do backend
  const id = getParam('id');
  (async () => {
    if(id){
      try{
        const data = await API.getJSON(`/api/clientes/${encodeURIComponent(id)}`);
        document.getElementById('cliId').value = data?.id || id;
        document.getElementById('cliNome').value = data?.nome || data?.nome_firma || '';
        document.getElementById('cliEmail').value = data?.email || '';
        document.getElementById('cliTelefone').value = data?.telefone || '';
        document.getElementById('cliNif').value = data?.nif || '';
        document.getElementById('cliEstado').value = data?.estado || 'Ativo';
        document.getElementById('cliEndereco').value = data?.endereco || '';
      }catch(e){
        alert('Erro ao carregar cliente: ' + e.message);
      }
    }
  })();

  document.getElementById('btnAtualizar').addEventListener('click', async () => {
    const form = document.getElementById('formCliente');
    const fd = new FormData(form);
    const atualizado = Object.fromEntries(fd.entries());
    // Normalização e validação
    atualizado.nome = (atualizado.nome || '').trim();
    atualizado.nif = (atualizado.nif || '').trim();
    if(!atualizado.nome){ alert('Por favor, preencha o Nome.'); return; }
    if(!atualizado.nif){ alert('Por favor, preencha o NIF.'); return; }
    if(atualizado.email) atualizado.email = atualizado.email.trim();
    if(atualizado.telefone) atualizado.telefone = atualizado.telefone.trim();
    // Compatibilidade
    atualizado.nome_firma = atualizado.nome;
    try{
      await API.putJSON(`/api/clientes/${encodeURIComponent(atualizado.id)}`, atualizado);
      showAlert('Cliente atualizado com sucesso!', 'success');
      setTimeout(() => { window.location.href = 'clientes.html'; }, 800);
    }catch(e){
      showAlert('Erro ao atualizar cliente: ' + (e && e.message ? e.message : 'desconhecido'), 'danger', 4000);
    }
  });
</script>
</body>
</html>
