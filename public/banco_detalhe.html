<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <title>Detalhe do Banco - Kwanzas Metal</title>
  <link rel="shortcut icon" type="image/x-icon" href="assets/img/logo.png">
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/fontawesome.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="assets/css/feathericon.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <!-- DataTables Bootstrap 4 CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
  <!-- SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap4.min.css">
  <style>
    /* ===== MODERN PROFESSIONAL DASHBOARD STYLES ===== */
    
    /* Root Variables for Consistent Theming */
    :root {
      --primary-color: #2c3e50;
      --primary-dark: #1a252f;
      --primary-light: #34495e;
      --accent-color: #0fd7d4;
      --accent-dark: #0ab5b3;
      --secondary-color: #95a5a6;
      --dark-bg: #000000;
      --darker-bg: #000000;
      --light-bg: #f8f9fa;
      --card-bg: #ffffff;
      --text-primary: #2c3e50;
      --text-secondary: #7f8c8d;
      --border-color: #dee2e6;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 40px rgba(0,0,0,0.15);
      --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Global Styles */
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }

    /* Header Enhancements */
    .header {
      background: var(--card-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border-bottom: 1px solid var(--border-color);
    }

    .header-left {
      background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%) !important;
    }

    /* Sidebar Professional Styling - Black with Cyan */
    .sidebar {
      background: #000000 !important;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
    }

    .sidebar .sidebar-menu ul li a {
      color: #ffffff !important;
      opacity: 0.85;
      transition: var(--transition-fast);
      padding: 10px 16px;
      border-radius: 8px;
      margin: 2px 8px;
    }

    .sidebar .sidebar-menu ul li a:hover {
      color: #ffffff !important;
      opacity: 1;
      background: rgba(15, 215, 212, 0.1);
      transform: translateX(5px);
    }

    .sidebar .sidebar-menu ul li.active > a {
      color: #ffffff !important;
      font-weight: 600;
      background: rgba(15, 215, 212, 0.2);
      border-left: 3px solid #0fd7d4;
    }

    .sidebar .submenu_class li a {
      color: #f2f9ff !important;
      opacity: 0.8;
      font-size: 13px;
    }

    .sidebar .submenu_class li a:hover {
      color: #0fd7d4 !important;
      opacity: 1;
    }

    /* Sidebar submenu layout mais corporativo */
    .sidebar .sidebar-menu > ul > li > a {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .sidebar .sidebar-menu > ul > li > a i {
      margin-right: 6px;
      font-size: 15px;
      color: #ffffff !important;
    }

    .sidebar .sidebar-menu .menu-arrow {
      margin-left: auto;
      transition: transform 0.2s ease;
    }

    .sidebar .submenu.active > a .menu-arrow {
      transform: rotate(90deg);
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--light-bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-secondary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-color);
    }

    /* Ensure the delete button is visible and clickable */
    .btn-remover {
      cursor: pointer;
    }
    .btn-remover:hover {
      color: #fff !important;
    }
    
    .bank-logo{ width: 96px; height: 96px; object-fit: contain; border-radius: 8px; border: 1px solid #e9ecef; background: #fff; }
    .detail-card{ border: 1px solid #e9ecef; border-radius: 8px; }
    .alerts-container{ position: fixed; top: 70px; right: 16px; z-index: 1080; width: 320px; }
    .extrato-header{ border-bottom: 1px solid #e9ecef; padding-bottom: .5rem; margin-bottom: 1rem; }
    .saldo-label{ font-size: 0.85rem; text-transform: uppercase; letter-spacing: .04em; opacity: .7; margin-right: .25rem; }
    .saldo-badge{ font-size: 0.9rem; font-weight: 600; }
    /* Tabela Extrato: reduzir tamanho da fonte nas colunas */
    #tabelaExtrato thead th,
    #tabelaExtrato tbody td { font-size: 12px; padding: .35rem .5rem; }
    .dataTables_wrapper .dataTables_paginate,
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info { font-size: 12px; }
    .table thead th { white-space: nowrap; }
  </style>
  <script>
    const API = {
      headers(){
        const t = localStorage.getItem('token');
        return { 'Content-Type': 'application/json', ...(t ? { Authorization: `Bearer ${t}` } : {}) };
      },
      async getJSON(path){
        const res = await fetch(path, { headers: this.headers() });
        if(!res.ok) throw new Error('http_' + res.status);
        return res.json();
      },
      async putJSON(path, data) {
        const res = await fetch(path, {
          method: 'PUT',
          headers: this.headers(),
          body: JSON.stringify(data)
        });
        if (!res.ok) {
          const error = await res.text().catch(() => 'Erro desconhecido');
          console.error('Erro na requisição PUT:', error);
          throw new Error(`Erro HTTP ${res.status}: ${error}`);
        }
        try {
          return await res.json();
        } catch (e) {
          return null; // Algumas respostas PUT podem não ter corpo
        }
      }
    };

    function showAlert(message, variant = 'info', timeout = 3000){
      const container = document.getElementById('alertsContainer') || (()=>{ const c=document.createElement('div'); c.id='alertsContainer'; c.className='alerts-container'; document.body.appendChild(c); return c; })();
      const id = 'al_'+Date.now()+Math.random().toString(16).slice(2);
      const el = document.createElement('div'); el.id = id; el.className = `alert alert-${variant} alert-dismissible fade show mb-2`; el.role = 'alert';
      el.innerHTML = `<div>${message}</div><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>`;
      container.appendChild(el);
      if(timeout){ setTimeout(()=>{ try{ $(el).alert('close'); }catch{} el.remove(); }, timeout); }
    }

    function getQueryParam(key){ return new URLSearchParams(window.location.search).get(key); }

    function formatStatus(s){
      const v = (s || '').toLowerCase();
      if(v === 'ativo' || v === 'active') return '<span class="badge badge-success">Ativo</span>';
      if(v === 'inativo' || v === 'inactive') return '<span class="badge badge-secondary">Inativo</span>';
      return `<span class="badge badge-light">${s || '—'}</span>`;
    }

    async function carregarDetalhe(){
      const id = getQueryParam('id');
      if(!id){ showAlert('ID do banco não informado', 'warning', 5000); return; }
      try{
        const b = await API.getJSON(`/api/financas/bancos/${encodeURIComponent(id)}`);
        document.getElementById('bankName').textContent = b.banco || `Banco #${id}`;
        document.getElementById('bankId').textContent = `ID: ${b.id ?? id}`;
        // Finança Banco não possui status/descricao no modelo; mostramos info básica
        document.getElementById('bankStatus').innerHTML = '<span class="badge badge-light">—</span>';
        const descParts = [b.agencia && `Agência: ${b.agencia}`, b.conta && `Conta: ${b.conta}`, b.iban && `IBAN: ${b.iban}`].filter(Boolean);
        document.getElementById('bankDesc').textContent = descParts.join(' | ') || '—';
        const logo = document.getElementById('bankLogo');
        logo.src = (b.logo && String(b.logo).trim()) ? b.logo : 'assets/img/bank.png';
        logo.alt = b.banco || `Banco #${id}`;
        // Saldo inicial vindo do mesmo endpoint usado em financas.html
        const saldoNum = (b.saldo != null) ? Number(parseFloat(b.saldo)) : NaN;
        if (!isNaN(saldoNum)) {
          window.__saldoBanco = saldoNum;
          // Atualiza badge imediatamente se já existir no DOM
          try{
            const el = document.getElementById('saldoAtual');
            if (el) {
              const fmt = new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'AOA' }).format(saldoNum);
              el.textContent = 'Saldo: ' + fmt;
            }
          }catch{}
          // Notifica listeners (DataTable script) e re-notifica em tick seguinte para evitar race
          try{
            const ev = new CustomEvent('banco:saldo', { detail: window.__saldoBanco });
            window.dispatchEvent(ev);
            setTimeout(() => { try{ window.dispatchEvent(ev); }catch{} }, 0);
          }catch{}
        }
      }catch(e){
        showAlert('Não foi possível carregar o banco', 'danger', 6000);
      }
    }

    async function excluirBanco() {
      if (!confirm('Tem certeza que deseja excluir este banco? Esta ação não pode ser desfeita.')) {
        return;
      }

      const id = getQueryParam('id');
      if (!id) {
        showAlert('ID do banco não encontrado', 'danger');
        return;
      }

      try {
        const response = await fetch(`/api/financas/bancos/${encodeURIComponent(id)}`, {
          method: 'DELETE',
          headers: API.headers()
        });

        if (!response.ok) {
          throw new Error('Falha ao excluir o banco');
        }

        showAlert('Banco excluído com sucesso!', 'success');
        setTimeout(() => {
          window.location.href = 'financas.html';
        }, 1500);
      } catch (error) {
        console.error('Erro ao excluir banco:', error);
        showAlert('Erro ao excluir o banco: ' + (error.message || 'Erro desconhecido'), 'danger');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      carregarDetalhe();
      document.getElementById('btnExcluirBanco').addEventListener('click', excluirBanco);
    });
  </script>
</head>
<body>
  <div class="main-wrapper">
    <div class="header">
			<div class="header-left">
				<a href="dashboard.html" class="logo"> <img src="assets/img/kwanzaWhite.svg" width="50" height="70" alt="logo"> <span class="logoclass"></span> </a>
				<a href="dashboard.html" class="logo logo-small"> <img src="assets/img/kwanzaWhite.svg" alt="Logo" width="30" height="30"> </a>
			</div>
			<a href="javascript:void(0);" id="toggle_btn"> <i class="fe fe-text-align-left"></i> </a>
			<a class="mobile_btn" id="mobile_btn"> <i class="fas fa-bars"></i> </a>
			<ul class="nav user-menu">
				<li class="nav-item dropdown has-arrow">
					<a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown"> <span class="user-img"><img class="rounded-circle" src="assets/img/profiles/avatar-01.jpg" width="31" alt=""></span> </a>
					<div class="dropdown-menu">
						<div class="user-header">
							<div class="avatar avatar-sm"> <img src="foto do perfil" alt="User Image" class="avatar-img rounded-circle"> </div>
							<div class="user-text">
								<div class="muted" style="font-size:11px">Bem-vindo(a), </div>
								<h6><span id="userName">usuário</span></h6>
							</div>
						</div> <a class="dropdown-item" href="profile.html">Perfil</a> <a class="dropdown-item" href="settings.html">configurações da conta</a> <a class="dropdown-item" id="logoutBtn" href="#">Sair</a> </div>
				</li>
			</ul>
			<div class="top-nav-search">
				<form>
					<input type="text" class="form-control" placeholder="procurar">
					<button class="btn" type="submit"><i class="fas fa-search"></i></button>
				</form>
			</div>
		</div>
		<div class="sidebar" id="sidebar">
			<div class="sidebar-inner slimscroll">
				<div id="sidebar-menu" class="sidebar-menu">
					<ul>
						<li class="active"> <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a> </li>
						<li> <a href="clientes_clientes.html"><i class="fas fa-user"></i> <span>Clientes</span></a></li>
						<li class="submenu"> <a href="#" data-toggle="collapse"><i class="fas fa-user"></i> <span> Empresa </span> <span class="menu-arrow"></span></a>
							<ul class="submenu_class" style="display: none;">
								<li><a href="rh_funcionarios.html">Funcionários</a></li>
								<li><a href="rh_departamentos.html">Departamentos & Cargos</a></li>
								<li><a href="rh_ferias.html">Férias</a></li>
								<li><a href="users.html">Utilizadores</a></li>
							</ul>
						</li>
						
						<li class="submenu"> <a href="#" data-toggle="collapse"><i class="fas fa-user"></i> <span> Fornecedores</span> <span class="menu-arrow"></span></a>
							<ul class="submenu_class" style="display: none;">
								<li><a href="fornecedor.html">Lista de Fornecedores </a></li>
							</ul>
						</li>
						<li class="active"> <a href="financas.html#bancos"><i class="fas fa-university"></i> <span> Bancos</span></a> </li>
						<li> <a href="financas.html#pagamentos"><i class="fas fa-money-bill-alt"></i> <span> Pagamentos</span></a> </li>
            <li> <a href="faturas.html"><i class="fas fa-file-invoice"></i> <span>Faturas</span></a> </li>
						<li> <a href="projectos.html"><i class="fas fa-cube"></i> <span>Projectos Kwanza </span></a> </li>
					</ul>
				</div>
			</div>
		</div>

    <div class="page-wrapper">
      <div class="content container-fluid">
        <div id="alertsContainer" class="alerts-container"></div>
        <div class="page-header">
          <div class="row">
            <div class="col-sm-12 mt-5 d-flex align-items-center justify-content-between">
              <div>
                <h1 id="bankName">Banco</h1>
                <p class="text-muted mb-0"><span id="bankId">ID: —</span></p>
              </div>
              <div class="d-flex">
                <a href="financas.html#bancos" class="btn btn-outline-secondary mr-2"><i class="fas fa-arrow-left mr-1"></i>Voltar a Bancos</a>
                <button class="btn btn-danger" id="btnExcluirBanco"><i class="fas fa-trash-alt mr-1"></i>Excluir Banco</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card detail-card">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <img id="bankLogo" class="bank-logo mr-3" src="assets/img/bank.png" alt="logo">
              <div>
                <div id="bankStatus"></div>
              </div>
            </div>
            <div>
              <label class="text-muted d-block">Descrição</label>
              <div id="bankDesc">—</div>
            </div>
          </div>
        </div>

        <!-- Cards de Resumo -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card bg-light">
              <div class="card-body p-3">
                <h6 class="card-title text-muted mb-1">Saldo Cadastrado</h6>
                <h4 id="saldoCadastrado" class="mb-0">Kz 0,00</h4>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card bg-light">
              <div class="card-body p-3">
                <h6 class="card-title text-muted mb-1">Total de Débitos</h6>
                <h4 id="totalDebitos" class="mb-0 text-warning">Kz 0,00</h4>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card bg-light">
              <div class="card-body p-3">
                <h6 class="card-title text-muted mb-1">Saldo Disponível</h6>
                <h4 id="saldoAtual" class="mb-0">Kz 0,00</h4>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabela de Extrato Bancário -->
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title m-0">Extrato Bancário</h5>
              <div class="btn-group" role="group">
                <input type="file" id="inputImportExtrato" style="display:none" />
                <button class="btn btn-outline-secondary" id="btnImportarExtrato" type="button">
                  <i class="fas fa-file-import mr-1"></i>Importar
                </button>
                <button class="btn btn-outline-secondary" id="btnExportarExtrato" type="button">
                  <i class="fas fa-file-export mr-1"></i>Exportar dados
                </button>
                <button class="btn btn-outline-danger" id="btnEliminarExtrato" type="button">
                  <i class="fas fa-trash-alt mr-1"></i>Eliminar Todos
                </button>
                <button class="btn btn-primary" data-toggle="modal" data-target="#modalLancamento">
                  <i class="fas fa-plus mr-1"></i>Adicionar
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover mb-0 nowrap" style="width:100%" id="tabelaExtrato">
                <thead class="thead-light">
                  <tr>
                    <th>data-mov</th>
                    <th>n-op</th>
                    <th>data-val</th>
                    <th>descr.</th>
                    <th>des-primavera</th>
                    <th>class.</th>
                    <th>débito</th>
                    <th>crédito</th>
                    <th style="display:none">ID</th>
                    <th width="100">ações</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Modal: Adicionar Lançamento -->
        <div class="modal fade" id="modalLancamento" tabindex="-1" role="dialog" aria-labelledby="modalLancamentoLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
              <form id="formLancamento">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalLancamentoLabel">Adicionar Lançamento</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="form-row">
                    <div class="form-group col-md-3">
                      <label for="inpData">Data</label>
                      <input type="date" class="form-control" id="inpData" required>
                    </div>
                    <div class="form-group col-md-3">
                      <label for="inpOperacao">Nº Operação</label>
                      <input type="text" class="form-control" id="inpOperacao" placeholder="Ex: 0001">
                    </div>
                    <div class="form-group col-md-3">
                      <label for="inpFactura">Factura</label>
                      <input type="text" class="form-control" id="inpFactura" placeholder="Ex: F123" list="listaFaturas" data-fatura-id="">
                      <datalist id="listaFaturas"></datalist>
                      <input type="hidden" id="inpFaturaId">
                    </div>
                    <div class="form-group col-md-3">
                      <label for="inpClassificacao">Classificação</label>
                      <input type="text" class="form-control" id="inpClassificacao" placeholder="Ex: Transferência">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="inpDescExtrato">Descritivo Extrato Bancário</label>
                      <input type="text" class="form-control" id="inpDescExtrato" placeholder="Descrição do banco">
                    </div>
                    <div class="form-group col-md-6">
                      <label for="inpDescPrimavera">Descritivo Primavera</label>
                      <input type="text" class="form-control" id="inpDescPrimavera" placeholder="Descrição Primavera">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-md-4">
                      <label for="inpStatus">Conciliado / Pendente</label>
                      <select class="form-control" id="inpStatus">
                        <option value="Conciliado">Conciliado</option>
                        <option value="Pendente">Pendente</option>
                      </select>
                    </div>
                    <div class="form-group col-md-4">
                      <label for="inpSaidas">Saídas</label>
                      <input type="number" step="0.01" min="0" class="form-control" id="inpSaidas" placeholder="0,00">
                    </div>
                    <div class="form-group col-md-4">
                      <label for="inpEntradas">Entradas</label>
                      <input type="number" step="0.01" min="0" class="form-control" id="inpEntradas" placeholder="0,00">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="inpObs">Observação</label>
                    <textarea class="form-control" id="inpObs" rows="2" placeholder="Observações (opcional)"></textarea>
                  </div>
                  <small class="text-muted d-block">O saldo será calculado automaticamente: saldo anterior - saídas + entradas.</small>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/jquery-3.5.1.min.js"></script>
  <script src="assets/js/popper.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap4.min.js"></script>
  <!-- DataTables Buttons (Excel/PDF) -->
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <!-- SheetJS para leitura de Excel/CSV no browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-slimScroll/1.3.8/jquery.slimscroll.min.js"></script>
  <script src="assets/js/script.js"></script>
  <!-- Carrega o avatar do usuário -->
  <script src="js/profile-avatar.js"></script>
  <!-- SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <script>
    $(function(){
      const bancoId = getQueryParam('id');
      let editingRowIndex = null;
      let editingLancId = null;
      let faturasNaoPagas = [];
      let faturasTodas = [];
      const fmtDateDisplay = (d) => {
        if (!d) return '';
        const s = String(d);
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
          const [y,m,day] = s.split('-');
          return `${day}/${m}/${y}`;
        }
        return s;
      };

      // Mapa auxiliar número/id -> fatura completa
      const mapaFaturas = {};

      // Atualiza o ID da fatura quando o usuário seleciona uma opção do datalist
      function atualizarIdFaturaSelecionada() {
        const numFatura = ($('#inpFactura').val() || '').toString().trim();
        const fatura = faturasNaoPagas.find(f => (f.num_factura || '').toString().trim() === numFatura);
        if (fatura) {
          $('#inpFaturaId').val(fatura.id);
          // Se houver dívida, podemos preencher automaticamente o valor de saída
          if (fatura.divida > 0) {
            $('#inpSaidas').val(fatura.divida);
          }
        } else {
          $('#inpFaturaId').val('');
        }
      }

      // Monitora mudanças no campo de fatura
      $(document).on('input', '#inpFactura', function() {
        // Limpa o ID se o usuário apagar ou modificar manualmente
        if ($(this).val() === '') {
          $('#inpFaturaId').val('');
        } else {
          // Aguarda um momento para o datalist ser preenchido
          setTimeout(atualizarIdFaturaSelecionada, 100);
        }
      });

      // Preencher classificação automaticamente ao digitar os descritivos (não sobrescreve se já existir)
      $(document).on('input', '#inpDescExtrato, #inpDescPrimavera', function(){
        const atual = ($('#inpClassificacao').val() || '').trim();
        if (atual) return;
        const cls = inferClassificacao($('#inpDescExtrato').val(), $('#inpDescPrimavera').val());
        if (cls) $('#inpClassificacao').val(cls);
      });

      async function carregarFaturasNaoPagas(){
        try{
          const res = await API.getJSON('/api/fornecedores');
          const items = Array.isArray(res) ? res : (res && res.items) ? res.items : [];
          // Guarda todas as faturas para poder localizar por id/numero depois
          faturasTodas = items;

          const filtradas = items.filter(it => {
            const num = (it.num_factura || '').toString().trim();
            if (!num) return false;
            const sit = (it.situacao || '').toString().trim().toUpperCase();
            const dividaNum = it.divida != null ? Number(it.divida) : null;
            if (sit === 'PAGO' || sit === 'PAGA' || (dividaNum !== null && dividaNum === 0)) return false;
            return true;
          });
          
          // Atualiza o mapa de faturas para acesso rápido
          faturasNaoPagas = filtradas;
          const dl = document.getElementById('listaFaturas');
          if (!dl) return;
          
          dl.innerHTML = '';
          filtradas.forEach(it => {
            const opt = document.createElement('option');
            opt.value = it.num_factura || '';
            opt.setAttribute('data-fatura-id', it.id || '');
            const partes = [];
            if (it.nome) partes.push(it.nome);
            if (it.divida != null) partes.push('dívida: ' + it.divida);
            opt.textContent = partes.join(' · ');
            dl.appendChild(opt);
            
            // Adiciona ao mapa para busca rápida
            if (it.num_factura) {
              mapaFaturas[it.num_factura] = it;
            }
          });

          // Mapa inclui TODAS as faturas (não só as não pagas)
          Object.keys(mapaFaturas).forEach(k => delete mapaFaturas[k]);
          items.forEach(it => {
            const num = (it.num_factura || '').toString().trim();
            if (num) mapaFaturas['num:' + num] = it;
            if (it.id != null) mapaFaturas['id:' + String(it.id)] = it;
          });
        }catch(e){
          console.error('Erro ao carregar faturas não pagas para o datalist', e);
        }
      }
      const toInputDate = (d) => {
        if (!d) return '';
        const s = String(d).trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; // já está no formato do input
        // tenta converter de dd/mm/aaaa para aaaa-mm-dd
        const m = s.match(/^(\d{2})[\/](\d{2})[\/](\d{4})$/);
        if (m) return `${m[3]}-${m[2]}-${m[1]}`;
        return '';
      };

      // Inicializa a DataTable com novo layout de colunas
      const dt = $('#tabelaExtrato').DataTable({
        responsive: true,
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-PT.json'
        },
        // Configuração das colunas para trabalhar com array de dados
        columnDefs: [
          { targets: 0, data: 0, title: 'data-mov' },
          { targets: 1, data: 1, title: 'n-op' },
          { targets: 2, data: 2, title: 'data-val' },
          { targets: 3, data: 3, title: 'descr.' },
          { targets: 4, data: 4, title: 'des-primavera' },
          { targets: 5, data: 5, title: 'class.' },
          { targets: 6, data: 6, title: 'débito' },
          { targets: 7, data: 7, title: 'crédito' },
          { targets: 8, visible: false, searchable: false },
          { 
            targets: 9, 
            title: 'ações',
            data: null,
            render: function(data, type, row, meta) {
              const lancId = row[8] != null ? row[8] : '';
              return `
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-outline-primary btn-editar-lanc" 
                          data-lanc-id="${lancId}" title="Editar registro">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button type="button" class="btn btn-outline-danger btn-remover" 
                          data-lanc-id="${lancId}" title="Excluir registro">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>`;
            },
            orderable: false,
            searchable: false
          }
        ],
        // Ordena por DATA MOVIMENTO (coluna 0) em ordem ascendente, para que a última transação fique por último
        order: [[0, 'asc']],
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        dom: 'Bfrtip',
        buttons: [
          {
            extend: 'excelHtml5',
            text: 'Exportar XLSX',
            title: 'Extrato Bancário',
            exportOptions: {
              columns: ':visible'
            }
          },
          {
            extend: 'pdfHtml5',
            text: 'Exportar PDF',
            title: 'Extrato Bancário',
            orientation: 'landscape',
            pageSize: 'A4',
            exportOptions: {
              columns: ':visible'
            }
          }
        ]
      });

      // Converte valores de texto para número, suportando formato pt-PT (ex: "-170.600,00")
      const toNum = (v) => {
        if (v === null || v === undefined || v === '') return 0;
        let s = String(v).trim();
        if (!s) return 0;

        // Remove espaços
        s = s.replace(/\s+/g, '');

        // Se tiver vírgula, tratamos como formato europeu: ponto = milhar, vírgula = decimal
        if (s.includes(',')) {
          const isNeg = s.startsWith('-');
          // Remove tudo que não seja dígito, ponto ou vírgula
          s = s.replace(/[^0-9.,]/g, '');
          // Remove pontos (separadores de milhar)
          s = s.replace(/\./g, '');
          // Troca vírgula por ponto (decimal)
          s = s.replace(',', '.');
          if (isNeg && !s.startsWith('-')) s = '-' + s;
        } else {
          // Formato já em estilo "inglês" (ponto decimal). Mantém sinal e ponto.
          s = s.replace(/[^0-9.-]/g, '');
        }

        const n = Number(s);
        return isFinite(n) ? n : 0;
      };
      
      // Formata como moeda Kz com 2 casas decimais (simples e estável)
      const fmtKZ = (v) => {
        const num = typeof v === 'number' ? v : toNum(v);
        return new Intl.NumberFormat('pt-PT', {
          style: 'currency',
          currency: 'AOA',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(num);
      };

      // Inferência simples de classificação a partir dos descritivos (extrato/primavera)
      const inferClassificacao = (descExtrato, descPrimavera) => {
        const s = String((descPrimavera && String(descPrimavera).trim()) || (descExtrato || ''))
          .toLowerCase();
        if (!s) return '';
        if (/(transf|transfer|mb|ted|pix|ordem|opera[cç][aã]o)/.test(s)) return 'Transferência';
        if (/(pagamento|fatura|factura|fornecedor|boleto|liquida[cç][aã]o)/.test(s)) return 'Pagamento';
        if (/(taxa|tarifa|comiss|manuten|servi[cç]o)/.test(s)) return 'Tarifas';
        if (/(juros|rend|aplic|invest)/.test(s)) return 'Juros';
        if (/(imposto|iva|irs|irt|selo)/.test(s)) return 'Impostos';
        if (/(dep[oó]s|entrada|cr[eé]dito|receb)/.test(s)) return 'Entrada';
        if (/(sa[ií]da|d[eé]bito|pagto|levant|saque)/.test(s)) return 'Saída';
        if (/(sal[aá]rio|folha|remun|honor[aá]rio)/.test(s)) return 'Pessoal';
        return '';
      };

      // Saldo atual em memória (independente de ordenação da tabela)
      let saldoAtualNum = 0;      // usado para cálculos internos
      // Quando vazio, o badge usa o valor numérico (saldo do banco)
      let saldoAtualTexto = '';   // usado para exibir exatamente como na tabela
      const updateSaldoBadge = () => {
        const elSaldoAtual = document.getElementById('saldoAtual');
        const elSaldoCadastrado = document.getElementById('saldoCadastrado');
        
        if (!elSaldoAtual || !elSaldoCadastrado) return;
        
        const saldo = saldoAtualNum;
        const saldoCadastrado = (typeof window.__saldoBanco === 'number') ? Number(window.__saldoBanco) : 0;
        const isNegativo = saldo < 0;
        
        // Atualiza o saldo cadastrado
        elSaldoCadastrado.textContent = `Kz ${Math.abs(saldoCadastrado).toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        
        // Atualiza o saldo atual com formatação condicional
        elSaldoAtual.className = isNegativo ? 'mb-0 text-danger' : 'mb-0 text-success';
        elSaldoAtual.textContent = `Kz ${Math.abs(saldo).toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}${isNegativo ? ' -' : ''}`;
      };
      // Inicializa saldo: prioriza o valor vindo do backend (window.__saldoBanco)
      // Somente se NÃO houver saldo vindo da API é que tentamos inferir pela última linha.
      try{
        if (typeof window.__saldoBanco === 'number'){
          saldoAtualNum = Number(window.__saldoBanco);
          // força uso do valor numérico (saldo cadastrado) no badge inicial
          saldoAtualTexto = '';
        }
      }catch(e){}
      const syncSaldoFromLastRow = () => {
        // Mantém função por compatibilidade, mas delega para a regra única de recálculo
        try {
          recarregarSaldos();
        } catch (e) {}
      };
      updateSaldoBadge();

      // Carrega lançamentos de extrato a partir da API (quando existir backend configurado)
        async function carregarExtratoInicial(){
        if(!bancoId) return;
        try{
          const itens = await API.getJSON(`/api/financas/bancos/${encodeURIComponent(bancoId)}/extrato`);
          if(!Array.isArray(itens)) return;
          itens.forEach((lanc) => {
            const dataMovText   = (lanc.dataTexto      != null && lanc.dataTexto      !== '') ? String(lanc.dataTexto)      : (lanc.data      != null ? String(lanc.data)      : '');
            const dataValorText = (lanc.dataValorTexto != null && lanc.dataValorTexto !== '') ? String(lanc.dataValorTexto) : (lanc.dataValor != null ? String(lanc.dataValor) : dataMovText);
            const saidasText  = (lanc.saidasTexto   != null && lanc.saidasTexto   !== '') ? String(lanc.saidasTexto)   : (lanc.saidas   != null ? String(lanc.saidas)   : '');
            const entradasText= (lanc.entradasTexto != null && lanc.entradasTexto !== '') ? String(lanc.entradasTexto) : (lanc.entradas != null ? String(lanc.entradas) : '');
            const row = [
              dataMovText,                            // DATA MOVIMENTO
              lanc.numeroOperacao || '',              // N. OPERAÇÃO
              dataValorText,                          // DATA VALOR
              lanc.descExtrato || '',                 // DESCRITIVO
              lanc.descPrimavera || '',               // DESCRITIVO PRIMAVERA
              lanc.classificacao || '',               // CLASSIFICAÇÃO
              saidasText,                             // DÉBITO Kz
              entradasText,                           // CRÉDITO Kz
              lanc.id || null                         // ID (oculta)
            ];
            dt.row.add(row);
          });
          dt.draw(false);
          // Recalcula saldos com a mesma regra utilizada após importação
          recarregarSaldos();
        }catch(err){
          console.error('Erro ao carregar extrato bancário pela API:', err);
        }
      }

      // Helper: anteriormente adicionava linha "Saldo Inicial"; agora não faz nada (tabela começa vazia)
      const ensureSaldoInicialRow = () => {
        return;
      };

      // Ouve evento com saldo vindo do detalhe do banco (API)
      // Se já existir extrato carregado na tabela, o saldo passa a ser SEMPRE
      // o da última linha do extrato, ignorando o valor do evento.
      try{
        window.addEventListener('banco:saldo', (ev) => {
          const rowsCount = dt.rows().count();
          if (rowsCount > 0) {
            // Já temos extrato: recarrega saldos usando a mesma lógica global
            recarregarSaldos();
          } else {
            // Sem extrato ainda: pode usar o saldo vindo do backend
            const v = Number(ev && ev.detail);
            if(!isNaN(v)){
              saldoAtualNum = v;
              // garante que o badge mostre o saldo cadastrado, não "0"
              saldoAtualTexto = '';
              updateSaldoBadge();
            }
          }
        });
      }catch{}

      // Caso o saldo já esteja presente antes do listener (carregou muito rápido), apenas atualiza badge
      updateSaldoBadge();

      // Função para marcar a fatura como paga (usa mesma regra de cálculo de faturas.html)
      async function marcarFaturaComoPaga(faturaId, valorPago) {
        if (!faturaId) {
          console.error('ID da fatura não fornecido');
          return false;
        }

        try {
          const chaveId = 'id:' + String(faturaId);
          const f = mapaFaturas[chaveId];
          if (!f) {
            console.error('Fatura não encontrada em mapaFaturas para id', faturaId);
            return false;
          }

          const total = f.valor_documento != null ? Number(f.valor_documento) : 0;
          const pagoAtual = f.valor_pago != null ? Number(f.valor_pago) : 0;
          const valor = Number(valorPago || 0);
          const novoPago = pagoAtual + valor;
          const novaDivida = Math.max(total - novoPago, 0);
          const situacao = novaDivida === 0 ? 'PAGA' : 'PARCIAL';
          const hoje = new Date().toISOString().slice(0, 10);

          const payload = {
            valor_pago: novoPago,
            divida: novaDivida,
            situacao,
            data_pagamento: hoje,
            pago_via: f.pago_via || f.banco || undefined
          };

          console.log('Atualizando fatura via extrato:', faturaId, payload);

          await API.putJSON(`/api/fornecedores/${encodeURIComponent(faturaId)}`, payload);
          return true;
        } catch (erro) {
          console.error('Erro ao atualizar fatura a partir do extrato:', erro);
          return false;
        }
      }

      // Manipulador do formulário de lançamento
      $('#formLancamento').on('submit', async function(e) {
        e.preventDefault();
        
        try {
          const data = {
            data: $('#inpData').val(),
            numeroOperacao: $('#inpOperacao').val(),
            descExtrato: $('#inpDescExtrato').val(),
            descPrimavera: $('#inpDescPrimavera').val(),
            classificacao: $('#inpClassificacao').val(),
            status: $('#inpStatus').val(),
            factura: $('#inpFactura').val(),
            faturaId: $('#inpFaturaId').val(),
            saidas: $('#inpSaidas').val() ? parseFloat($('#inpSaidas').val().replace(',', '.')) : 0,
            entradas: $('#inpEntradas').val() ? parseFloat($('#inpEntradas').val().replace(',', '.')) : 0,
            observacao: $('#inpObs').val()
          };
          
          // Se estiver marcado como Conciliado e houver uma fatura associada, marca como paga
          if (data.status === 'Conciliado' && data.faturaId) {
            const valorPago = data.saidas > 0 ? data.saidas : data.entradas;
            const sucesso = await marcarFaturaComoPaga(data.faturaId, valorPago);
            
            if (!sucesso) {
              Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: 'Não foi possível atualizar o status da fatura. Verifique os dados e tente novamente.'
              });
              return;
            }
            
            // Atualiza a lista de faturas não pagas
            await carregarFaturasNaoPagas();
          }
          
          // Lógica para salvar/atualizar o lançamento
          const saidas = data.saidas;
          const entradas = data.entradas;
          const saldo = saldoAtualNum - saidas + entradas;
          
          const payload = {
            data: data.data,
            numeroOperacao: data.numeroOperacao,
            descExtrato: data.descExtrato,
            descPrimavera: data.descPrimavera,
            classificacao: data.classificacao,
            status: data.status,
            factura: data.factura,
            faturaId: data.faturaId,
            saidas: saidas,
            entradas: entradas,
            observacao: data.observacao
          };
          
          let lanc;
          const url = `/api/financas/bancos/${bancoId}/extrato`;
          let method = 'POST';
          
          try {
            if (editingLancId) {
              method = 'PUT';
              const resp = await fetch(`${url}/${editingLancId}`, {
                method,
                headers: API.headers(),
                body: JSON.stringify(payload)
              });
              if (!resp.ok) {
                const t = await resp.text().catch(() => '');
                throw new Error(`HTTP ${resp.status} ${resp.statusText} - atualizar lançamento${t ? `: ${t}` : ''}`);
              }
              try { lanc = await resp.json(); } catch { lanc = null; }
            } else {
              const resp = await fetch(url, {
                method,
                headers: API.headers(),
                body: JSON.stringify(payload)
              });
              if (!resp.ok) {
                const t = await resp.text().catch(() => '');
                throw new Error(`HTTP ${resp.status} ${resp.statusText} - criar lançamento${t ? `: ${t}` : ''}`);
              }
              try { lanc = await resp.json(); } catch { lanc = null; }
            }
            
            // Atualiza a interface após salvar
            if (lanc) {
              // Atualiza a tabela
              if (editingRowIndex !== null) {
                // Atualiza linha existente (9 campos de dados + ID oculto no índice 8)
                dt.row(editingRowIndex).data([
                  fmtDateDisplay(lanc.data || lanc.dataTexto),
                  lanc.numeroOperacao || '',
                  fmtDateDisplay(lanc.dataValor || lanc.dataValorTexto || (lanc.data || lanc.dataTexto)),
                  lanc.descExtrato || '',
                  lanc.descPrimavera || '',
                  lanc.classificacao || '',
                  (lanc.saidasTexto != null && lanc.saidasTexto !== '') ? String(lanc.saidasTexto) : fmtKZ(lanc.saidas || 0),
                  (lanc.entradasTexto != null && lanc.entradasTexto !== '') ? String(lanc.entradasTexto) : fmtKZ(lanc.entradas || 0),
                  lanc.id || null
                ]).draw(false);
              } else {
                // Adiciona nova linha (9 campos de dados + ID oculto no índice 8)
                const rowNode = dt.row.add([
                  fmtDateDisplay(lanc.data || lanc.dataTexto),
                  lanc.numeroOperacao || '',
                  fmtDateDisplay(lanc.dataValor || lanc.dataValorTexto || (lanc.data || lanc.dataTexto)),
                  lanc.descExtrato || '',
                  lanc.descPrimavera || '',
                  lanc.classificacao || '',
                  (lanc.saidasTexto != null && lanc.saidasTexto !== '') ? String(lanc.saidasTexto) : fmtKZ(lanc.saidas || 0),
                  (lanc.entradasTexto != null && lanc.entradasTexto !== '') ? String(lanc.entradasTexto) : fmtKZ(lanc.entradas || 0),
                  lanc.id || null
                ]).draw(false).node();
                
                // Adiciona classe para destacar a nova linha
                $(rowNode).addClass('highlight');
                setTimeout(() => {
                  $(rowNode).removeClass('highlight');
                }, 2000);
              }
              
              // Atualiza o saldo
              // Recalcula saldos de todas as linhas e atualiza o badge
              recarregarSaldos();
              
              // Fecha o modal
              $('#modalLancamento').modal('hide');
              
              // Mostra mensagem de sucesso
              Swal.fire({
                icon: 'success',
                title: 'Sucesso',
                text: `Lançamento ${editingLancId ? 'atualizado' : 'adicionado'} com sucesso!`,
                timer: 2000,
                showConfirmButton: false
              });
            }
            
          } catch (error) {
            console.error('Erro ao salvar lançamento:', error);
            Swal.fire({
              icon: 'error',
              title: 'Erro',
              text: (error && error.message) ? error.message : 'Ocorreu um erro ao salvar o lançamento. Por favor, tente novamente.'
            });
          }

        }catch(err){
          console.error('Erro ao adicionar/editar lançamento:', err);
          if (window.Swal) Swal.fire('Erro', 'Não foi possível guardar o lançamento.', 'error');
          else alert('Não foi possível guardar o lançamento.');
        }
      });

      // Importar CSV/XLSX para a tabela de extrato
      const processImportedRows = async (rows) => {
        if(!rows || !rows.length) return;
        try{
          let savedCount = 0;
          let totalCount = 0;
          for (const cols of rows) {
            const c = (idx) => (cols[idx] != null ? String(cols[idx]) : '');
            const dataMov = c(0);              // DATA MOVIMENTO (texto como no ficheiro)
            const dataValor = c(2) || dataMov; // DATA VALOR (ou igual à movimento)
            const saidasStr = c(4);            // DÉBITO (texto como no ficheiro)
            const entradasStr = c(5);          // CRÉDITO (texto como no ficheiro)
            const saldoColRaw = cols.length ? cols[cols.length - 1] : null; // texto saldo (não será usado para cálculo)
            const saldoStr = saldoColRaw != null ? String(saldoColRaw) : '';
            // Para a importação, apenas o DÉBITO deve afetar o saldo do banco.
            // Usamos o valor absoluto do débito (saídas) e ignoramos o crédito no cálculo (entradas = 0).
            const saidasVal = Math.abs(toNum(saidasStr));
            const entradasVal = 0;

            // Tenta persistir na BD, se tivermos ID de banco
            let lanc = null;
            if (bancoId) {
              try{
                const payload = {
                  ordem: dt.rows().count() + 1,
                  data: dataMov,
                  dataTexto: dataMov,
                  dataValorTexto: dataValor,
                  numeroOperacao: c(1),
                  descExtrato: c(3),
                  descPrimavera: '',
                  classificacao: '',
                  status: '',
                  factura: '',
                  saidas: saidasVal,
                  entradas: entradasVal,
                  // saldo será recalculado no frontend a partir do saldo do banco
                  saldo: null,
                  saidasTexto: saidasStr || null,
                  entradasTexto: entradasStr || null,
                  saldoTexto: null,
                  observacao: ''
                };
                const resp = await fetch(`/api/financas/bancos/${encodeURIComponent(bancoId)}/extrato`, {
                  method: 'POST',
                  headers: API.headers(),
                  body: JSON.stringify(payload)
                });
                if (resp.ok) {
                  lanc = await resp.json();
                  savedCount++;
                }
              }catch(errApi){
                console.error('Erro ao gravar lançamento importado na API:', errApi);
              }
            }

            const clsImp = inferClassificacao(c(3), '');
            const row = [
              dataMov,               // 0 DATA MOVIMENTO
              c(1),                  // 1 N. OPERAÇÃO
              dataValor,             // 2 DATA VALOR
              c(3),                  // 3 DESCRITIVO
              '',                    // 4 DESCRITIVO PRIMAVERA (import vazio)
              clsImp || '',          // 5 CLASSIFICAÇÃO (inferida se possível)
              saidasStr,             // 6 DÉBITO Kz
              entradasStr,           // 7 CRÉDITO Kz
              (lanc && lanc.id) ? lanc.id : null // 8 ID (oculta)
            ];
            dt.row.add(row);
            totalCount++;
          }
          dt.draw(false);
          // Recalcula saldos localmente com base no saldo cadastrado do banco e nos débitos importados
          // (não altera o saldo cadastrado na base de dados)
          recarregarSaldos();
          if (window.Swal){
            if (savedCount > 0){
              const msgExtra = (savedCount < totalCount)
                ? `Algumas linhas (${totalCount - savedCount}) não foram salvas no servidor (apenas na tela).`
                : '';
              Swal.fire('Sucesso', `Extrato importado. Linhas salvas na BD: ${savedCount}. ${msgExtra}`.trim(), 'success');
            } else {
              Swal.fire('Aviso', 'As linhas foram carregadas na tabela, mas nenhuma foi salva na base de dados. Verifique se a API de extrato está configurada.', 'warning');
            }
          }
        }catch(err){
          console.error('Erro ao processar linhas importadas:', err);
          if (window.Swal) Swal.fire('Erro', 'Não foi possível importar todas as linhas. Verifique o formato do ficheiro.', 'error');
          else alert('Não foi possível importar todas as linhas. Verifique o formato do ficheiro.');
        }
      };

      const handleFileImport = (file) => {
        if(!file) return;
        const reader = new FileReader();
        const isCSV = file.name.toLowerCase().endsWith('.csv');

        reader.onload = (e) => {
          try{
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            if(!json || json.length === 0){
              if (window.Swal) Swal.fire('Aviso', 'O ficheiro está vazio.', 'warning');
              else alert('O ficheiro está vazio.');
              return;
            }
            // Assume primeira linha como cabeçalho; dados iniciam na linha 2
            const rows = json.slice(1);
            processImportedRows(rows);
          }catch(err){
            console.error('Erro ao ler ficheiro:', err);
            if (window.Swal) Swal.fire('Erro', 'Não foi possível ler o ficheiro. Certifique-se que é CSV ou Excel válido.', 'error');
            else alert('Não foi possível ler o ficheiro. Certifique-se que é CSV ou Excel válido.');
          }
        };

        if(isCSV){
          reader.readAsArrayBuffer(file);
        }else{
          reader.readAsArrayBuffer(file);
        }
      };

      // Função para verificar se o XLSX está carregado
      function checkXLSXLoaded() {
        if (!window.XLSX) {
          console.error('XLSX library not loaded');
          return false;
        }
        return true;
      }

      // Tenta carregar o XLSX se não estiver disponível
      function ensureXLSX() {
        if (checkXLSXLoaded()) return Promise.resolve();
        
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
          script.onload = () => {
            console.log('XLSX library loaded successfully');
            if (window.XLSX) {
              resolve();
            } else {
              reject(new Error('XLSX library loaded but not available'));
            }
          };
          script.onerror = (err) => {
            console.error('Failed to load XLSX library:', err);
            reject(new Error('Failed to load XLSX library'));
          };
          document.head.appendChild(script);
        });
      }

      $('#btnImportarExtrato').on('click', async function(){
        console.log('Botão Importar clicado');
        try {
          // Limpa o input de arquivo
          const fileInput = $('#inputImportExtrato');
          fileInput.val('');
          
          console.log('Disparando evento de clique no input de arquivo...');
          
          // Tenta o método moderno primeiro
          if (fileInput[0].click) {
            console.log('Usando método moderno de clique');
            fileInput[0].click();
            return;
          }
          
          // Método alternativo para navegadores mais antigos
          console.log('Tentando método alternativo de clique');
          try {
            const clickEvent = document.createEvent('MouseEvents');
            clickEvent.initEvent('click', true, true);
            fileInput[0].dispatchEvent(clickEvent);
          } catch (e) {
            console.log('Método alternativo falhou, tentando o método antigo...');
            // Última tentativa com o método mais antigo
            fileInput.trigger('click');
          }
        } catch (err) {
          console.error('Erro ao abrir o seletor de arquivos:', err);
          const errorMsg = 'Não foi possível abrir o seletor de arquivos. ' + 
                         'Por favor, tente novamente ou use um navegador mais recente.';
                          
          if (window.Swal) {
            await Swal.fire({
              title: 'Erro',
              text: errorMsg,
              icon: 'error',
              confirmButtonText: 'OK'
            });
          } else {
            alert(errorMsg);
          }
        }
      });

      $('#inputImportExtrato').on('change', async function(e) {
        console.log('Arquivo selecionado - evento change disparado');
        
        const fileInput = e.target;
        if (!fileInput.files || fileInput.files.length === 0) {
          console.log('Nenhum arquivo selecionado');
          return;
        }
        
        const file = fileInput.files[0];
        console.log('Arquivo selecionado:', {
          name: file.name,
          type: file.type,
          size: file.size + ' bytes',
          lastModified: new Date(file.lastModified).toLocaleString()
        });
        
        // Mostra feedback visual para o usuário
        const originalButtonText = $('#btnImportarExtrato').html();
        $('#btnImportarExtrato').html('<i class="fas fa-spinner fa-spin"></i> Processando...').prop('disabled', true);
        
        try {
          console.log('Verificando biblioteca XLSX...');
          await ensureXLSX();
          
          if (!window.XLSX) {
            throw new Error('A biblioteca XLSX não foi carregada corretamente');
          }
          
          console.log('Iniciando processamento do arquivo...');
          await handleFileImport(file);
          console.log('Arquivo processado com sucesso');
          
          // Feedback visual de sucesso
          if (window.Swal) {
            await Swal.fire({
              title: 'Sucesso!',
              text: 'Arquivo importado com sucesso!',
              icon: 'success',
              confirmButtonText: 'OK'
            });
          }
          
        } catch (err) {
          console.error('Erro ao processar arquivo:', {
            error: err,
            message: err.message,
            stack: err.stack
          });
          
          const errorMsg = err.message || 'Ocorreu um erro ao processar o arquivo';
          console.error('Mensagem de erro:', errorMsg);
          
          if (window.Swal) {
            await Swal.fire({
              title: 'Erro',
              text: errorMsg,
              icon: 'error',
              confirmButtonText: 'OK'
            });
          } else {
            alert('Erro: ' + errorMsg);
          }
        } finally {
          // Restaura o botão
          $('#btnImportarExtrato').html(originalButtonText).prop('disabled', false);
          // Limpa o input para permitir a seleção do mesmo arquivo novamente
          fileInput.value = '';
        }
      });

      // Exportar dados da tabela para CSV
      const exportarExtratoCSV = () => {
        try{
          const visRows = dt.rows({ search: 'applied' }).data();
          if(!visRows || visRows.length === 0){
            if (window.Swal) Swal.fire('Aviso', 'Não há dados na tabela para exportar.', 'info');
            else alert('Não há dados na tabela para exportar.');
            return;
          }

          // Cabeçalho: ler diretamente do thead
          const headers = [];
          $('#tabelaExtrato thead th').each(function(){
            headers.push($(this).text().trim());
          });

          const linhas = [];
          // Escapar valores para CSV (separador ";")
          const esc = (v) => {
            const s = (v == null ? '' : String(v));
            const precisaAspas = /[";\n]/.test(s);
            const s2 = s.replace(/"/g, '""');
            return precisaAspas ? `"${s2}"` : s2;
          };

          linhas.push(headers.map(esc).join(';'));

          for(let i = 0; i < visRows.length; i++){
            const row = visRows[i];
            const arr = [];
            for(let c = 0; c < headers.length; c++){
              arr.push(esc(row[c] != null ? row[c] : ''));
            }
            linhas.push(arr.join(';'));
          }

          const csvContent = linhas.join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

          const idBanco = (new URLSearchParams(window.location.search)).get('id') || '';
          const nomeBanco = ($('#bankName').text() || '').replace(/\s+/g, '_');
          const nomeBase = nomeBanco || 'extrato_bancario';
          const fileName = `extrato_${nomeBase}${idBanco ? '_id'+idBanco : ''}.csv`;

          if (navigator.msSaveBlob) {
            navigator.msSaveBlob(blob, fileName);
          } else {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.setAttribute('download', fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          }
        }catch(err){
          console.error('Erro ao exportar extrato:', err);
          if (window.Swal) Swal.fire('Erro', 'Não foi possível exportar os dados do extrato.', 'error');
          else alert('Não foi possível exportar os dados do extrato.');
        }
      };

      $('#btnExportarExtrato').on('click', exportarExtratoCSV);

      // Eliminar todos os lançamentos do extrato
      $('#btnEliminarExtrato').on('click', async function(){
        const doConfirm = async () => {
          if (window.Swal){
            const res = await Swal.fire({
              title: 'Eliminar todos os lançamentos?',
              text: 'Esta ação não pode ser desfeita.',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: 'Sim, eliminar',
              cancelButtonText: 'Cancelar'
            });
            return res.isConfirmed;
          }
          return confirm('Tem certeza que deseja eliminar todos os lançamentos do extrato?');
        };

        try{
          const ok = await doConfirm();
          if(!ok) return;
          // Eliminar todos no backend numa única chamada
          if (bancoId) {
            try{
              const resp = await fetch(`/api/financas/bancos/${encodeURIComponent(bancoId)}/extrato`, {
                method: 'DELETE',
                headers: API.headers()
              });
              if (!resp.ok) {
                throw new Error('Falha ao eliminar lançamentos no servidor');
              }
            }catch(errApi){
              console.error('Erro ao eliminar todos lançamentos na API:', errApi);
              if (window.Swal) Swal.fire('Erro', 'Não foi possível eliminar todos os lançamentos no servidor.', 'error');
              return;
            }
          }

          // Limpa tabela e repõe saldo ao saldo inicial do banco
          dt.clear().draw(false);
          saldoAtualNum = (typeof window.__saldoBanco === 'number') ? Number(window.__saldoBanco) : 0;
          updateSaldoBadge();

          if (window.Swal) Swal.fire('Concluído', 'Todos os lançamentos do extrato foram eliminados (quando possível também no servidor).', 'success');
        }catch(err){
          console.error('Erro ao eliminar todos os lançamentos do extrato:', err);
          if (window.Swal) Swal.fire('Erro', 'Não foi possível eliminar todos os lançamentos.', 'error');
        }
      });

      // Função para remover linha da tabela
      function removerLinha(button) {
        if (confirm('Tem certeza que deseja remover esta linha?')) {
          const row = $(button).closest('tr');
          dt.row(row).remove().draw(false);
          // Atualiza o saldo após remoção
          recarregarSaldos();
        }
      }
      
      // Função para recarregar o saldo como:
      // saldo = saldoInicialDoBanco - somaTotalDeDébitos (ignorando créditos)
      function recarregarSaldos() {
        const saldoInicial = (typeof window.__saldoBanco === 'number')
          ? Number(window.__saldoBanco)
          : 0;
        let totalDebitos = 0;
        dt.rows().every(function() {
          const data = this.data();
          // Considera apenas a coluna DÉBITO (índice 6). Usa valor absoluto para somar.
          const saidas = Math.abs(toNum(data[6]));
          totalDebitos += saidas;
        });
        saldoAtualNum = saldoInicial - totalDebitos;
        
        // Atualiza o total de débitos
        const elTotalDebitos = document.getElementById('totalDebitos');
        if (elTotalDebitos) {
          elTotalDebitos.textContent = `Kz ${totalDebitos.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
        
        // força o badge a usar o valor numérico recalculado
        saldoAtualTexto = '';
        updateSaldoBadge();
      }

      // Adiciona evento de clique para o botão de remover
      $(document).on('click', '.btn-remover', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        const $button = $(this);
        let $row = $button.closest('tr');

        // Se estivermos numa linha "child" (DataTables responsivo), a linha de dados é a anterior
        if ($row.hasClass('child')) {
          const $prev = $row.prev('tr');
          if ($prev.length) {
            $row = $prev;
          }
        }

        if (!confirm('Tem certeza que deseja excluir este registro?')) {
          return;
        }

        try {
          const lancIdAttr = $button.data('lanc-id');
          const rowApi = dt.row($row);
          const rowData = rowApi && rowApi.data ? rowApi.data() : null;
          const lancId = lancIdAttr || (rowData && rowData.length > 8 ? rowData[8] : null);

          // Se houver ID de lançamento, tenta remover primeiro na API
          if (bancoId && lancId) {
            try{
              const resp = await fetch(`/api/financas/bancos/${encodeURIComponent(bancoId)}/extrato/${encodeURIComponent(lancId)}`, {
                method: 'DELETE',
                headers: API.headers()
              });
              if (!resp.ok) {
                throw new Error('Falha ao remover lançamento na API');
              }
            }catch(errApi){
              console.error('Erro ao remover lançamento na API:', errApi);
              showAlert('Não foi possível remover o registro no servidor.', 'danger');
              return;
            }
          }

          if (rowApi && rowData) {
            rowApi.remove();
          } else {
            $row.remove();
          }

          dt.rows().invalidate().draw(false);
          recarregarSaldos();
          showAlert('Registro removido com sucesso!', 'success');
        } catch (error) {
          console.error('Error removing row:', error);
          showAlert('Erro ao remover o registro: ' + (error.message || 'Erro desconhecido'), 'danger');
        }
      });

      // Adiciona evento de clique para o botão de editar
      $(document).on('click', '.btn-editar-lanc', function(e) {
        e.preventDefault();
        e.stopPropagation();
        let $row = $(this).closest('tr');
        if ($row.hasClass('child')) {
          const $prev = $row.prev('tr');
          if ($prev.length) {
            $row = $prev;
          }
        }
        const rowApi = dt.row($row);
        const data = rowApi.data();
        if (!data) return;
        editingRowIndex = rowApi.index();
        // ID está na coluna oculta de índice 8; também disponível em data-lanc-id no botão
        const btnLancId = $(this).data('lanc-id');
        editingLancId = btnLancId || ((data.length > 8 && data[8]) ? data[8] : null);

        const preencherFormulario = (lanc) => {
          const dataBase = (lanc && (lanc.data || lanc.dataTexto)) || data[0] || '';
          $('#inpData').val(toInputDate(dataBase));
          $('#inpOperacao').val((lanc && lanc.numeroOperacao) || data[1] || '');
          $('#inpDescExtrato').val((lanc && lanc.descExtrato) || data[3] || '');
          $('#inpDescPrimavera').val((lanc && lanc.descPrimavera) || '');
          $('#inpClassificacao').val((lanc && lanc.classificacao) || '');
          $('#inpStatus').val((lanc && lanc.status) || 'Conciliado');
          $('#inpFactura').val((lanc && lanc.factura) || '');

          const saidasStr = (lanc && (lanc.saidasTexto != null ? lanc.saidasTexto : lanc.saidas)) ?? data[6];
          const entradasStr = (lanc && (lanc.entradasTexto != null ? lanc.entradasTexto : lanc.entradas)) ?? data[7];
          $('#inpSaidas').val(saidasStr != null ? String(saidasStr).replace(/[^0-9.,-]/g, '') : '');
          $('#inpEntradas').val(entradasStr != null ? String(entradasStr).replace(/[^0-9.,-]/g, '') : '');
          $('#inpObs').val((lanc && lanc.observacao) || '');

          $('#modalLancamentoLabel').text('Editar Lançamento');
          $('#modalLancamento').modal('show');
        };

        if (bancoId && editingLancId) {
          fetch(`/api/financas/bancos/${encodeURIComponent(bancoId)}/extrato/${encodeURIComponent(editingLancId)}`, {
            headers: API.headers()
          })
          .then(resp => resp.ok ? resp.json() : null)
          .then(lanc => {
            preencherFormulario(lanc || null);
          })
          .catch(() => {
            preencherFormulario(null);
          });
        } else {
          preencherFormulario(null);
        }
      });

      // Após configurar tudo, tenta carregar extrato já existente (se backend estiver pronto)
      carregarExtratoInicial();

      carregarFaturasNaoPagas();

      // Função para adicionar uma nova linha à tabela
      function adicionarLinha(dados) {
        dt.row.add([
          dados[0] || '',      // DATA MOVIMENTO
          dados[1] || '',      // N. OPERAÇÃO
          dados[2] || '',      // DATA VALOR
          dados[3] || '',      // DESCRITIVO
          dados[4] || '0,00',  // DÉBITO Kz
          dados[5] || '0,00',  // CRÉDITO Kz
          dados[6] || null     // ID do lançamento (coluna oculta)
          // A coluna AÇÕES é adicionada automaticamente pelo DataTables (coluna 7)
        ]).draw();
      }
    });  
  </script>
  
</body>
</html>
