<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <title>RH - Funcionários - Kwanza Manipulus</title>
  <link rel="shortcut icon" type="image/x-icon" href="assets/img/logo.png">
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/fontawesome.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="assets/css/feathericon.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --primary-dark: #1a252f;
      --primary-light: #34495e;
      --accent-color: #0fd7d4;
      --accent-dark: #0ab5b3;
      --secondary-color: #95a5a6;
      --dark-bg: #000000;
      --darker-bg: #000000;
      --light-bg: #f8f9fa;
      --card-bg: #ffffff;
      --text-primary: #2c3e50;
      --text-secondary: #7f8c8d;
      --border-color: #dee2e6;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 40px rgba(0,0,0,0.15);
      --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }

    .header {
      background: var(--card-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border-bottom: 1px solid var(--border-color);
    }

    .header-left {
      background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%) !important;
    }

    .sidebar {
      background: #000000 !important;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
    }

    .sidebar .sidebar-menu ul li a {
      color: #ffffff !important;
      opacity: 0.85;
      transition: var(--transition-fast);
      padding: 12px 20px;
      border-radius: 8px;
      margin: 4px 10px;
    }

    .sidebar .sidebar-menu ul li a:hover {
      color: #ffffff !important;
      opacity: 1;
      background: rgba(15, 215, 212, 0.1);
      transform: translateX(5px);
    }

    .sidebar .sidebar-menu ul li.active > a {
      color: #ffffff !important;
      font-weight: 600;
      background: rgba(15, 215, 212, 0.2);
      border-left: 3px solid #0fd7d4;
    }

    .sidebar .submenu_class li a {
      color: #f2f9ff !important;
      opacity: 0.8;
      font-size: 13px;
    }

    .sidebar .submenu_class li a:hover {
      color: #0fd7d4 !important;
      opacity: 1;
    }
    
    .sidebar .sidebar-menu > ul > li > a i {
      color: #ffffff !important;
      font-size: 15px;
      margin-right: 6px;
    }

    .page-header h3 {
      color: var(--text-primary);
      font-weight: 700;
      letter-spacing: -0.3px;
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      transition: var(--transition-smooth);
      background: var(--card-bg);
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      background: #2c3e50;
      border: none;
      border-radius: 10px 10px 0 0 !important;
      padding: 12px 20px;
    }

    .card-header h4,
    .card-header h5,
    .card-header .card-title {
      color: #fff !important;
      margin: 0;
      font-weight: 600;
      font-size: 0.95rem;
      letter-spacing: 0.3px;
    }

    .card-body {
      padding: 24px;
    }

    .card-table {
      background: #000000 !important;
      border: 1px solid rgba(10, 181, 179, 0.3);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .card-table .card-header {
      background: linear-gradient(135deg, #0ab5b3 0%, #08a09e 100%) !important;
      border-bottom: 2px solid #0ab5b3;
    }

    .card-table .card-body {
      background: #000000 !important;
      padding: 20px;
    }

    .table {
      margin-bottom: 0;
      background: #000000 !important;
    }

    .table thead th {
      background: #1a1a1a !important;
      color: #0ab5b3 !important;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid rgba(10, 181, 179, 0.2) !important;
      padding: 14px 12px;
    }

    .table tbody tr {
      transition: var(--transition-fast);
      background: #000000 !important;
      border-bottom: 1px solid rgba(10, 181, 179, 0.1);
    }

    .table tbody tr:hover {
      background: rgba(10, 181, 179, 0.1) !important;
      transform: scale(1.005);
      box-shadow: 0 2px 8px rgba(10, 181, 179, 0.2);
    }

    .table tbody td {
      padding: 12px;
      vertical-align: middle;
      border-color: rgba(10, 181, 179, 0.1) !important;
      color: #e0e0e0 !important;
    }

    .btn-primary {
      background: #0fd7d4;
      border: none;
      border-radius: 8px;
      padding: 10px 24px;
      font-weight: 600;
      letter-spacing: 0.3px;
      transition: var(--transition-smooth);
      box-shadow: 0 4px 12px rgba(15, 215, 212, 0.25);
      color: #000;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(15, 215, 212, 0.35);
      background: #0ab5b3;
      color: #fff;
    }

    .page-wrapper .content.container-fluid {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
   <div class="header">
			<div class="header-left">
				<a href="dashboard.html" class="logo"> <img src="assets/img/kwanzaWhite.svg" width="50" height="70" alt="logo"> <span class="logoclass"></span> </a>
				<a href="dashboard.html" class="logo logo-small"> <img src="assets/img/kwanzaWhite.svg" alt="Logo" width="30" height="30"> </a>
			</div>
			<a href="javascript:void(0);" id="toggle_btn"> <i class="fe fe-text-align-left"></i> </a>
			<a class="mobile_btn" id="mobile_btn"> <i class="fas fa-bars"></i> </a>
			<ul class="nav user-menu">
				<li class="nav-item dropdown has-arrow">
					<a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown"> <span class="user-img"><img class="rounded-circle" src="assets/img/profiles/avatar-01.jpg" width="31" alt=""></span> </a>
					<div class="dropdown-menu">
						<div class="user-header">
							<div class="avatar avatar-sm"> <img src="foto do perfil" alt="User Image" class="avatar-img rounded-circle"> </div>
							<div class="user-text">
								<div class="muted" style="font-size:11px">Bem-vindo(a), </div>
								<h6><span id="userName">usuário</span></h6>
							</div>
						</div> <a class="dropdown-item" href="profile.html">Perfil</a> <a class="dropdown-item" href="settings.html">configurações da conta</a> <a class="dropdown-item" id="logoutBtn" href="#">Sair</a> </div>
				</li>
			</ul>
			<div class="top-nav-search">
				<form>
					<input type="text" class="form-control" placeholder="procurar">
					<button class="btn" type="submit"><i class="fas fa-search"></i></button>
				</form>
			</div>
		</div>
		<div class="sidebar" id="sidebar">
			<div class="sidebar-inner slimscroll">
				<div id="sidebar-menu" class="sidebar-menu">
					<ul>
						<li> <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a> </li>
						<li> <a href="clientes_clientes.html"><i class="fas fa-user"></i> <span>Clientes</span></a></li>
						<li class="submenu"> <a href="#" data-toggle="collapse"><i class="fas fa-user"></i> <span> Empresa </span> <span class="menu-arrow"></span></a>
							<ul class="submenu_class" style="display: none;">
								<li class="active"><a href="rh_funcionarios.html">Funcionários</a></li>
								<li><a href="rh_departamentos.html">Departamentos & Cargos</a></li>
								<li><a href="rh_ferias.html">Férias</a></li>
								<li><a href="users.html">Utilizadores</a></li>
							</ul>
						</li>
						
						<li class="submenu"> <a href="#" data-toggle="collapse"><i class="fas fa-user"></i> <span> Fornecedores</span> <span class="menu-arrow"></span></a>
							<ul class="submenu_class" style="display: none;">
								<li><a href="fornecedor.html">Lista de Fornecedores </a></li>
							</ul>
						</li>
						<li> <a href="financas.html#bancos"><i class="fas fa-university"></i> <span> Bancos</span></a> </li>
						<li> <a href="financas.html#pagamentos"><i class="fas fa-money-bill-alt"></i> <span> Pagamentos</span></a> </li>
            <li> <a href="faturas.html"><i class="fas fa-file-invoice"></i> <span>Faturas</span></a> </li>
						<li> <a href="projectos.html"><i class="fas fa-cube"></i> <span>Projectos Kwanza </span></a> </li>
					</ul>
				</div>
			</div>
		</div>
    <div class="page-wrapper">
      <div class="content container-fluid">
        <div class="page-header">
          <div class="row align-items-center">
            <div class="col">
              <h3 class="page-title">Funcionários</h3>
              <p class="text-muted mb-0">Gestão de colaboradores da empresa</p>
            </div>
            <div class="col-auto float-right ml-auto">
              <button class="btn btn-primary" id="btnNovoFuncionario"><i class="fa fa-plus"></i> Novo Funcionário</button>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <input type="text" id="searchFuncionario" class="form-control" placeholder="Pesquisar por nome, cargo, departamento...">
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="tblFuncionarios">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Cargo</th>
                    <th>Departamento</th>
                    <th>Email</th>
                    <th>Telefone</th>
                    <th>Data Admissão</th>
                    <th>Estado</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="modal fade" id="modalFuncionario" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Funcionário</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <form id="formFuncionario" enctype="multipart/form-data">
            <input type="hidden" name="id" id="func_id">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Nome *</label>
                <input name="nome" id="func_nome" class="form-control form-control-sm" required>
              </div>
              <div class="form-group col-md-6">
                <label>Cargo</label>
                <select name="cargo" id="func_cargo" class="form-control form-control-sm">
                  <option value="">(Selecione)</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Departamento</label>
                <select name="departamento" id="func_departamento" class="form-control form-control-sm">
                  <option value="">(Selecione)</option>
                </select>
              </div>
              <div class="form-group col-md-3">
                <label>Data Admissão</label>
                <input type="date" name="data_admissao" id="func_data_adm" class="form-control form-control-sm">
              </div>
              <div class="form-group col-md-3">
                <label>Estado</label>
                <select name="estado" id="func_estado" class="form-control form-control-sm">
                  <option value="Ativo">Ativo</option>
                  <option value="Inativo">Inativo</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label>Email</label>
                <input type="email" name="email" id="func_email" class="form-control form-control-sm">
              </div>
              <div class="form-group col-md-4">
                <label>Telefone</label>
                <input name="telefone" id="func_telefone" class="form-control form-control-sm">
              </div>
              <div class="form-group col-md-4">
                <label>Salário Base</label>
                <input type="number" step="0.01" name="salario_base" id="func_salario" class="form-control form-control-sm">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label>BI</label>
                <input name="bi" id="func_bi" class="form-control form-control-sm">
              </div>
              <div class="form-group col-md-4">
                <label>NIF</label>
                <input name="nif" id="func_nif" class="form-control form-control-sm">
              </div>
              <div class="form-group col-md-4">
                <label>Foto</label>
                <input type="file" name="foto_file" id="func_foto" class="form-control-file" accept="image/*">
              </div>
            </div>
            <div class="form-group">
              <label>Endereço</label>
              <input name="endereco" id="func_endereco" class="form-control form-control-sm">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnSalvarFuncionario">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/jquery-3.5.1.min.js"></script>
  <script src="assets/js/popper.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <script src="assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/script.js"></script>
  <!-- Carrega o avatar do usuário -->
  <script src="js/profile-avatar.js"></script>
  <script>
    const token = localStorage.getItem('token');
    if (!token) { window.location.href = '/'; }

    async function carregarUser(){
      try{
        const res = await fetch('/api/users/me', { headers: { Authorization: `Bearer ${token}` } });
        if(!res.ok) return;
        const me = await res.json();
        const el = document.getElementById('userName');
        if(el) el.textContent = me?.nome || 'usuário';
      }catch{}
    }
    carregarUser();

    let funcionarios = [];
    let departamentos = [];
    let cargos = [];

    function preencherSelectDepartamentos(){
      const sel = document.getElementById('func_departamento');
      if(!sel) return;
      sel.innerHTML = '<option value="">(Selecione)</option>' + departamentos.map(d => `
        <option value="${d.nome}">${d.nome}</option>
      `).join('');
    }

    function preencherSelectCargos(){
      const sel = document.getElementById('func_cargo');
      if(!sel) return;
      sel.innerHTML = '<option value="">(Selecione)</option>' + cargos.map(c => `
        <option value="${c.nome}">${c.nome}</option>
      `).join('');
    }

    async function fetchDepartamentosECargos(){
      try{
        const [resDep, resCargo] = await Promise.all([
          fetch('/api/rh/departamentos', { headers: { Authorization: `Bearer ${token}` } }),
          fetch('/api/rh/cargos', { headers: { Authorization: `Bearer ${token}` } }),
        ]);
        if(resDep.ok){
          const dataDep = await resDep.json();
          departamentos = Array.isArray(dataDep) ? dataDep : (dataDep.items || []);
          preencherSelectDepartamentos();
        }
        if(resCargo.ok){
          const dataCargo = await resCargo.json();
          cargos = Array.isArray(dataCargo) ? dataCargo : (dataCargo.items || []);
          preencherSelectCargos();
        }
      }catch(e){ console.error('Erro ao carregar departamentos/cargos', e); }
    }

    function renderFuncionarios(lista){
      const tbody = document.querySelector('#tblFuncionarios tbody');
      tbody.innerHTML = lista.map(f => `
        <tr>
          <td>${f.nome || ''}</td>
          <td>${f.cargo || ''}</td>
          <td>${f.departamento || ''}</td>
          <td>${f.email || ''}</td>
          <td>${f.telefone || ''}</td>
          <td>${f.data_admissao ? new Date(f.data_admissao).toLocaleDateString('pt-PT') : ''}</td>
          <td>${f.estado || ''}</td>
          <td>
            <button class="btn btn-sm btn-info btn-edit" data-id="${f.id}"><i class="fas fa-edit"></i></button>
            <button class="btn btn-sm btn-danger btn-del" data-id="${f.id}"><i class="fas fa-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    async function fetchFuncionarios(){
      try{
        const res = await fetch('/api/empresa/funcionarios', { headers: { Authorization: `Bearer ${token}` } });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        funcionarios = Array.isArray(data) ? data : (data.items || []);
        renderFuncionarios(funcionarios);
      }catch(e){ console.error('Erro ao carregar funcionarios', e); }
    }

    document.getElementById('searchFuncionario').addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase();
      const filt = funcionarios.filter(f => (
        (f.nome||'').toLowerCase().includes(q) ||
        (f.cargo||'').toLowerCase().includes(q) ||
        (f.departamento||'').toLowerCase().includes(q)
      ));
      renderFuncionarios(filt);
    });

    document.getElementById('btnNovoFuncionario').addEventListener('click', () => {
      const form = document.getElementById('formFuncionario');
      form.reset();
      document.getElementById('func_id').value = '';
      $('#modalFuncionario').modal('show');
    });

    document.getElementById('btnSalvarFuncionario').addEventListener('click', async () => {
      const form = document.getElementById('formFuncionario');
      if(!form.checkValidity()){
        form.reportValidity();
        return;
      }
      const id = document.getElementById('func_id').value;
      const fd = new FormData(form);
      const method = id ? 'PUT' : 'POST';
      const url = id ? `/api/empresa/funcionarios/${encodeURIComponent(id)}` : '/api/empresa/funcionarios';
      try{
        const res = await fetch(url, {
          method,
          headers: { Authorization: `Bearer ${token}` },
          body: fd
        });
        if(!res.ok){
          const txt = await res.text();
          throw new Error(txt || ('HTTP ' + res.status));
        }
        $('#modalFuncionario').modal('hide');
        await fetchFuncionarios();
      }catch(e){ alert('Erro ao salvar funcionário: ' + e.message); }
    });

    document.addEventListener('click', async (e) => {
      if(e.target.closest && e.target.closest('.btn-edit')){
        const btn = e.target.closest('.btn-edit');
        const id = btn.getAttribute('data-id');
        const f = funcionarios.find(x => String(x.id) === String(id));
        if(!f) return;
        const form = document.getElementById('formFuncionario');
        document.getElementById('func_id').value = f.id;
        document.getElementById('func_nome').value = f.nome || '';
        // tentar selecionar o departamento/cargo correspondente pelo nome
        if(f.departamento){
          document.getElementById('func_departamento').value = f.departamento;
        }else{
          document.getElementById('func_departamento').value = '';
        }
        if(f.cargo){
          document.getElementById('func_cargo').value = f.cargo;
        }else{
          document.getElementById('func_cargo').value = '';
        }
        document.getElementById('func_data_adm').value = f.data_admissao ? new Date(f.data_admissao).toISOString().slice(0,10) : '';
        document.getElementById('func_estado').value = f.estado || 'Ativo';
        document.getElementById('func_email').value = f.email || '';
        document.getElementById('func_telefone').value = f.telefone || '';
        document.getElementById('func_salario').value = f.salario_base || '';
        document.getElementById('func_bi').value = f.bi || '';
        document.getElementById('func_nif').value = f.nif || '';
        document.getElementById('func_endereco').value = f.endereco || '';
        $('#modalFuncionario').modal('show');
      }
      if(e.target.closest && e.target.closest('.btn-del')){
        const btn = e.target.closest('.btn-del');
        const id = btn.getAttribute('data-id');
        if(!confirm('Tem certeza que deseja eliminar este funcionário?')) return;
        try{
          const res = await fetch(`/api/empresa/funcionarios/${encodeURIComponent(id)}`, {
            method: 'DELETE',
            headers: { Authorization: `Bearer ${token}` }
          });
          if(!res.ok && res.status !== 204){
            const txt = await res.text();
            throw new Error(txt || ('HTTP ' + res.status));
          }
          await fetchFuncionarios();
        }catch(e){ alert('Erro ao eliminar funcionário: ' + e.message); }
      }
    });

    fetchDepartamentosECargos().then(fetchFuncionarios);
  </script>
</body>
</html>
