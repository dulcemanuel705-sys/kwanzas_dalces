<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <title>Faturas - Kwanzas Metal</title>
  <link rel="shortcut icon" type="image/x-icon" href="assets/img/logo.png">
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/fontawesome.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="assets/css/feathericon.min.css">
  <link rel="stylesheet" href="assets/plugins/morris/morris.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    /* Estilo semelhante ao dashboard: sidebar preta e cabeçalho claro */
    :root {
      --primary-color: #2c3e50;
      --primary-dark: #1a252f;
      --primary-light: #34495e;
      --accent-color: #0fd7d4;
      --dark-bg: #000000;
      --darker-bg: #000000;
      --light-bg: #f8f9fa;
      --card-bg: #ffffff;
      --text-primary: #2c3e50;
      --border-color: #dee2e6;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }

    .header {
      background: var(--card-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border-bottom: 1px solid var(--border-color);
    }

    .header-left {
      background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%) !important;
    }

    .sidebar {
      background: #000000 !important;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
    }

    .sidebar .sidebar-menu ul li a {
      color: #ffffff !important;
      opacity: 0.85;
      padding: 12px 20px;
      border-radius: 8px;
      margin: 4px 10px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sidebar .sidebar-menu ul li a:hover {
      color: #ffffff !important;
      opacity: 1;
      background: rgba(15, 215, 212, 0.1);
      transform: translateX(5px);
    }

    .sidebar .sidebar-menu ul li.active > a,
    .sidebar .sidebar-menu ul li a.active {
      color: #ffffff !important;
      font-weight: 600;
      background: rgba(15, 215, 212, 0.2);
      border-left: 3px solid #0fd7d4;
    }

    .sidebar .sidebar-menu > ul > li > a i {
      color: #ffffff !important;
      font-size: 15px;
      margin-right: 6px;
    }

    .sidebar .submenu_class li a {
      color: #f2f9ff !important;
      opacity: 0.8;
      font-size: 13px;
    }

    .sidebar .submenu_class li a:hover {
      color: #0fd7d4 !important;
      opacity: 1;
    }

    .page-header h1 {
      color: var(--text-primary);
      font-weight: 700;
      font-size: 24px;
      letter-spacing: -0.5px;
    }

    /* ===== Tabela de Faturas - UI refinada ===== */
    #tblFaturas{
      font-size: 0.82rem;
    }
    #tblFaturas thead th{
      background: #f5f8fc;
      color: #066fe3;
      font-weight: 600;
      border-bottom: 2px solid #dde5f2;
      white-space: nowrap;
    }
    #tblFaturas tbody td{
      vertical-align: middle;
      padding-top: .35rem;
      padding-bottom: .35rem;
      white-space: nowrap;
    }
    #tblFaturas tbody tr:hover{
      background-color: #f0f7ff;
    }
    .sticky-th thead th{
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .card.card-table{
      border-radius: 14px;
      border: 1px solid #dde5f2;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
    }
    .card.card-table .card-body{
      padding-top: 1rem;
    }
    /* Badges de situação */
    .badge-status{
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
    }
    .badge-status-pago{
      background-color: #defce7;
      color: #166534;
    }
    .badge-status-parcial{
      background-color: #fef9c3;
      color: #854d0e;
    }
    .badge-status-aberto{
      background-color: #e0f0ff;
      color: #1d4ed8;
    }
    /* Cores de linha por estado (igual fornecedores) */
    #tblFaturas tbody tr.row-fatura-paga{
      background-color: #e8f9ef !important;
    }
    #tblFaturas tbody tr.row-fatura-parcial{
      background-color: #fff7e0 !important;
    }
    #tblFaturas tbody tr.row-fatura-aberto{
      background-color: #e0f0ff !important;
    }
    /* Botão pagar mais compacto */
    .btn-pagar-fatura{
      padding: .20rem .55rem;
      font-size: 0.72rem;
      border-radius: 999px;
    }

    /* ===== ENHANCED DATATABLES STYLING ===== */
    
    /* DataTables pagination */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
      padding: 6px 12px !important;
      margin: 0 2px !important;
      border-radius: 6px !important;
      border: 1px solid #dee2e6 !important;
      background: #ffffff !important;
      color: #2c3e50 !important;
      font-weight: 500 !important;
      transition: all 0.2s ease !important;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      background: #0fd7d4 !important;
      border-color: #0fd7d4 !important;
      color: #ffffff !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 2px 8px rgba(15, 215, 212, 0.3) !important;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
      background: #0fd7d4 !important;
      border-color: #0fd7d4 !important;
      color: #ffffff !important;
      font-weight: 600 !important;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
      opacity: 0.4 !important;
      cursor: not-allowed !important;
    }
    
    /* DataTables info */
    .dataTables_wrapper .dataTables_info {
      color: #6c757d !important;
      font-size: 0.85rem !important;
      font-weight: 500 !important;
      padding: 10px 0 !important;
    }
    
    /* DataTables length menu (hidden but styled if enabled) */
    .dataTables_wrapper .dataTables_length {
      color: #6c757d !important;
      font-size: 0.85rem !important;
      padding: 10px 0 !important;
    }
    
    .dataTables_wrapper .dataTables_length select {
      border: 1px solid #dee2e6 !important;
      border-radius: 6px !important;
      padding: 4px 8px !important;
      background: #ffffff !important;
      color: #2c3e50 !important;
      font-size: 0.85rem !important;
    }
    
    /* DataTables filter (hidden but styled if enabled) */
    .dataTables_wrapper .dataTables_filter {
      color: #6c757d !important;
      font-size: 0.85rem !important;
      padding: 10px 0 !important;
    }
    
    .dataTables_wrapper .dataTables_filter input {
      border: 1px solid #dee2e6 !important;
      border-radius: 6px !important;
      padding: 6px 12px !important;
      background: #ffffff !important;
      color: #2c3e50 !important;
      font-size: 0.85rem !important;
      margin-left: 8px !important;
    }
    
    .dataTables_wrapper .dataTables_filter input:focus {
      border-color: #0fd7d4 !important;
      box-shadow: 0 0 0 3px rgba(15, 215, 212, 0.1) !important;
      outline: none !important;
    }
    
    /* DataTables processing indicator */
    .dataTables_wrapper .dataTables_processing {
      background: rgba(255, 255, 255, 0.95) !important;
      border: 1px solid #dee2e6 !important;
      border-radius: 8px !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
      color: #2c3e50 !important;
      font-weight: 500 !important;
    }
    
    /* DataTables container spacing */
    .dataTables_wrapper {
      margin-top: 15px !important;
    }
    
    .dataTables_wrapper .dataTables_paginate,
    .dataTables_wrapper .dataTables_info {
      margin-top: 15px !important;
    }
    
    /* Enhanced table hover effects */
    #tblFaturas tbody tr {
      transition: all 0.2s ease !important;
    }
    
    #tblFaturas tbody tr:hover {
      transform: scale(1.005) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
    }
    
    /* Sort icons styling */
    .dataTables_wrapper .dataTables thead th.sorting:after,
    .dataTables_wrapper .dataTables thead th.sorting_asc:after,
    .dataTables_wrapper .dataTables thead th.sorting_desc:after {
      opacity: 0.6 !important;
      color: #0fd7d4 !important;
    }
    
    .dataTables_wrapper .dataTables thead th.sorting_asc:after {
      opacity: 1 !important;
    }
    
    .dataTables_wrapper .dataTables thead th.sorting_desc:after {
      opacity: 1 !important;
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="header">
      <div class="header-left">
        <a href="dashboard.html" class="logo">
          <img src="assets/img/kwanzaWhite.svg" width="50" height="70" alt="logo">
          <span class="logoclass"></span>
        </a>
        <a href="dashboard.html" class="logo logo-small">
          <img src="assets/img/kwanzaWhite.svg" alt="Logo" width="30" height="30">
        </a>
      </div>
      <a href="javascript:void(0);" id="toggle_btn"><i class="fe fe-text-align-left"></i></a>
      <a class="mobile_btn" id="mobile_btn"><i class="fas fa-bars"></i></a>
      <ul class="nav user-menu">
        <li class="nav-item dropdown has-arrow">
          <a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown">
            <span class="user-img"><img class="rounded-circle" src="assets/img/profiles/avatar-01.jpg" width="31" alt=""></span>
          </a>
          <div class="dropdown-menu">
            <div class="user-header">
              <div class="avatar avatar-sm">
                <img src="foto do perfil" alt="User Image" class="avatar-img rounded-circle">
              </div>
              <div class="user-text">
                <div class="muted" style="font-size:11px">Bem-vindo(a), </div>
                <h6><span id="userName">usuário</span></h6>
              </div>
            </div>
            <a class="dropdown-item" href="profile.html">Perfil</a>
            <a class="dropdown-item" href="settings.html">configurações da conta</a>
            <a class="dropdown-item" id="logoutBtn" href="#">Sair</a>
          </div>
        </li>
      </ul>
      <div class="top-nav-search">
        <form>
          <input type="text" class="form-control" placeholder="procurar">
          <button class="btn" type="submit"><i class="fas fa-search"></i></button>
        </form>
      </div>
    </div>

    <div class="sidebar" id="sidebar">
      <div class="sidebar-inner slimscroll">
        <div id="sidebar-menu" class="sidebar-menu">
          <ul>
            <li> <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a> </li>
            <li> <a href="clientes_clientes.html"><i class="fas fa-user"></i> <span>Clientes</span></a></li>
            <li class="submenu"> <a href="#" data-toggle="collapse"><i class="fas fa-user"></i> <span> Empresa </span> <span class="menu-arrow"></span></a>
              <ul class="submenu_class" style="display: none;">
                <li><a href="rh_funcionarios.html">Funcionários</a></li>
                <li><a href="rh_departamentos.html">Departamentos & Cargos</a></li>
                <li><a href="rh_ferias.html">Férias</a></li>
                <li><a href="users.html">Utilizadores</a></li>
              </ul>
            </li>
            
            <li class="submenu"> <a href="#" data-toggle="collapse"><i class="fas fa-user"></i> <span> Fornecedores</span> <span class="menu-arrow"></span></a>
              <ul class="submenu_class" style="display: none;">
                <li><a href="fornecedor.html">Lista de Fornecedores </a></li>
              </ul>
            </li>
            <li> <a href="financas.html#bancos"><i class="fas fa-university"></i> <span> Bancos</span></a> </li>
            <li> <a href="financas.html#pagamentos"><i class="fas fa-money-bill-alt"></i> <span> Pagamentos</span></a> </li>
            <li> <a href="projectos.html"><i class="fas fa-cube"></i> <span>Projectos Kwanza </span></a> </li>
            <li class="active"> <a href="faturas.html"><i class="fas fa-file-invoice"></i> <span>Faturas</span></a> </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="page-wrapper">
      <div class="content container-fluid">
        <div class="page-header">
          <div class="row">
            <div class="col-sm-12 mt-5">
              <h1>Faturas de Fornecedores</h1>
              <p class="text-muted mb-0">Lista de faturas extraídas do mapa de fornecedores</p>
            </div>
          </div>
        </div>

        
        <div class="card card-table">
          <div class="card-body">
            <div class="table-responsive sticky-th">
              <table class="table table-hover table-center table-sm" id="tblFaturas">
                <thead>
                  <tr>
                    <th>Nº Fatura</th>
                    <th>Fornecedor</th>
                    <th>NIF</th>
                    <th>Pago via</th>
                    <th>Data do Documento</th>
                    <th>Mês</th>
                    <th>Valor do Documento</th>
                    <th>Valor IVA</th>
                    <th>Valor Pago</th>
                    <th>Dívida</th>
                    <th>Projeto</th>
                    <th>Data Pagamento</th>
                    <th>Situação</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal Pagar Fatura -->
  <div class="modal fade" id="modalPagarFatura" tabindex="-1" role="dialog" aria-labelledby="modalPagarFaturaLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalPagarFaturaLabel">Pagar Fatura</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="formPagarFatura">
            <div class="form-group">
              <label>Fatura</label>
              <input type="text" id="pfNumFatura" class="form-control form-control-sm" readonly>
            </div>
            <div class="form-group">
              <label>Fornecedor</label>
              <input type="text" id="pfFornecedor" class="form-control form-control-sm" readonly>
            </div>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label>Total do Documento</label>
                <input type="text" id="pfTotal" class="form-control form-control-sm" readonly>
              </div>
              <div class="form-group col-md-4">
                <label>Já Pago</label>
                <input type="text" id="pfPago" class="form-control form-control-sm" readonly>
              </div>
              <div class="form-group col-md-4">
                <label>Em Aberto</label>
                <input type="text" id="pfEmAberto" class="form-control form-control-sm" readonly>
              </div>
            </div>
            <div class="form-group">
              <label>Banco / Conta a debitar</label>
              <select id="pfBanco" class="form-control form-control-sm" required>
                <option value="">-- selecione o banco --</option>
              </select>
              <small id="pfSaldoBanco" class="form-text text-muted"></small>
            </div>
            <div class="form-group">
              <label>Valor a Pagar</label>
              <input type="number" step="0.01" min="0" id="pfValorPagar" class="form-control form-control-sm" required>
              <small class="form-text text-muted">Pode pagar parcial ou totalmente. Não pode exceder o valor em aberto.</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" id="btnConfirmarPagamento">Confirmar Pagamento</button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/jquery-3.5.1.min.js"></script>
  <script src="assets/js/popper.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <script src="assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/script.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <script>
    async function checkAuth(){
      const token = localStorage.getItem('token');
      if (!token) { window.location.href = '/'; return; }
      try {
        const res = await fetch('/api/users/me', { headers: { Authorization: `Bearer ${token}` } });
        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/';
          return;
        }
        if (!res.ok) throw new Error('server_error');
        const me = await res.json();
        const userName = document.getElementById('userName');
        if (userName) userName.textContent = me?.nome || 'usuário';
      } catch {}
    }
    checkAuth();

    let faturas = [];
    let bancos = [];
    let faturaSelecionada = null;
    let saldoBancoAtual = null;

    function renderTabelaFaturas(items){
      const tbody = document.querySelector('#tblFaturas tbody');
      const mapSituacao = (it) => {
        const sit = (it.situacao || '').toString().trim().toUpperCase();
        const dividaNum = it.divida != null ? Number(it.divida) : null;
        if (sit === 'PAGO' || sit === 'PAGA' || (dividaNum !== null && dividaNum === 0)) {
          return { label: it.situacao || 'Paga', cls: 'badge-status badge-status-pago', rowClass: 'row-fatura-paga' };
        }
        if (sit === 'PARCIAL'){
          return { label: it.situacao, cls: 'badge-status badge-status-parcial', rowClass: 'row-fatura-parcial' };
        }
        if (!sit){
          return { label: 'Em aberto', cls: 'badge-status badge-status-aberto', rowClass: 'row-fatura-aberto' };
        }
        return { label: it.situacao, cls: 'badge-status badge-status-aberto', rowClass: 'row-fatura-aberto' };
      };
      tbody.innerHTML = items.map(it => {
        const status = mapSituacao(it);
        const isPago = status.cls.includes('badge-status-pago');
        const id = it.id != null ? it.id : '';
        const rowClass = status.rowClass || '';
        return `
        <tr data-id="${id}" class="${rowClass}">
          <td>${it.num_factura || ''}</td>
          <td>${it.nome || ''}</td>
          <td>${it.nif || ''}</td>
          <td>${it.pago_via || ''}</td>
          <td class="text-center">${it.data_documento || ''}</td>
          <td class="text-center">${it.mes || ''}</td>
          <td class="text-right">${it.valor_documento != null ? it.valor_documento : ''}</td>
          <td class="text-right">${it.valor_iva != null ? it.valor_iva : ''}</td>
          <td class="text-right">${it.valor_pago != null ? it.valor_pago : ''}</td>
          <td class="text-right">${it.divida != null ? it.divida : ''}</td>
          <td>${it.id_projecto != null ? it.id_projecto : ''}</td>
          <td class="text-center">${it.data_pagamento || ''}</td>
          <td class="text-center"><span class="${status.cls}">${status.label}</span></td>
          <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-success btn-pagar-fatura" data-id="${id}" ${isPago ? 'disabled' : ''}>Pagar</button>
          </td>
        </tr>`;
      }).join('');
      try{
        if ($.fn.DataTable.isDataTable('#tblFaturas')) {
          $('#tblFaturas').DataTable().destroy();
        }
        $('#tblFaturas').DataTable({
          pageLength: 5,
          lengthChange: false,
          ordering: true,
          searching: true,
          responsive: true,
          autoWidth: false,
          language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/pt-PT.json' }
        });
        
        // Enable DataTable's built-in search display
        $('.dataTables_filter').show();
      }catch(e){ console.warn('DataTable init falhou:', e); }
    }

    async function fetchFaturasFromFornecedores(){
      try{
        const res = await API.getJSON('/api/fornecedores');
        const items = Array.isArray(res) ? res : (res?.items || []);
        // filtra apenas linhas com nº de fatura preenchido
        faturas = items.filter(it => (it.num_factura || '').toString().trim() !== '');
        renderTabelaFaturas(faturas);
      }catch(e){ console.error('Erro ao carregar faturas a partir dos fornecedores', e); }
    }

    async function fetchBancos(){
      try{
        const res = await API.getJSON('/api/financas/bancos');
        bancos = Array.isArray(res) ? res : (res?.items || []);
        const sel = document.getElementById('pfBanco');
        if (!sel) return;
        const opts = ['<option value="">-- selecione o banco --</option>'].concat(
          bancos.map(b => {
            const label = [b.banco, b.conta, b.iban].filter(Boolean).join(' · ');
            return `<option value="${b.id}">${label || 'Banco ' + b.id}</option>`;
          })
        );
        sel.innerHTML = opts.join('');
      }catch(e){ console.error('Erro ao carregar bancos', e); }
    }

    async function carregarSaldoBancoSelecionado(){
      try{
        const sel = document.getElementById('pfBanco');
        const infoSaldo = document.getElementById('pfSaldoBanco');
        saldoBancoAtual = null;
        if (!sel || !infoSaldo || !sel.value){
          if (infoSaldo) infoSaldo.textContent = '';
          return;
        }
        const bancoId = sel.value;
        const extrato = await API.getJSON(`/api/financas/bancos/${encodeURIComponent(bancoId)}/extrato`);
        let saldoText = '';
        if (Array.isArray(extrato) && extrato.length > 0){
          const last = extrato[extrato.length - 1];
          if (last){
            if (last.saldoTexto != null && String(last.saldoTexto).trim() !== ''){
              saldoText = String(last.saldoTexto);
            } else if (last.saldo != null){
              saldoText = String(last.saldo);
            }
          }
        }
        if (saldoText !== ''){
          infoSaldo.textContent = 'Saldo atual: ' + saldoText;
          const num = Number(String(saldoText).replace(/[^0-9.-]/g, ''));
          saldoBancoAtual = Number.isFinite(num) ? num : null;
        } else {
          infoSaldo.textContent = 'Saldo atual indisponível.';
        }
      }catch(err){
        console.error('Erro ao carregar saldo do banco', err);
        const infoSaldo = document.getElementById('pfSaldoBanco');
        if (infoSaldo) infoSaldo.textContent = 'Erro ao carregar saldo do banco.';
      }
    }


    document.addEventListener('click', (e) => {
      const btn = e.target.closest && e.target.closest('.btn-pagar-fatura');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      if (!id) return;
      const f = faturas.find(x => String(x.id) === String(id));
      if (!f) return;
      faturaSelecionada = f;
      const total = f.valor_documento != null ? Number(f.valor_documento) : 0;
      const pago = f.valor_pago != null ? Number(f.valor_pago) : 0;
      const emAberto = total - pago;
      document.getElementById('pfNumFatura').value = f.num_factura || '';
      document.getElementById('pfFornecedor').value = f.nome || '';
      document.getElementById('pfTotal').value = total || 0;
      document.getElementById('pfPago').value = pago || 0;
      document.getElementById('pfEmAberto').value = emAberto > 0 ? emAberto : 0;
      const inpValor = document.getElementById('pfValorPagar');
      inpValor.value = emAberto > 0 ? emAberto : 0;
      inpValor.max = emAberto > 0 ? emAberto : total;
      $('#modalPagarFatura').modal('show');
      carregarSaldoBancoSelecionado();
    });

    document.getElementById('pfBanco').addEventListener('change', carregarSaldoBancoSelecionado);

    document.getElementById('btnConfirmarPagamento').addEventListener('click', async () => {
      if (!faturaSelecionada){
        alert('Nenhuma fatura selecionada.');
        return;
      }
      const selBanco = document.getElementById('pfBanco');
      const valorInput = document.getElementById('pfValorPagar');
      const emAberto = Number(document.getElementById('pfEmAberto').value || '0');
      const total = faturaSelecionada.valor_documento != null ? Number(faturaSelecionada.valor_documento) : 0;
      const pagoAtual = faturaSelecionada.valor_pago != null ? Number(faturaSelecionada.valor_pago) : 0;
      const valor = Number(valorInput.value || '0');
      if (!selBanco.value){
        if (window.Swal) Swal.fire('Atenção','Escolha o banco para efetuar o pagamento.','warning');
        else alert('Escolha o banco para efetuar o pagamento.');
        return;
      }
      if (!Number.isFinite(valor) || valor <= 0){
        if (window.Swal) Swal.fire('Atenção','Introduza um valor de pagamento válido.','warning');
        else alert('Introduza um valor de pagamento válido.');
        return;
      }
      if (emAberto > 0 && valor > emAberto + 0.0001){
        if (window.Swal) Swal.fire('Atenção','O valor a pagar não pode ser superior ao em aberto.','warning');
        else alert('O valor a pagar não pode ser superior ao em aberto.');
        return;
      }
      const novoPago = pagoAtual + valor;
      const novaDivida = Math.max(total - novoPago, 0);
      const situacao = novaDivida === 0 ? 'PAGA' : 'PARCIAL';
      const hoje = new Date().toISOString().slice(0,10);
      const banco = bancos.find(b => String(b.id) === String(selBanco.value));
      const pagoVia = banco ? (banco.banco || `Banco ${banco.id}`) : faturaSelecionada.pago_via;
      const payload = {
        valor_pago: novoPago,
        divida: novaDivida,
        situacao,
        data_pagamento: hoje,
        pago_via: pagoVia
      };
      try{
        const id = faturaSelecionada.id;
        
        // 1. Atualizar fatura
        await API.putJSON(`/api/fornecedores/${encodeURIComponent(id)}`, payload);
        faturaSelecionada.valor_pago = payload.valor_pago;
        faturaSelecionada.divida = payload.divida;
        faturaSelecionada.situacao = payload.situacao;
        faturaSelecionada.data_pagamento = payload.data_pagamento;
        faturaSelecionada.pago_via = payload.pago_via;
        
        // 2. Registrar transação no extrato do banco (apenas isso!)
        const bancoId = selBanco.value;
        const extratoPayload = {
          data: hoje,
          dataTexto: hoje,
          dataValorTexto: hoje,
          numeroOperacao: `FAT-${faturaSelecionada.num_factura || id}`,
          descExtrato: `Pagamento Fatura ${faturaSelecionada.num_factura || id} - ${faturaSelecionada.fornecedor || 'Fornecedor'}`,
          classificacao: 'Pagamento',
          saidas: valor,
          saidasTexto: valor.toLocaleString('pt-PT', { style: 'currency', currency: 'AOA' }),
          observacao: `Pagamento de fatura via ${banco.banco || 'Banco'}`
        };
        
        await API.postJSON(`/api/financas/bancos/${encodeURIComponent(bancoId)}/extrato`, extratoPayload);
        
        // 3. NÃO atualizar o saldo cadastrado do banco!
        // O saldo atual será recalculado automaticamente com base no extrato
        
        renderTabelaFaturas(faturas);
        $('#modalPagarFatura').modal('hide');
        
        // Recarregar saldo do banco para mostrar valor atualizado
        await carregarSaldoBancoSelecionado();
        
        let textoSaldo = '';
        if (saldoBancoAtual != null){
          const novoSaldoDisponivel = saldoBancoAtual - valor;
          textoSaldo = '\nSaldo disponível: ' + novoSaldoDisponivel.toLocaleString('pt-PT',{style:'currency',currency:'AOA'});
        }
        if (window.Swal) Swal.fire('Pagamento registado','Valor pago: ' + valor.toLocaleString('pt-PT',{style:'currency',currency:'AOA'}) + textoSaldo,'success');
        else alert('Pagamento registado com sucesso.' + textoSaldo);
      }catch(err){
        console.error('Erro ao registar pagamento', err);
        if (window.Swal) Swal.fire('Erro','Erro ao registar pagamento: ' + (err && err.message ? err.message : 'desconhecido'),'error');
        else alert('Erro ao registar pagamento: ' + (err && err.message ? err.message : 'desconhecido'));
      }
    });

    fetchFaturasFromFornecedores();
    fetchBancos();
  </script>
   <script src="js/profile-avatar.js"></script>
</body>
</html>
