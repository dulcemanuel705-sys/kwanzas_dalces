<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <title>Empresa - Utilizadores - Kwanza Manipulus</title>
  <link rel="shortcut icon" type="image/x-icon" href="assets/img/logo.png">
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/fontawesome.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="assets/css/feathericon.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --primary-dark: #1a252f;
      --primary-light: #34495e;
      --accent-color: #0fd7d4;
      --accent-dark: #0ab5b3;
      --secondary-color: #95a5a6;
      --dark-bg: #000000;
      --darker-bg: #000000;
      --light-bg: #f8f9fa;
      --card-bg: #ffffff;
      --text-primary: #2c3e50;
      --text-secondary: #7f8c8d;
      --border-color: #dee2e6;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 40px rgba(0,0,0,0.15);
      --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }

    .header {
      background: var(--card-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border-bottom: 1px solid var(--border-color);
    }

    .header-left {
      background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%) !important;
    }

    .sidebar {
      background: #000000 !important;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
    }

    .sidebar .sidebar-menu ul li a {
      color: #ffffff !important;
      opacity: 0.85;
      transition: var(--transition-fast);
      padding: 12px 20px;
      border-radius: 8px;
      margin: 4px 10px;
    }

    .sidebar .sidebar-menu ul li a:hover {
      color: #ffffff !important;
      opacity: 1;
      background: rgba(15, 215, 212, 0.1);
      transform: translateX(5px);
    }

    .sidebar .sidebar-menu ul li.active > a {
      color: #ffffff !important;
      font-weight: 600;
      background: rgba(15, 215, 212, 0.2);
      border-left: 3px solid #0fd7d4;
    }

    .sidebar .submenu_class li a {
      color: #f2f9ff !important;
      opacity: 0.8;
      font-size: 13px;
    }

    .sidebar .submenu_class li a:hover {
      color: #0fd7d4 !important;
      opacity: 1;
    }
    
    .sidebar .sidebar-menu > ul > li > a i {
      color: #ffffff !important;
      font-size: 15px;
      margin-right: 6px;
    }

    .page-header h3 {
      color: var(--text-primary);
      font-weight: 700;
      letter-spacing: -0.3px;
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      transition: var(--transition-smooth);
      background: var(--card-bg);
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      background: #2c3e50;
      border: none;
      border-radius: 10px 10px 0 0 !important;
      padding: 12px 20px;
    }

    .card-header h4,
    .card-header h5,
    .card-header .card-title {
      color: #fff !important;
      margin: 0;
      font-weight: 600;
      font-size: 0.95rem;
      letter-spacing: 0.3px;
    }

    .card-body {
      padding: 24px;
    }

    .card-table {
      background: #000000 !important;
      border: 1px solid rgba(10, 181, 179, 0.3);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .card-table .card-header {
      background: linear-gradient(135deg, #0ab5b3 0%, #08a09e 100%) !important;
      border-bottom: 2px solid #0ab5b3;
    }

    .card-table .card-body {
      background: #000000 !important;
      padding: 20px;
    }

    .table {
      margin-bottom: 0;
      background: #000000 !important;
    }

    .table thead th {
      background: #1a1a1a !important;
      color: #0ab5b3 !important;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid rgba(10, 181, 179, 0.2) !important;
      padding: 14px 12px;
    }

    .table tbody tr {
      transition: var(--transition-fast);
      background: #000000 !important;
      border-bottom: 1px solid rgba(10, 181, 179, 0.1);
    }

    .table tbody tr:hover {
      background: rgba(10, 181, 179, 0.1) !important;
      transform: scale(1.005);
      box-shadow: 0 2px 8px rgba(10, 181, 179, 0.2);
    }

    .table tbody td {
      padding: 12px;
      vertical-align: middle;
      border-color: rgba(10, 181, 179, 0.1) !important;
      color: #e0e0e0 !important;
    }

    .btn-primary {
      background: #0fd7d4;
      border: none;
      border-radius: 8px;
      padding: 10px 24px;
      font-weight: 600;
      letter-spacing: 0.3px;
      transition: var(--transition-smooth);
      box-shadow: 0 4px 12px rgba(15, 215, 212, 0.25);
      color: #000;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(15, 215, 212, 0.35);
      background: #0ab5b3;
      color: #fff;
    }

    .page-wrapper .content.container-fluid {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
   <div class="header">
			<div class="header-left">
				<a href="dashboard.html" class="logo"> <img src="assets/img/kwanzaWhite.svg" width="50" height="70" alt="logo"> <span class="logoclass"></span> </a>
				<a href="dashboard.html" class="logo logo-small"> <img src="assets/img/kwanzaWhite.svg" alt="Logo" width="30" height="30"> </a>
			</div>
			<a href="javascript:void(0);" id="toggle_btn"> <i class="fe fe-text-align-left"></i> </a>
			<a class="mobile_btn" id="mobile_btn"> <i class="fas fa-bars"></i> </a>
			<ul class="nav user-menu">
				<li class="nav-item dropdown has-arrow">
					<a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown"> <span class="user-img"><img class="rounded-circle" src="assets/img/profiles/avatar-01.jpg" width="31" alt=""></span> </a>
					<div class="dropdown-menu">
						<div class="user-header">
							<div class="avatar avatar-sm"> <img src="foto do perfil" alt="User Image" class="avatar-img rounded-circle"> </div>
							<div class="user-text">
								<div class="muted" style="font-size:11px">Bem-vindo(a), </div>
								<h6><span id="userName">usuário</span></h6>
							</div>
						</div> <a class="dropdown-item" href="profile.html">Perfil</a> <a class="dropdown-item" href="settings.html">configurações da conta</a> <a class="dropdown-item" id="logoutBtn" href="#">Sair</a> </div>
				</li>
			</ul>
			<div class="top-nav-search">
				<form>
					<input type="text" class="form-control" placeholder="procurar">
					<button class="btn" type="submit"><i class="fas fa-search"></i></button>
				</form>
			</div>
		</div>
		<div class="sidebar" id="sidebar">
			<div class="sidebar-inner slimscroll">
				<div id="sidebar-menu" class="sidebar-menu">
					<ul>
						<li> <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a> </li>
						<li> <a href="clientes_clientes.html"><i class="fas fa-user"></i> <span>Clientes</span></a></li>
						<li class="submenu"> <a href="#" data-toggle="collapse"><i class="fas fa-user"></i> <span> Empresa </span> <span class="menu-arrow"></span></a>
							<ul class="submenu_class" style="display: none;">
								<li><a href="rh_funcionarios.html">Funcionários</a></li>
								<li><a href="rh_departamentos.html">Departamentos & Cargos</a></li>
								<li><a href="rh_ferias.html">Férias</a></li>
								<li class="active"><a href="users.html">Utilizadores</a></li>
							</ul>
						</li>
						
						<li class="submenu"> <a href="#" data-toggle="collapse"><i class="fas fa-user"></i> <span> Fornecedores</span> <span class="menu-arrow"></span></a>
							<ul class="submenu_class" style="display: none;">
								<li><a href="fornecedor.html">Lista de Fornecedores </a></li>
							</ul>
						</li>
						<li> <a href="financas.html#bancos"><i class="fas fa-university"></i> <span> Bancos</span></a> </li>
						<li> <a href="financas.html#pagamentos"><i class="fas fa-money-bill-alt"></i> <span> Pagamentos</span></a> </li>
            <li> <a href="faturas.html"><i class="fas fa-file-invoice"></i> <span>Faturas</span></a> </li>
						<li> <a href="projectos.html"><i class="fas fa-cube"></i> <span>Projectos Kwanza </span></a> </li>
					</ul>
				</div>
			</div>
		</div>
    <div class="page-wrapper">
      <div class="content container-fluid">
        <div class="page-header">
          <div class="row align-items-center">
            <div class="col">
              <h3 class="page-title">Utilizadores</h3>
              <p class="text-muted mb-0">Gestão de contas de acesso ao sistema</p>
            </div>
            <div class="col-auto float-right ml-auto">
              <button class="btn btn-primary" id="btnNovoUser"><i class="fa fa-plus"></i> Novo Utilizador</button>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <input type="text" id="searchUser" class="form-control" placeholder="Pesquisar por nome, email, tipo...">
          </div>
          <div class="col-md-3">
            <select id="filterTipo" class="form-control">
              <option value="">Todos os tipos</option>
              <option value="admin">Administradores</option>
              <option value="gestor">Gestores de Projectos</option>
              <option value="contabilista">Contabilistas</option>
              <option value="user">Utilizadores</option>
            </select>
          </div>
        </div>

        <div class="card card-table">
          <div class="card-header">
            <h4 class="card-title">Lista de Utilizadores</h4>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="tblUsers">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Telefone</th>
                    <th>Funcionário</th>
                    <th>Tipo</th>
                    <th>Ativo</th>
                    <th>Último acesso</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="modal fade" id="modalUser" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Utilizador</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <form id="formUser">
            <input type="hidden" name="id" id="user_id">
            <div class="form-group">
              <label>Nome *</label>
              <input name="nome" id="user_nome" class="form-control form-control-sm" required>
            </div>
            <div class="form-group">
              <label>Apelido</label>
              <input name="sobrenome" id="user_sobrenome" class="form-control form-control-sm">
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" name="email" id="user_email" class="form-control form-control-sm" required>
            </div>
            <div class="form-group">
              <label>Telefone</label>
              <input name="telefone" id="user_telefone" class="form-control form-control-sm">
            </div>
            <div class="form-group">
              <label>Funcionário associado</label>
              <select name="id_funcionario" id="user_funcionario" class="form-control form-control-sm">
                <option value="">(nenhum)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Tipo</label>
              <select name="tipo" id="user_tipo" class="form-control form-control-sm">
                <option value="">Selecione o Cargo</option>
                <option value="admin">Administrador</option>
                <option value="gestor">Gestor de Projectos</option>
                <option value="contabilista">Contabilista</option>
                <option value="user">Usuário</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ativo</label>
              <select name="ativo" id="user_ativo" class="form-control form-control-sm">
                <option value="true">Ativo</option>
                <option value="false">Inativo</option>
              </select>
            </div>
            <div class="form-group">
              <label>Senha <span id="senhaHint">(obrigatória para novo utilizador)</span></label>
              <input type="password" name="senha" id="user_senha" class="form-control form-control-sm">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnSalvarUser">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/jquery-3.5.1.min.js"></script>
  <script src="assets/js/popper.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <script src="assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/script.js"></script>
  <!-- Carrega o avatar do usuário -->
  <script src="js/profile-avatar.js"></script>
  <script>
    const token = localStorage.getItem('token');
    if (!token) { window.location.href = '/'; }

    let currentUser = null;
    let users = [];
    let funcionarios = [];

    function getFuncionarioNome(id){
      if(!id) return '';
      const f = funcionarios.find(x => String(x.id) === String(id));
      return f ? f.nome : '';
    }

    function formatDateTime(dt){
      if(!dt) return '';
      try{
        const d = new Date(dt);
        if(isNaN(d.getTime())) return '';
        return d.toLocaleString('pt-PT');
      }catch{return '';}
    }

    function renderUsers(lista){
      const tbody = document.querySelector('#tblUsers tbody');
      tbody.innerHTML = lista.map(u => `
        <tr>
          <td>${(u.nome || '') + (u.sobrenome ? ' ' + u.sobrenome : '')}</td>
          <td>${u.email || ''}</td>
          <td>${u.telefone || ''}</td>
          <td>${getFuncionarioNome(u.id_funcionario)}</td>
          <td>${u.tipo || ''}</td>
          <td>${u.ativo === false ? 'Não' : 'Sim'}</td>
          <td>${formatDateTime(u.ultimo_acesso)}</td>
          <td>
            <button class="btn btn-sm btn-info btn-edit" data-id="${u.id}"><i class="fas fa-edit"></i></button>
            <button class="btn btn-sm btn-danger btn-del" data-id="${u.id}"><i class="fas fa-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    async function fetchUsers(){
      try{
        const res = await fetch('/api/users', { headers: { Authorization: `Bearer ${token}` } });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        users = Array.isArray(data) ? data : (data.items || []);
        renderUsers(users);
      }catch(e){ console.error('Erro ao carregar utilizadores', e); }
    }

    async function fetchFuncionarios(){
      try{
        const res = await fetch('/api/empresa/funcionarios', { headers: { Authorization: `Bearer ${token}` } });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        funcionarios = Array.isArray(data) ? data : (data.items || []);
        const sel = document.getElementById('user_funcionario');
        sel.innerHTML = '<option value="">(nenhum)</option>' + funcionarios.map(f => `
          <option value="${f.id}">${f.nome}</option>
        `).join('');
      }catch(e){ console.error('Erro ao carregar funcionarios para utilizadores', e); }
    }

    async function carregarUserAtual(){
      try{
        const res = await fetch('/api/users/me', { headers: { Authorization: `Bearer ${token}` } });
        if(!res.ok) {
          if(res.status === 401) window.location.href = '/';
          return;
        }
        const me = await res.json();
        currentUser = me;
        const el = document.getElementById('userName');
        if(el) el.textContent = me?.nome || 'usuário';

        // Apenas admin pode gerir utilizadores
        if(me?.tipo !== 'admin'){
          alert('Acesso permitido apenas para administradores.');
          window.location.href = 'dashboard.html';
          return;
        }

        await fetchFuncionarios();
        await fetchUsers();
      }catch(e){
        console.error('Erro ao carregar utilizador actual', e);
      }
    }
    carregarUserAtual();

    function aplicarFiltros(){
      const q = (document.getElementById('searchUser').value || '').toLowerCase();
      const tipo = document.getElementById('filterTipo').value || '';
      const filt = users.filter(u => {
        const matchesTexto = (
          ((u.nome||'') + ' ' + (u.sobrenome||'')).toLowerCase().includes(q) ||
          (u.email||'').toLowerCase().includes(q) ||
          (u.tipo||'').toLowerCase().includes(q)
        );
        const matchesTipo = !tipo || (u.tipo === tipo);
        return matchesTexto && matchesTipo;
      });
      renderUsers(filt);
    }

    document.getElementById('searchUser').addEventListener('input', aplicarFiltros);
    const filterTipoEl = document.getElementById('filterTipo');
    if(filterTipoEl){
      filterTipoEl.addEventListener('change', aplicarFiltros);
    }

    document.getElementById('btnNovoUser').addEventListener('click', () => {
      const form = document.getElementById('formUser');
      form.reset();
      document.getElementById('user_id').value = '';
      document.getElementById('senhaHint').textContent = '(obrigatória para novo utilizador)';
      $('#modalUser').modal('show');
    });

    document.getElementById('btnSalvarUser').addEventListener('click', async () => {
      const form = document.getElementById('formUser');
      if(!form.checkValidity()){
        form.reportValidity();
        return;
      }
      const id = document.getElementById('user_id').value;
      const payload = {
        nome: document.getElementById('user_nome').value,
        sobrenome: document.getElementById('user_sobrenome').value,
        email: document.getElementById('user_email').value,
        telefone: document.getElementById('user_telefone').value,
        tipo: document.getElementById('user_tipo').value,
        senha: document.getElementById('user_senha').value,
        id_funcionario: document.getElementById('user_funcionario').value || null,
        ativo: document.getElementById('user_ativo').value === 'true',
      };

      if(!id && !payload.senha){
        alert('Defina uma senha para o novo utilizador.');
        return;
      }

      try{
        let res;
        if(!id){
          res = await fetch('/api/users/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify(payload)
          });
        }else{
          if(!payload.senha){
            delete payload.senha; // não actualizar senha se vier vazia
          }
          res = await fetch(`/api/users/${encodeURIComponent(id)}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify(payload)
          });
        }

        if(!res.ok){
          const txt = await res.text();
          throw new Error(txt || ('HTTP ' + res.status));
        }
        $('#modalUser').modal('hide');
        await fetchUsers();
      }catch(e){
        alert('Erro ao salvar utilizador: ' + e.message);
      }
    });

    document.addEventListener('click', async (e) => {
      if(e.target.closest && e.target.closest('.btn-edit')){
        const btn = e.target.closest('.btn-edit');
        const id = btn.getAttribute('data-id');
        const u = users.find(x => String(x.id) === String(id));
        if(!u) return;
        document.getElementById('user_id').value = u.id;
        document.getElementById('user_nome').value = u.nome || '';
        document.getElementById('user_sobrenome').value = u.sobrenome || '';
        document.getElementById('user_email').value = u.email || '';
        document.getElementById('user_telefone').value = u.telefone || '';
        document.getElementById('user_tipo').value = u.tipo || 'cliente';
        document.getElementById('user_funcionario').value = u.id_funcionario || '';
        document.getElementById('user_ativo').value = u.ativo === false ? 'false' : 'true';
        document.getElementById('user_senha').value = '';
        document.getElementById('senhaHint').textContent = '(deixe vazio para manter a senha actual)';
        $('#modalUser').modal('show');
      }
      if(e.target.closest && e.target.closest('.btn-del')){
        const btn = e.target.closest('.btn-del');
        const id = btn.getAttribute('data-id');
        if(!confirm('Tem certeza que deseja eliminar este utilizador?')) return;
        try{
          const res = await fetch(`/api/users/${encodeURIComponent(id)}`, {
            method: 'DELETE',
            headers: { Authorization: `Bearer ${token}` }
          });
          if(!res.ok && res.status !== 204){
            const txt = await res.text();
            throw new Error(txt || ('HTTP ' + res.status));
          }
          await fetchUsers();
        }catch(e){ alert('Erro ao eliminar utilizador: ' + e.message); }
      }
    });

    fetchUsers();
  </script>
</body>
</html>
