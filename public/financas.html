<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <title>Finanças - Kwanzas Metal</title>
  <link rel="shortcut icon" type="image/x-icon" href="assets/img/logo.png">
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/fontawesome.min.css">
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="assets/css/feathericon.min.css">
  <link rel="stylesheet" href="https://cdn.oesmith.co.uk/morris-0.5.1.css">
  <link rel="stylesheet" href="assets/plugins/morris/morris.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <script>
    // Evita flash de elementos proibidos ao contabilista: esconde o HTML logo no início
    (function(){
      try{
        var uStr = localStorage.getItem('user');
        if (!uStr) return;
        var u = null;
        try { u = JSON.parse(uStr); } catch(e){}
        if (u && u.tipo === 'contabilista') {
          document.documentElement.style.visibility = 'hidden';
        }
      }catch(e){}
    })();
  </script>
  </head>
 <style>
    /* ===== MODERN PROFESSIONAL DASHBOARD STYLES ===== */
    
    /* Root Variables for Consistent Theming */
    :root {
      --primary-color: #2c3e50;
      --primary-dark: #1a252f;
      --primary-light: #34495e;
      --accent-color: #0fd7d4;
      --accent-dark: #0ab5b3;
      --secondary-color: #95a5a6;
      --dark-bg: #000000;
      --darker-bg: #000000;
      --light-bg: #f8f9fa;
      --card-bg: #ffffff;
      --text-primary: #2c3e50;
      --text-secondary: #7f8c8d;
      --border-color: #dee2e6;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 40px rgba(0,0,0,0.15);
      --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Global Styles */
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }

    /* Header Enhancements */
    .header {
      background: var(--card-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border-bottom: 1px solid var(--border-color);
    }

    .header-left {
      background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%) !important;
    }

    /* Sidebar Professional Styling - Black with Cyan */
    .sidebar {
      background: #000000 !important;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
    }

    .sidebar .sidebar-menu ul li a {
      color: #ffffff !important;
      opacity: 0.85;
      transition: var(--transition-fast);
      padding: 10px 16px;
      border-radius: 8px;
      margin: 2px 8px;
    }

    .sidebar .sidebar-menu ul li a:hover {
      color: #ffffff !important;
      opacity: 1;
      background: rgba(15, 215, 212, 0.1);
      transform: translateX(5px);
    }

    .sidebar .sidebar-menu ul li.active > a {
      color: #ffffff !important;
      font-weight: 600;
      background: rgba(15, 215, 212, 0.2);
      border-left: 3px solid #0fd7d4;
    }

    .sidebar .submenu_class li a {
      color: #f2f9ff !important;
      opacity: 0.8;
      font-size: 13px;
    }

    .sidebar .submenu_class li a:hover {
      color: #0fd7d4 !important;
      opacity: 1;
    }

    /* Sidebar submenu layout mais corporativo */
    .sidebar .sidebar-menu > ul > li > a {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .sidebar .sidebar-menu > ul > li > a i {
      margin-right: 6px;
      font-size: 15px;
      color: #ffffff !important;
    }

    .sidebar .sidebar-menu .menu-arrow {
      margin-left: auto;
      transition: transform 0.2s ease;
    }

    .sidebar .submenu.active > a .menu-arrow {
      transform: rotate(90deg);
    }

    /* Page Header */
    .page-header h1 {
      color: var(--text-primary);
      font-weight: 700;
      font-size: 28px;
      letter-spacing: -0.5px;
      margin-bottom: 0;
    }

    .page-header h1 span {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Main Metrics Card */
    .board1 {
      border-radius: 10px;
      border: none !important;
      background: #000000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: var(--transition-smooth);
      height: 150px;
      min-width: 194px;
      margin: 0 5px 15px;
      position: relative;
      flex: 0 0 auto;
    }

    .board1::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(10, 181, 179, 0.1) 0%, rgba(0, 0, 0, 0.3) 100%);
      opacity: 0;
      transition: var(--transition-smooth);
      z-index: 0;
    }

    .board1:hover {
      box-shadow: 0 8px 25px rgba(10, 181, 179, 0.4);
      transform: translateY(-5px);
    }

    .board1:hover::before {
      opacity: 1;
    }

    .board1 .card-body {
      padding: 12px 10px !important;
      position: relative;
      z-index: 1;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* Metric Cards Inside Board */
    .board1 .card-body {
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%) !important;
      border-radius: 12px;
      transition: var(--transition-smooth);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(10, 181, 179, 0.2);
    }

    .board1 .card-body::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(10, 181, 179, 0.3), transparent);
      transition: var(--transition-smooth);
    }

    .board1:hover .card-body::before {
      left: 100%;
      transition: left 0.6s ease;
    }

    .board1:hover .card-body {
      background: linear-gradient(135deg, #0ab5b3 0%, #08a09e 100%) !important;
      border-color: #0ab5b3;
      box-shadow: inset 0 0 20px rgba(10, 181, 179, 0.2);
    }

    @keyframes shimmer {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }}

    .board1 h3 {
      color: #0ab5b3 !important;
      font-weight: 700;
      margin-bottom: 3px;
      font-size: 1.2rem;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 0 0 20px rgba(10, 181, 179, 0.5);
      position: relative;
      z-index: 1;
      transition: var(--transition-smooth);
    }

    .board1:hover h3 {
      color: #fff !important;
      text-shadow: 0 0 25px rgba(255, 255, 255, 0.8);
    }

    .board1 h6 {
      color: rgba(10, 181, 179, 0.9) !important;
      font-weight: 500;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0;
      position: relative;
      z-index: 1;
      font-size: 0.7rem;
      transition: var(--transition-smooth);
    }

    .board1:hover h6 {
      color: rgba(255, 255, 255, 0.95) !important;
      letter-spacing: 1px;
    }

    .board1 i {
      position: relative;
      z-index: 1;
      color: #0ab5b3 !important;
      filter: drop-shadow(0 0 10px rgba(10, 181, 179, 0.5));
      transition: var(--transition-smooth);
    }

    .board1:hover i {
      color: #fff !important;
      filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.7));
      transform: scale(1.1);
    }

    /* Card Enhancements */
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      transition: var(--transition-smooth);
      background: var(--card-bg);
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      background: #2c3e50;
      border: none;
      border-radius: 10px 10px 0 0 !important;
      padding: 12px 20px;
    }

    .card-header h4 {
      color: #fff !important;
      margin: 0;
      font-weight: 600;
      font-size: 0.95rem;
      letter-spacing: 0.3px;
    }

    .card-body {
      padding: 24px;
    }

    /* Table Styling */
    .card-table {
      background: #ffffff !important;
      border: 1px solid rgba(10, 181, 179, 0.3);
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .card-table .card-header {
      background: linear-gradient(135deg, #0ab5b3 0%, #08a09e 100%) !important;
      border-bottom: 2px solid #0ab5b3;
    }

    .card-table .card-header h4 {
      color: #fff !important;
    }

    .card-table .card-body {
      background: #ffffff !important;
      padding: 20px;
    }

    .table {
      margin-bottom: 0;
      background: #ffffff !important;
    }

    .table thead th {
      background: #1a1a1a !important;
      color: #0ab5b3 !important;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid rgba(10, 181, 179, 0.2) !important;
      padding: 14px 12px;
    }

    .table tbody tr {
      transition: var(--transition-fast);
      background: #ffffff !important;
      border-bottom: 1px solid rgba(10, 181, 179, 0.15);
    }

    .table tbody tr:hover {
      background: rgba(10, 181, 179, 0.05) !important;
      transform: scale(1.005);
      box-shadow: 0 2px 8px rgba(10, 181, 179, 0.15);
    }

    .table tbody td {
      padding: 12px;
      vertical-align: middle;
      border-color: rgba(10, 181, 179, 0.15) !important;
      color: #2c3e50 !important;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--light-bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-secondary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-color);
    }

    /* ===== CSS ESPECÍFICO DE FINANÇAS (bancos e modais) ===== */
    .bank-card{
      background-color: #0546462f !important;
      border-radius: 100%;
    }
    .bank-logo{ background-color: transparent !important;}

    /* Modal fixes - garantir que o modal funcione corretamente */
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5) !important;
      z-index: 1040 !important;
      pointer-events: none !important; /* Permite cliques através do backdrop */
    }
    .modal {
      z-index: 1050 !important;
      pointer-events: none !important; /* Modal wrapper não captura cliques */
    }
    .modal-dialog {
      z-index: 1060 !important;
      position: relative;
      pointer-events: auto !important; /* Apenas o dialog captura cliques */
    }
    .modal-content {
      background-color: #ffffff !important;
      color: #333333 !important;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      pointer-events: auto !important; /* Garante que o conteúdo seja clicável */
    }
    .modal-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }
    .modal-title {
      color: #333333 !important;
      font-weight: 600;
    }
    .modal-body {
      background-color: #ffffff;
    }
    .modal-body label {
      color: #495057 !important;
      font-weight: 500;
    }
    .modal-body input,
    .modal-body select,
    .modal-body textarea {
      color: #495057 !important;
      background-color: #ffffff !important;
      border: 1px solid #ced4da;
    }
    .modal-footer {
      background-color: #f8f9fa;
      border-top: 1px solid #dee2e6;
    }
    .modal-open {
      overflow: hidden;
    }
    .modal.show .modal-dialog {
      transform: translate(0, 0);
    }
  </style>
<body>
  <div class="main-wrapper">
    <div class="header">
			<div class="header-left">
				<a href="dashboard.html" class="logo"> <img src="assets/img/kwanzaWhite.svg" width="50" height="70" alt="logo"> <span class="logoclass"></span> </a>
				<a href="dashboard.html" class="logo logo-small"> <img src="assets/img/kwanzaWhite.svg" alt="Logo" width="30" height="30"> </a>
			</div>
			<a href="javascript:void(0);" id="toggle_btn"> <i class="fe fe-text-align-left"></i> </a>
			<a class="mobile_btn" id="mobile_btn"> <i class="fas fa-bars"></i> </a>
			<ul class="nav user-menu">
				<li class="nav-item dropdown has-arrow">
					<a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown"> <span class="user-img"><img class="rounded-circle" src="assets/img/profiles/avatar-01.jpg" width="31" alt=""></span> </a>
					<div class="dropdown-menu">
						<div class="user-header">
							<div class="avatar avatar-sm"> <img src="foto do perfil" alt="User Image" class="avatar-img rounded-circle"> </div>
							<div class="user-text">
								<div class="muted" style="font-size:11px">Bem-vindo(a), </div>
								<h6><span id="userName">usuário</span></h6>
							</div>
						</div> <a class="dropdown-item" href="profile.html">Perfil</a> <a class="dropdown-item" href="settings.html">configurações da conta</a> <a class="dropdown-item" id="logoutBtn" href="#">Sair</a> </div>
				</li>
			</ul>
			<div class="top-nav-search">
				<form>
					<input type="text" class="form-control" placeholder="procurar">
					<button class="btn" type="submit"><i class="fas fa-search"></i></button>
				</form>
			</div>
		</div>
		<div class="sidebar" id="sidebar">
			<div class="sidebar-inner slimscroll">
				<div id="sidebar-menu" class="sidebar-menu">
					<ul>
						<li class="active"> <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a> </li>
						<li> <a href="clientes_clientes.html"><i class="fas fa-user"></i> <span>Clientes</span></a></li>
						<li class="submenu"> <a href="#"><i class="fas fa-user"></i> <span> Empresa </span> <span class="menu-arrow"></span></a>
							<ul class="submenu_class" style="display: none;">
								<li><a href="rh_funcionarios.html">Funcionários</a></li>
								<li><a href="rh_departamentos.html">Departamentos & Cargos</a></li>
								<li><a href="rh_ferias.html">Férias</a></li>
								<li><a href="users.html">Utilizadores</a></li>
							</ul>
						</li>
						
						<li> <a href="fornecedor.html"><i class="fas fa-user"></i> <span> Fornecedores</span></a> </li>
						<li class="active"> <a href="financas.html#bancos"><i class="fas fa-university"></i> <span> Bancos</span></a> </li>
						<li> <a href="financas.html#pagamentos"><i class="fas fa-money-bill-alt"></i> <span> Pagamentos</span></a> </li>
						<li> <a href="faturas.html"><i class="fas fa-file-invoice"></i> <span>Faturas</span></a> </li>
						<li> <a href="projectos.html"><i class="fas fa-cube"></i> <span>Projectos Kwanza </span></a> </li>
					</ul>
				</div>
			</div>
		</div>
		    <!-- Page content -->
    <div class="page-wrapper">
      <div class="content container-fluid">
        <div class="page-header">
          <div class="row">
            <div class="col-sm-12 mt-5">
              <h1>Finanças</h1>
              <p class="text-muted mb-0">Gestão financeira: Pagamentos, Bancos, Despesas, Impostos e Fundo</p>
            </div>
          </div>
        </div>

        <ul class="nav nav-pills mb-3" id="financeTabs" role="tablist">
          <li class="nav-item"><a class="nav-link" id="tab-faturas" data-toggle="pill" href="#faturas" role="tab">Faturas</a></li>
          <li class="nav-item"><a class="nav-link active" id="tab-pagamentos" data-toggle="pill" href="#pagamentos" role="tab">Pagamentos</a></li>
          <li class="nav-item"><a class="nav-link" id="tab-bancos" data-toggle="pill" href="#bancos" role="tab">Bancos</a></li>
        </ul>

        <div class="tab-content" id="financeTabsContent">
          <!-- Faturas -->
          <div class="tab-pane fade" id="faturas" role="tabpanel">
            <div class="row mb-3">
              <div class="col">
                <button class="btn btn-primary" id="btnNovaFatura"><i class="fas fa-file-invoice"></i> Nova Fatura</button>
                <a href="proformas.html" class="btn btn-info"><i class="fas fa-file-invoice-dollar"></i> Faturas Proforma</a>
                <button class="btn btn-outline-secondary" id="btnRecalcularFaturas">Recalcular Selecionadas</button>
                <button class="btn btn-outline-success" id="btnQuitarFaturas">Quitar</button>
              </div>
              <div class="col-auto"><input id="searchFaturas" class="form-control form-control-sm" placeholder="Pesquisar faturas..."></div>
            </div>
            <div class="card card-table">
              <div class="card-body">
                <div class="table-responsive sticky-th">
                  <table class="table table-hover table-center table-sm" id="tblFaturas">
                    <thead>
                      <tr>
                        <th>Nº</th>
                        <th>Cliente</th>
                        <th>Emissão</th>
                        <th>Vencimento</th>
                        <th>Subtotal</th>
                        <th>Impostos</th>
                        <th>Total</th>
                        <th>Pago</th>
                        <th>Em Aberto</th>
                        <th>Estado</th>
                        <th>Ações</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <!-- Pagamentos -->
          <div class="tab-pane fade show active" id="pagamentos" role="tabpanel">
            <div class="row mb-3">
              <div class="col">
                <button class="btn btn-primary" id="btnAddPagamento">Adicionar Pagamento</button>
                <button class="btn btn-outline-secondary" id="btnUploadPagamentos"><i class="fas fa-upload mr-1"></i>Upload CSV</button>
              </div>
              <div class="col-auto"><input id="searchPagamentos" class="form-control form-control-sm" placeholder="Pesquisar pagamentos..."></div>
            </div>
            <div class="card card-table">
              <div class="card-body">
                <div class="table-responsive sticky-th">
                  <table class="table table-hover table-center table-sm" id="tblPagamentos">
                    <thead>
                      <tr>
                        <th>Fatura</th>
                        <th>Fornecedor</th>
                        <th>Data</th>
                        <th>Descritivo Primavera</th>
                        <th>Classificação</th>
                        <th>Total</th>
                        <th>Pago</th>
                        <th>Em Aberto</th>
                        <th>Estado</th>
                        <th>Ações</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Bancos -->
          <div class="tab-pane fade" id="bancos" role="tabpanel">
            <div class="row mb-3">
              <div class="col">
                <button class="btn btn-primary" id="btnAddBanco">Adicionar Banco</button>
              </div>
              <div class="col-auto"><input id="searchBancos" class="form-control form-control-sm" placeholder="Pesquisar bancos..."></div>
            </div>
            <style>
              .bank-card{ 
                cursor: pointer; 
                transition: all 0.3s ease; 
                background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%) !important;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(6, 111, 227, 0.2) !important;
                border-radius: 16px !important;
                box-shadow: 0 4px 15px rgba(0,0,0,0.08);
                overflow: hidden;
              }
              .bank-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, #066fe3, #0a8fef, #22c55e);
              }
              .bank-card:hover{ 
                box-shadow: 0 8px 30px rgba(6, 111, 227, 0.25);
                transform: translateY(-8px) scale(1.02);
                border-color: rgba(6, 111, 227, 0.4) !important;
              }
              .bank-logo-lg{ 
                width: 100px; 
                height: 100px; 
                object-fit: contain; 
                border-radius: 50%;
                border: 3px solid rgba(6, 111, 227, 0.1);
                background: linear-gradient(135deg, #ffffff, #f8f9fa);
                padding: 15px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                transition: all 0.3s ease;
              }
              .bank-card:hover .bank-logo-lg {
                transform: scale(1.1) rotate(5deg);
                border-color: rgba(6, 111, 227, 0.3);
              }
              .bank-actions{ 
                position: relative; 
                z-index: 2; 
                margin-top: auto;
                padding-top: 15px;
              }
              .bank-card .card-body {
                padding: 25px 20px;
                min-height: 280px;
              }
              .bank-card h5 {
                color: #066fe3;
                font-weight: 600;
                font-size: 1.1rem;
                margin-bottom: 8px;
              }
              .bank-card .text-muted {
                color: #6c757d !important;
                font-size: 0.95rem;
                font-weight: 500;
              }
              .bank-card .btn {
                border-radius: 8px;
                font-size: 0.85rem;
                padding: 6px 14px;
                font-weight: 500;
                transition: all 0.2s ease;
              }
              .bank-card .btn-outline-primary:hover {
                background: #066fe3;
                transform: translateY(-2px);
              }
              .bank-card .btn-outline-danger:hover {
                background: #dc3545;
                transform: translateY(-2px);
              }
            </style>
            <div class="row" id="gridBancosFin">
              <!-- Cards renderizados por JS -->
            </div>
          </div>

          <!-- Despesas -->
          <div class="tab-pane fade" id="despesas" role="tabpanel">
            <div class="row mb-3">
              <div class="col">
                <button class="btn btn-primary" id="btnAddDespesa">Adicionar Despesa</button>
              </div>
              <div class="col-auto"><input id="searchDespesas" class="form-control form-control-sm" placeholder="Pesquisar despesas..."></div>
            </div>
            <div class="card card-table">
              <div class="card-body">
                <div class="table-responsive sticky-th">
                  <table class="table table-hover table-center table-sm" id="tblDespesas">
                    <thead>
                      <tr>
                        <th>Data</th>
                        <th>Categoria</th>
                        <th>Descrição</th>
                        <th>Valor</th>
                        <th>Centro de Custo</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Impostos -->
          <div class="tab-pane fade" id="impostos" role="tabpanel">
            <div class="row mb-3">
              <div class="col">
                <button class="btn btn-primary" id="btnAddImposto">Registrar Imposto</button>
              </div>
              <div class="col-auto"><input id="searchImpostos" class="form-control form-control-sm" placeholder="Pesquisar impostos..."></div>
            </div>
            <div class="card card-table">
              <div class="card-body">
                <div class="table-responsive sticky-th">
                  <table class="table table-hover table-center table-sm" id="tblImpostos">
                    <thead>
                      <tr>
                        <th>Período</th>
                        <th>Imposto</th>
                        <th>Base</th>
                        <th>Valor</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Fundo -->
          <div class="tab-pane fade" id="fundo" role="tabpanel">
            <div class="row mb-3">
              <div class="col">
                <button class="btn btn-primary" id="btnAddFundo">Movimentar Fundo</button>
              </div>
              <div class="col-auto"><input id="searchFundo" class="form-control form-control-sm" placeholder="Pesquisar fundo..."></div>
            </div>
            <div class="card card-table">
              <div class="card-body">
                <div class="table-responsive sticky-th">
                  <table class="table table-hover table-center table-sm" id="tblFundo">
                    <thead>
                      <tr>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Descrição</th>
                        <th>Valor</th>
                        <th>Saldo</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="assets/js/jquery-3.5.1.min.js"></script>
  <script src="assets/js/popper.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <script src="assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/script.js"></script>
  <!-- Carrega o avatar do usuário -->
  <script src="js/profile-avatar.js"></script>
  <style>
    .alerts-container{ position: fixed; top: 70px; right: 16px; z-index: 1080; width: 320px; }
  </style>
  <div class="alerts-container" id="alertsContainer"></div>
  <script>
    async function checkAuth(){
      const token = localStorage.getItem('token');
      if (!token) { window.location.href = '/'; return; }
      try {
        const res = await fetch('/api/users/me', { headers: { Authorization: `Bearer ${token}` } });
        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/';
          return;
        }
        if (!res.ok) throw new Error('server_error');
        const me = await res.json();
        const userName = document.getElementById('userName');
        if (userName) userName.textContent = me?.nome || 'usuário';
      } catch {}
    }
    checkAuth();

    function showAlert(message, variant = 'success', timeout = 3000){
      const container = document.getElementById('alertsContainer');
      if(!container) return window.alert(message);
      const id = 'al_'+Date.now()+Math.random().toString(16).slice(2);
      const el = document.createElement('div');
      el.id = id;
      el.className = `alert alert-${variant} alert-dismissible fade show mb-2`;
      el.role = 'alert';
      el.innerHTML = `
        <div>${message}</div>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>`;
      container.appendChild(el);
      if(timeout){ setTimeout(() => { try{ $(el).alert('close'); }catch{} el.remove(); }, timeout); }
    }

    // Dados mock para cada aba
    const state = { pagamentos: [], bancos: [], despesas: [], impostos: [], fundo: [] };

    function renderTabela(id, rows, mapCols){
      const tbody = document.querySelector(`#${id} tbody`);
      tbody.innerHTML = rows.map(r => `<tr>${mapCols(r)}</tr>`).join('');
    }

    // Pesquisa simples por aba
    function attachSearch(inputId, keyList, sourceKey, tableId, mapCols){
      const input = document.getElementById(inputId);
      input.addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        const base = state[sourceKey];
        const filt = base.filter(r => keyList.some(k => (String(r[k]||'')).toLowerCase().includes(q)));
        renderTabela(tableId, filt, mapCols);
      });
    }

    // Inicialização das tabelas vazias
    renderTabela('tblPagamentos', state.pagamentos, r => {
      const total = Number(r.valor_documento || r.total || 0);
      const valorPago = Number(r.valor_pago || 0);
      const divida = ('divida' in r) ? Number(r.divida || 0) : (total - valorPago);
      const podePagar = divida > 0.000001; // evita problemas de arredondamento
      const numFat = (r.num_factura || r.numero || '').toString();
      const fornecedor = r.nome || r.fornecedor || r.cliente || '';
      const estado = r.situacao || r.estado || (podePagar ? 'Pendente' : 'PAGA');
      const btns = podePagar
        ? `<div class="btn-group btn-group-sm">
             <button class="btn btn-primary" onclick="pagarFatura('${r.id || r._id}', ${divida}, '${numFat.replace(/'/g, "\\'")}', '${fornecedor.replace(/'/g, "\\'")}')">Pagar fatura</button>
             <button class="btn btn-outline-secondary" type="button" onclick="verPagamento('${r.id || r._id}')">Ver</button>
           </div>`
        : `<div class="btn-group btn-group-sm">
             <button class="btn btn-outline-secondary" type="button" onclick="verPagamento('${r.id || r._id}')">Ver</button>
           </div>`;
      return `
        <td>${numFat}</td>
        <td>${fornecedor}</td>
        <td>${r.data || ''}</td>
        <td>${r.descritivo_primavera || r.descritivoPrimavera || ''}</td>
        <td>${r.classificacao || ''}</td>
        <td>${total.toLocaleString('pt-PT', {minimumFractionDigits: 2})} Kz</td>
        <td>${valorPago.toLocaleString('pt-PT', {minimumFractionDigits: 2})} Kz</td>
        <td>${divida.toLocaleString('pt-PT', {minimumFractionDigits: 2})} Kz</td>
        <td><span class="badge badge-${getEstadoBadgeClass(estado)}">${estado}</span></td>
        <td>${btns}</td>`;
    });
    renderTabela('tblDespesas', state.despesas, r => `
      <td>${r.data||''}</td><td>${r.categoria||''}</td><td>${r.desc||''}</td><td>${r.valor||''}</td><td>${r.centro||''}</td>`);
    renderTabela('tblImpostos', state.impostos, r => `
      <td>${r.periodo||''}</td><td>${r.imposto||''}</td><td>${r.base||''}</td><td>${r.valor||''}</td><td>${r.status||''}</td>`);
    renderTabela('tblFundo', state.fundo, r => `
      <td>${r.data||''}</td><td>${r.tipo||''}</td><td>${r.desc||''}</td><td>${r.valor||''}</td><td>${r.saldo||''}</td>`);

    // Vínculo de pesquisas (busca em número, fornecedor/nome e situação)
    attachSearch('searchPagamentos', ['num_factura','nome','fornecedor','situacao'], 'pagamentos', 'tblPagamentos', r => ``);
    // Pesquisa de bancos aplicada à grelha de cards
    document.getElementById('searchBancos').addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase();
      const filt = state.bancos.filter(r => (
        (r.banco||'').toLowerCase().includes(q) ||
        (r.agencia||'').toLowerCase().includes(q) ||
        (r.conta||'').toLowerCase().includes(q) ||
        (r.iban||'').toLowerCase().includes(q)
      ));
      renderBancosCards(filt);
    });
    attachSearch('searchDespesas', ['data','categoria','desc','valor','centro'], 'despesas', 'tblDespesas', r => ``);
    attachSearch('searchImpostos', ['periodo','imposto','valor','status'], 'impostos', 'tblImpostos', r => ``);
    attachSearch('searchFundo', ['data','tipo','desc','valor'], 'fundo', 'tblFundo', r => ``);

    // Seleciona a aba pela hash da URL
    function selectTabFromHash(){
      const hash = window.location.hash || '#pagamentos';
      const link = document.querySelector(`a[href='${hash}']`);
      if (link) link.click();
    }
    window.addEventListener('hashchange', selectTabFromHash);
    // Inicialização movida para após definição das funções
  </script>
  <script>
    function toBase64(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Abrir modal
    document.getElementById('btnAddBanco').addEventListener('click', () => {
      $('#modalAddBanco').modal('show');
    });

    // Utilitário simples para converter valores monetários em número (suporta formatos com vírgula/ponto)
    function toNumFinancas(v){
      if (v === null || v === undefined || v === '') return 0;
      let s = String(v).trim();
      if (!s) return 0;
      s = s.replace(/\s+/g, '');
      if (s.includes(',')){
        const isNeg = s.startsWith('-');
        s = s.replace(/[^0-9.,]/g, '');
        s = s.replace(/\./g, '');
        s = s.replace(',', '.');
        if (isNeg && !s.startsWith('-')) s = '-' + s;
      }else{
        s = s.replace(/[^0-9.-]/g, '');
      }
      const n = Number(s);
      return isFinite(n) ? n : 0;
    }

    // Renderização de cards de bancos
    function bancoCardTemplate(b){
      const logoCandidate = b.logo || b.logoUrl || b.logoPath || b.logo_path || b.image || b.imageUrl || b.photo;
      let logo = logoCandidate && typeof logoCandidate === 'string' && logoCandidate.trim() !== ''
        ? logoCandidate.trim()
        : 'assets/img/logo.png';
      // Se o backend retornar caminho relativo, montar URL absoluta
      const isAbsolute = /^(https?:)?\/\//i.test(logo) || logo.startsWith('data:');
      if (!isAbsolute && logo !== 'assets/img/logo.png') {
        if (logo.startsWith('/')) {
          logo = window.location.origin + logo;
        } else {
          logo = window.location.origin + '/' + logo.replace(/^\.*\/?/, '');
        }
      }
      // Saldo inicial do registo de banco (será refinado depois com base no extrato)
      const saldoFmt = (b.saldo != null)
        ? Number(b.saldo).toLocaleString('pt-PT', { style:'currency', currency:'AOA'})
        : '';
      return `
        <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
          <div class="card bank-card h-100" data-id="${b.id}">
            <div class="card-body d-flex flex-column align-items-center text-center position-relative">
              <img class="bank-logo-lg mb-2" src="${logo}" alt="${b.banco||''}">
              <h5 class="mb-1">${b.banco||''}</h5>
              <div class="text-muted">Saldo: <span class="saldo-card" data-banco-id="${b.id}">${saldoFmt}</span></div>
              <div class="mt-2 bank-actions">
                <button type="button" class="btn btn-sm btn-outline-primary btn-edit-banco" data-id="${b.id}">Editar</button>
                <button type="button" class="btn btn-sm btn-outline-danger btn-del-banco" data-id="${b.id}">Eliminar</button>
              </div>
              <a href="#" class="stretched-link" onclick="return navegarBancoDetalhe(${b.id}, event)"></a>
            </div>
          </div>
        </div>`;
    }

    function renderBancosCards(items){
      const grid = document.getElementById('gridBancosFin');
      grid.innerHTML = items.map(bancoCardTemplate).join('');
      // Após renderizar, sincronizar saldos com o último lançamento do extrato de cada banco
      sincronizarSaldosCardsComExtrato(items);
    }

    async function sincronizarSaldosCardsComExtrato(bancos){
      if (!Array.isArray(bancos) || bancos.length === 0) return;
      for (const b of bancos) {
        if (!b || !b.id) continue;
        try{
          const extrato = await API.getJSON(`/api/financas/bancos/${encodeURIComponent(b.id)}/extrato`);
          if (Array.isArray(extrato) && extrato.length > 0) {
            // Aplica a mesma regra de banco_detalhe.html:
            // saldoFinal = saldoInicialDoBanco - somaTotalDeDébitos (ignorando créditos)
            const saldoInicial = (b.saldo != null) ? Number(b.saldo) : 0;
            let totalDebitos = 0;
            extrato.forEach(l => {
              const saidasStr = (l.saidasTexto != null && l.saidasTexto !== '')
                ? l.saidasTexto
                : (l.saidas != null ? l.saidas : '');
              const saidasVal = Math.abs(toNumFinancas(saidasStr));
              totalDebitos += saidasVal;
            });
            const saldoFinal = saldoInicial - totalDebitos;

            const span = document.querySelector(`.saldo-card[data-banco-id='${b.id}']`);
            if (span) {
              span.textContent = saldoFinal.toLocaleString('pt-PT', {
                style: 'currency',
                currency: 'AOA',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              });
            }
          }
        }catch(e){ console.error('Erro ao sincronizar saldo do card do banco', b.id, e); }
      }
    }

    // Carregar bancos da API
    async function fetchBancos(){
      try{
        const res = await API.getJSON('/api/financas/bancos');
        state.bancos = Array.isArray(res) ? res : (res?.items || []);
        renderBancosCards(state.bancos);
      }catch(e){ console.error('Erro ao carregar bancos', e); }
    }

    // ---------- PAGAMENTOS (FATURAS DE FORNECEDORES) ----------
    async function fetchPagamentos(){
      try{
        const res = await API.getJSON('/api/fornecedores');
        let itens = Array.isArray(res) ? res : (res?.items || []);

        // Mantém todas as faturas de fornecedores
        state.pagamentos = itens;
        renderTabela('tblPagamentos', state.pagamentos, r => {
          const total = Number(r.valor_documento || r.total || 0);
          const valorPago = Number(r.valor_pago || 0);
          const divida = ('divida' in r) ? Number(r.divida || 0) : (total - valorPago);
          const podePagar = divida > 0.000001;
          const numFat = (r.num_factura || r.numero || '').toString();
          const fornecedor = r.nome || r.fornecedor || r.cliente || '';
          const estado = r.situacao || r.estado || (podePagar ? 'Pendente' : 'PAGA');
          const btns = podePagar
            ? `<div class="btn-group btn-group-sm">
                 <button class="btn btn-primary" onclick="pagarFatura('${r.id || r._id}', ${divida}, '${numFat.replace(/'/g, "\\'")}', '${fornecedor.replace(/'/g, "\\'")}')">Pagar fatura</button>
                 <button class="btn btn-outline-secondary" type="button" onclick="verPagamento('${r.id || r._id}')">Ver</button>
               </div>`
            : `<div class="btn-group btn-group-sm">
                 <button class="btn btn-outline-secondary" type="button" onclick="verPagamento('${r.id || r._id}')">Ver</button>
               </div>`;
          return `
            <td>${numFat}</td>
            <td>${fornecedor}</td>
            <td>${r.data || ''}</td>
            <td>${total.toLocaleString('pt-PT', {minimumFractionDigits: 2})} Kz</td>
            <td>${valorPago.toLocaleString('pt-PT', {minimumFractionDigits: 2})} Kz</td>
            <td>${divida.toLocaleString('pt-PT', {minimumFractionDigits: 2})} Kz</td>
            <td><span class="badge badge-${getEstadoBadgeClass(estado)}">${estado}</span></td>
            <td>${btns}</td>`;
        });
      }catch(e){ console.error('Erro ao carregar pagamentos (fornecedores)', e); }
    }

    function pagarFatura(id, emAberto, numero, cliente){
      const form = document.getElementById('formAddPagamento');
      if (!form) return;
      form.reset();

      const valorInput = form.querySelector('input[name="valor"]');
      const refInput = form.querySelector('input[name="ref"]');
      const faturaIdInput = form.querySelector('input[name="faturaId"]');
      const numFatInput = form.querySelector('input[name="numeroFatura"]');
      const fatDisplay = form.querySelector('input[name="faturaDisplay"]');
      const cliDisplay = form.querySelector('input[name="clienteDisplay"]');
      const dataInput = form.querySelector('input[name="data"]');

      if (valorInput && emAberto != null) {
        const v = Number(emAberto) || 0;
        valorInput.value = v.toFixed ? v.toFixed(2) : v;
      }
      if (refInput) {
        refInput.value = numero ? `Pagamento fatura ${numero}` : 'Pagamento de fatura';
      }
      if (faturaIdInput) faturaIdInput.value = id || '';
      if (numFatInput) numFatInput.value = numero || '';
      if (fatDisplay) fatDisplay.value = numero || '';
      if (cliDisplay) cliDisplay.value = cliente || '';
      if (dataInput && !dataInput.value){
        dataInput.value = new Date().toISOString().split('T')[0];
      }

      $('#modalAddPagamento').modal('show');
    }

    window.verPagamento = function(id){
      if (!id) return;
      const rec = state.pagamentos.find(r => String(r.id || r._id) === String(id));
      if (!rec) return;

      const total = Number(rec.valor_documento || rec.total || 0);
      const valorPago = Number(rec.valor_pago || 0);
      const divida = ('divida' in rec) ? Number(rec.divida || 0) : (total - valorPago);
      const podePagar = divida > 0.000001;
      const numFat = (rec.num_factura || rec.numero || '').toString();
      const fornecedor = rec.nome || rec.fornecedor || rec.cliente || '';
      const estadoTexto = podePagar ? 'Não paga' : 'Fatura paga';
      const data = rec.data || '';

      const elNum = document.getElementById('detFatNumero');
      const elFor = document.getElementById('detFatFornecedor');
      const elData = document.getElementById('detFatData');
      const elTotal = document.getElementById('detFatTotal');
      const elPago = document.getElementById('detFatPago');
      const elAberto = document.getElementById('detFatAberto');
      const elEstado = document.getElementById('detFatEstado');

      if (elNum) elNum.textContent = numFat || '-';
      if (elFor) elFor.textContent = fornecedor || '-';
      if (elData) elData.textContent = data || '-';
      if (elTotal) elTotal.textContent = total.toLocaleString('pt-PT', {minimumFractionDigits: 2}) + ' Kz';
      if (elPago) elPago.textContent = valorPago.toLocaleString('pt-PT', {minimumFractionDigits: 2}) + ' Kz';
      if (elAberto) elAberto.textContent = divida.toLocaleString('pt-PT', {minimumFractionDigits: 2}) + ' Kz';
      if (elEstado) {
        elEstado.textContent = estadoTexto;
        elEstado.className = 'badge ' + (podePagar ? 'badge-danger' : 'badge-success');
      }

      const btnPagar = document.getElementById('btnDetalhePagar');
      if (btnPagar){
        if (podePagar){
          btnPagar.style.display = 'inline-block';
          btnPagar.dataset.id = rec.id || rec._id || '';
          btnPagar.dataset.divida = String(divida);
          btnPagar.dataset.numero = numFat;
          btnPagar.dataset.fornecedor = fornecedor;
        } else {
          btnPagar.style.display = 'none';
          btnPagar.dataset.id = '';
          btnPagar.dataset.divida = '';
          btnPagar.dataset.numero = '';
          btnPagar.dataset.fornecedor = '';
        }
      }

      $('#modalDetalhePagamento').modal('show');
    };

    window.pagarFaturaFromDetalhe = function(){
      const btn = document.getElementById('btnDetalhePagar');
      if (!btn) return;
      const id = btn.dataset.id;
      if (!id) return;
      const divida = Number(btn.dataset.divida || 0);
      const numero = btn.dataset.numero || '';
      const fornecedor = btn.dataset.fornecedor || '';
      pagarFatura(id, divida, numero, fornecedor);
    };

    (function(){
      const btn = document.getElementById('btnAddPagamento');
      if (btn) btn.addEventListener('click', () => { $('#modalAddPagamento').modal('show'); });
    })();

    document.addEventListener('click', async (e) => {
      if(e.target && e.target.id === 'btnSalvarPagamento'){
        const form = document.getElementById('formAddPagamento');
        const fd = new FormData(form);
        const payload = Object.fromEntries(fd.entries());
        try{
          await API.postJSON('/api/financas/pagamentos', payload);
          $('#modalAddPagamento').modal('hide'); form.reset();
          await fetchPagamentos();
          await fetchFaturas();
          showAlert('Pagamento adicionado!', 'success');
        }catch(err){ showAlert('Erro ao salvar pagamento: ' + (err?.message||'desconhecido'), 'danger', 5000); }
      }
    });

    // ---------- DESPESAS ----------
    async function fetchDespesas(){
      try{
        const res = await API.getJSON('/api/financas/despesas');
        const items = Array.isArray(res) ? res : (res?.items || []);
        state.despesas = items;
        renderTabela('tblDespesas', state.despesas, r => `
          <td>${r.data||''}</td><td>${r.categoria||''}</td><td>${r.descricao||''}</td><td>${r.valor||''}</td><td>${r.centro||''}</td>`);
      }catch(e){ console.error('Erro ao carregar despesas', e); }
    }

    (function(){
      const btn = document.getElementById('btnAddDespesa');
      if (btn) btn.addEventListener('click', () => { $('#modalAddDespesa').modal('show'); });
    })();

    document.addEventListener('click', async (e) => {
      if(e.target && e.target.id === 'btnSalvarDespesa'){
        const form = document.getElementById('formAddDespesa');
        const fd = new FormData(form);
        const payload = Object.fromEntries(fd.entries());
        try{
          await API.postJSON('/api/financas/despesas', payload);
          $('#modalAddDespesa').modal('hide'); form.reset();
          await fetchDespesas();
          showAlert('Despesa adicionada!', 'success');
        }catch(err){ showAlert('Erro ao salvar despesa: ' + (err?.message||'desconhecido'), 'danger', 5000); }
      }
    });

    // ---------- IMPOSTOS ----------
    async function fetchImpostos(){
      try{
        const res = await API.getJSON('/api/financas/impostos');
        const items = Array.isArray(res) ? res : (res?.items || []);
        state.impostos = items;
        renderTabela('tblImpostos', state.impostos, r => `
          <td>${r.periodo||''}</td><td>${r.imposto||''}</td><td>${r.base||''}</td><td>${r.valor||''}</td><td>${r.status||''}</td>`);
      }catch(e){ console.error('Erro ao carregar impostos', e); }
    }

    (function(){
      const btn = document.getElementById('btnAddImposto');
      if (btn) btn.addEventListener('click', () => { $('#modalAddImposto').modal('show'); });
    })();

    document.addEventListener('click', async (e) => {
      if(e.target && e.target.id === 'btnSalvarImposto'){
        const form = document.getElementById('formAddImposto');
        const fd = new FormData(form);
        const payload = Object.fromEntries(fd.entries());
        try{
          await API.postJSON('/api/financas/impostos', payload);
          $('#modalAddImposto').modal('hide'); form.reset();
          await fetchImpostos();
          showAlert('Imposto registado!', 'success');
        }catch(err){ showAlert('Erro ao salvar imposto: ' + (err?.message||'desconhecido'), 'danger', 5000); }
      }
    });

    // ---------- FUNDO ----------
    async function fetchFundo(){
      try{
        const res = await API.getJSON('/api/financas/fundo');
        const items = Array.isArray(res) ? res : (res?.items || []);
        state.fundo = items;
        renderTabela('tblFundo', state.fundo, r => `
          <td>${r.data||''}</td><td>${r.tipo||''}</td><td>${r.desc||''}</td><td>${r.valor||''}</td><td>${r.saldo||''}</td>`);
      }catch(e){ console.error('Erro ao carregar fundo', e); }
    }

    (function(){
      const btn = document.getElementById('btnAddFundo');
      if (btn) btn.addEventListener('click', () => { $('#modalAddFundo').modal('show'); });
    })();

    document.addEventListener('click', async (e) => {
      if(e.target && e.target.id === 'btnSalvarFundo'){
        const form = document.getElementById('formAddFundo');
        const fd = new FormData(form);
        const payload = Object.fromEntries(fd.entries());
        try{
          await API.postJSON('/api/financas/fundo', payload);
          $('#modalAddFundo').modal('hide'); form.reset();
          await fetchFundo();
          showAlert('Movimentação de fundo registada!', 'success');
        }catch(err){ showAlert('Erro ao salvar movimentação: ' + (err?.message||'desconhecido'), 'danger', 5000); }
      }
    });

    // Salvar Banco no backend (multipart, com logo)
    document.addEventListener('click', async (e) => {
      if(e.target && e.target.id === 'btnSalvarBanco'){
        const form = document.getElementById('formAddBanco');
        const fd = new FormData(form);
        // O backend usa multer.single('logo_file'), portanto só devemos enviar esse campo de ficheiro
        // Normalizar saldo para número
        const saldoRaw = fd.get('saldo');
        if (saldoRaw != null) {
          const num = parseFloat(String(saldoRaw).toString().replace(',', '.'));
          if (!isNaN(num)) { fd.set('saldo', String(num)); }
        }
        try{
          await API.postForm('/api/financas/bancos', fd);
          await fetchBancos();
          $('#modalAddBanco').modal('hide');
          form.reset();
          document.getElementById('bancoLogoPreview').src = '';
          document.getElementById('bancoLogoPreview').style.display = 'none';
        }catch(err){
          alert('Erro ao salvar banco: ' + err.message);
        }
      }
    });

    // Ao clicar num cartão de banco, navegar para a página de detalhe do banco
    document.addEventListener('click', (e) => {
      const isAction = e.target.closest && e.target.closest('.bank-actions');
      if (isAction) return;
      const card = e.target.closest && e.target.closest('.bank-card');
      if(card){
        const id = Number(card.getAttribute('data-id'));
        if(!id) return;
        const path = window.location.pathname;
        const base = path.includes('/public/') ? '/public' : '';
        const url = `${base}/banco_detalhe.html?id=${encodeURIComponent(id)}`;
        window.location.href = url;
        return;
      }
    });

    // Helper para navegação direta via links nos cards
    window.navegarBancoDetalhe = function(id, event){
      if(event){ event.preventDefault(); event.stopPropagation(); }
      if(!id) return false;
      const path = window.location.pathname;
      const base = path.includes('/public/') ? '/public' : '';
      const url = `${base}/banco_detalhe.html?id=${encodeURIComponent(id)}`;
      window.location.href = url;
      return false;
    }

    // Editar Banco: abrir modal e preencher
    document.addEventListener('click', (e) => {
      const btn = e.target.closest && e.target.closest('.btn-edit-banco');
      if(!btn) return;
      const id = Number(btn.getAttribute('data-id'));
      const b = state.bancos.find(x => Number(x.id) === id);
      if(!b) return;
      const form = document.getElementById('formEditBanco');
      form.dataset.id = String(id);
      form.elements['banco'].value = b.banco || '';
      form.elements['agencia'].value = b.agencia || '';
      form.elements['conta'].value = b.conta || '';
      form.elements['iban'].value = b.iban || '';
      form.elements['saldo'].value = b.saldo != null ? Number(b.saldo) : '';
      $('#modalEditBanco').modal('show');
    });

    // Guardar edição de Banco
    document.addEventListener('click', async (e) => {
      if(e.target && e.target.id === 'btnSalvarBancoEdit'){
        const form = document.getElementById('formEditBanco');
        const id = form.dataset.id;
        const fd = new FormData(form);
        const payload = Object.fromEntries(fd.entries());
        try{
          await API.putJSON(`/api/financas/bancos/${id}`, payload);
          $('#modalEditBanco').modal('hide');
          await fetchBancos();
          showAlert('Banco actualizado!', 'success');
        }catch(err){ showAlert('Erro ao actualizar banco: ' + (err?.message||'desconhecido'), 'danger', 5000); }
      }
    });

    // Eliminar Banco
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest && e.target.closest('.btn-del-banco');
      if(!btn) return;
      const id = Number(btn.getAttribute('data-id'));
      if(!confirm('Tem certeza que deseja eliminar este banco?')) return;
      try{
        await API.del(`/api/financas/bancos/${id}`);
        await fetchBancos();
        showAlert('Banco eliminado!', 'success');
      }catch(err){ showAlert('Erro ao eliminar banco: ' + (err?.message||'desconhecido'), 'danger', 5000); }
    });

    // Preview do logo
    document.addEventListener('change', async (e) => {
      if(e.target && e.target.id === 'logo_file'){
        const file = e.target.files[0];
        const img = document.getElementById('bancoLogoPreview');
        if(file){
          img.src = await toBase64(file);
          img.style.display = 'block';
        } else {
          img.src = '';
          img.style.display = 'none';
        }
      }
    });

    // ========== FATURAS ==========
    function parseNumeroFatura(str){
      const s = (str||'').toString();
      const m = s.match(/(\d+)/);
      return m ? parseInt(m[1], 10) : null;
    }

    function formatNumeroFatura(n){
      return 'FAT' + String(n).padStart(4, '0');
    }

    (function(){
      const btn = document.getElementById('btnNovaFatura');
      if (btn) btn.addEventListener('click', () => {
        const form = document.getElementById('formNovaFatura');
        if (form) form.reset();
        const hoje = new Date().toISOString().split('T')[0];
        const elData = document.querySelector('#formNovaFatura input[name="dataEmissao"]');
        if (elData) elData.value = hoje;
        const elNumero = document.querySelector('#formNovaFatura input[name="numero"]');
        if (elNumero){
          if (window.__nextFaturaNumero && typeof window.__nextFaturaNumero === 'string'){
            elNumero.value = window.__nextFaturaNumero;
          } else {
            elNumero.value = formatNumeroFatura(1);
          }
        }
        $('#modalNovaFatura').modal('show');
      });
    })();

    // Calcular total automaticamente quando subtotal ou impostos mudam
    const calcularTotalFatura = () => {
      const subtotalEl = document.querySelector('#formNovaFatura input[name="subtotal"]');
      const impostosEl = document.querySelector('#formNovaFatura input[name="impostos"]');
      const totalEl = document.querySelector('#formNovaFatura input[name="total"]');
      
      if (subtotalEl && impostosEl && totalEl) {
        const subtotal = parseFloat(subtotalEl.value) || 0;
        const impostos = parseFloat(impostosEl.value) || 0;
        const total = subtotal + impostos;
        totalEl.value = total.toFixed(2);
      }
    };

    const subtotalFaturaEl = document.querySelector('#formNovaFatura input[name="subtotal"]');

    // Salvar nova fatura
    (function(){
      const btn = document.getElementById('btnSalvarFatura');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        const form = document.getElementById('formNovaFatura');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const formData = new FormData(form);
        const fatura = {
          numero: formData.get('numero'),
          cliente: formData.get('cliente'),
          dataEmissao: formData.get('dataEmissao'),
          dataVencimento: formData.get('dataVencimento'),
          subtotal: parseFloat(formData.get('subtotal')) || 0,
          impostos: parseFloat(formData.get('impostos')) || 0,
          total: parseFloat(formData.get('total')) || 0,
          valorPago: parseFloat(formData.get('valorPago')) || 0,
          estado: formData.get('estado'),
          descricao: formData.get('descricao') || ''
        };

        // Calcular valor em aberto
        fatura.emAberto = fatura.total - fatura.valorPago;

        try {
          const token = localStorage.getItem('token');
          const response = await fetch('/api/faturas', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(fatura)
          });

          if (response.ok) {
            alert('Fatura adicionada com sucesso!');
            $('#modalNovaFatura').modal('hide');
            fetchFaturas(); // Recarregar lista de faturas
          } else {
            const error = await response.json();
            alert('Erro ao adicionar fatura: ' + (error.message || 'Erro desconhecido'));
          }
        } catch (error) {
          console.error('Erro ao salvar fatura:', error);
          alert('Erro ao salvar fatura. Verifique a conexão.');
        }
      });
    })();

    // Função para buscar e exibir faturas (apenas não pagas) e calcular próximo número
    async function fetchFaturas() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/faturas', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const faturas = await response.json(); // usar todas as faturas (pagas e não pagas)

          const tbody = document.querySelector('#tblFaturas tbody');
          tbody.innerHTML = '';

          let maxNum = 0;

          faturas.forEach(f => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${f.numero || ''}</td>
              <td>${f.cliente || ''}</td>
              <td>${f.dataEmissao ? new Date(f.dataEmissao).toLocaleDateString('pt-PT') : ''}</td>
              <td>${f.dataVencimento ? new Date(f.dataVencimento).toLocaleDateString('pt-PT') : ''}</td>
              <td>${(f.subtotal || 0).toLocaleString('pt-PT', {minimumFractionDigits: 2})} Kz</td>
              <td>${(f.impostos || 0).toLocaleString('pt-PT', {minimumFractionDigits: 2})} Kz</td>
              <td><strong>${(f.total || 0).toLocaleString('pt-PT', {minimumFractionDigits: 2})} Kz</strong></td>
              <td>${(f.valorPago || 0).toLocaleString('pt-PT', {minimumFractionDigits: 2})} Kz</td>
              <td>${(f.emAberto || 0).toLocaleString('pt-PT', {minimumFractionDigits: 2})} Kz</td>
              <td><span class="badge badge-${getEstadoBadgeClass(f.estado)}">${f.estado || 'Pendente'}</span></td>
              <td>
                <button class="btn btn-sm btn-success mr-1" onclick="pagarFatura('${f._id}', ${Number(f.emAberto||0)}, '${(f.numero||'').replace(/'/g, "\\'")}', '${(f.cliente||'').replace(/'/g, "\\'")}')"><i class="fas fa-money-bill-wave"></i></button>
                <button class="btn btn-sm btn-info" onclick="editarFatura('${f._id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deletarFatura('${f._id}')"><i class="fas fa-trash"></i></button>
              </td>
            `;
            tbody.appendChild(tr);

            const parsed = parseNumeroFatura(f.numero);
            if (parsed && parsed > maxNum) maxNum = parsed;
          });

          const next = maxNum + 1;
          window.__nextFaturaNumero = formatNumeroFatura(next);
        }
      } catch (error) {
        console.error('Erro ao buscar faturas:', error);
      }
    }

    // Função auxiliar para classe do badge de estado
    function getEstadoBadgeClass(estado) {
      switch(estado) {
        case 'Pago': return 'success';
        case 'Pendente': return 'warning';
        case 'Parcialmente Pago': return 'info';
        case 'Vencido': return 'danger';
        case 'Cancelado': return 'secondary';
        case 'Aprovada': return 'success';
        case 'Convertida': return 'primary';
        case 'Expirada': return 'danger';
        case 'Cancelada': return 'secondary';
        default: return 'secondary';
      }
    }

    // ========== FATURAS PROFORMA ==========
    // Abrir modal Nova Proforma
    (function(){
      const btn = document.getElementById('btnNovaProforma');
      if (btn) btn.addEventListener('click', () => {
        const form = document.getElementById('formNovaProforma');
        if (form) form.reset();
        const hoje = new Date().toISOString().split('T')[0];
        const elData = document.querySelector('#formNovaProforma input[name="dataEmissao"]');
        if (elData) elData.value = hoje;
        $('#modalNovaProforma').modal('show');
      });
    })();

    // Calcular total automaticamente para Proforma
    const calcularTotalProforma = () => {
      const subtotalEl = document.querySelector('#formNovaProforma input[name="subtotal"]');
      const impostosEl = document.querySelector('#formNovaProforma input[name="impostos"]');
      const totalEl = document.querySelector('#formNovaProforma input[name="total"]');
      
      if (subtotalEl && impostosEl && totalEl) {
        const subtotal = parseFloat(subtotalEl.value) || 0;
        const impostos = parseFloat(impostosEl.value) || 0;
        const total = subtotal + impostos;
        totalEl.value = total.toFixed(2);
      }
    };

    (function(){
      const subtotalProformaEl = document.querySelector('#formNovaProforma input[name="subtotal"]');
      if (subtotalProformaEl) subtotalProformaEl.addEventListener('input', calcularTotalProforma);
    })();
    (function(){
      const impostosProformaEl = document.querySelector('#formNovaProforma input[name="impostos"]');
      if (impostosProformaEl) impostosProformaEl.addEventListener('input', calcularTotalProforma);
    })();

    // Salvar nova proforma
    (function(){
      const btn = document.getElementById('btnSalvarProforma');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        const form = document.getElementById('formNovaProforma');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const formData = new FormData(form);
        const proforma = {
          numero: formData.get('numero'),
          cliente: formData.get('cliente'),
          dataEmissao: formData.get('dataEmissao'),
          validade: parseInt(formData.get('validade')) || 30,
          subtotal: parseFloat(formData.get('subtotal')) || 0,
          impostos: parseFloat(formData.get('impostos')) || 0,
          total: parseFloat(formData.get('total')) || 0,
          moeda: formData.get('moeda'),
          estado: formData.get('estado'),
          condicoesPagamento: formData.get('condicoesPagamento') || '',
          descricao: formData.get('descricao') || '',
          observacoes: formData.get('observacoes') || '',
          tipo: 'Proforma' // Identificar como proforma
        };

        try {
          const token = localStorage.getItem('token');
          const response = await fetch('/api/faturas/proforma', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(proforma)
          });

          if (response.ok) {
            alert('Fatura Proforma criada com sucesso!');
            $('#modalNovaProforma').modal('hide');
            fetchFaturas(); // Recarregar lista de faturas
          } else {
            const error = await response.json();
            alert('Erro ao criar proforma: ' + (error.message || 'Erro desconhecido'));
          }
        } catch (error) {
          console.error('Erro ao salvar proforma:', error);
          alert('Erro ao salvar proforma. Verifique a conexão.');
        }
      });
    })();

    // Inicialização após definição das funções
    selectTabFromHash();
    fetchBancos();
    fetchPagamentos();
    fetchDespesas();
    fetchImpostos();
    fetchFundo();
    fetchFaturas(); // Adicionar busca de faturas
  </script>

  <script>
    // Recarregar dados ao mudar de aba (garante bancos ao abrir #bancos)
    $(document).on('shown.bs.tab', "a[data-toggle='pill']", function (e) {
      const href = e.target.getAttribute('href');
      switch (href) {
        case '#bancos':
          fetchBancos();
          break;
        case '#pagamentos':
          fetchPagamentos();
          break;
        case '#despesas':
          fetchDespesas();
          break;
        case '#impostos':
          fetchImpostos();
          break;
        case '#fundo':
          fetchFundo();
          break;
        case '#faturas':
          fetchFaturas();
          break;
      }
    });
  </script>

  <!-- Modal Adicionar Pagamento -->
  <div class="modal fade" id="modalAddPagamento" tabindex="-1" role="dialog" aria-labelledby="modalAddPagamentoLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAddPagamentoLabel">Adicionar Pagamento</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <form id="formAddPagamento">
            <div class="form-row">
              <div class="form-group col-md-4"><label>Data</label><input name="data" type="date" class="form-control form-control-sm"></div>
              <div class="form-group col-md-4"><label>Valor</label><input name="valor" type="number" step="0.01" class="form-control form-control-sm" required></div>
              <div class="form-group col-md-4"><label>Método</label>
                <select name="metodo" class="form-control form-control-sm">
                  <option value="Transferência">Transferência</option>
                  <option value="Cheque">Cheque</option>
                  <option value="Dinheiro">Dinheiro</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Fatura</label>
                <input name="faturaDisplay" class="form-control form-control-sm" readonly>
              </div>
              <div class="form-group col-md-6">
                <label>Cliente</label>
                <input name="clienteDisplay" class="form-control form-control-sm" readonly>
              </div>
            </div>
            <div class="form-group"><label>Descrição/Referência</label><input name="ref" class="form-control form-control-sm"></div>
            <input type="hidden" name="faturaId">
            <input type="hidden" name="numeroFatura">
            <input type="hidden" name="cliente">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" id="btnSalvarPagamento" class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Detalhes do Pagamento/Fatura -->
  <div class="modal fade" id="modalDetalhePagamento" tabindex="-1" role="dialog" aria-labelledby="modalDetalhePagamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalDetalhePagamentoLabel">Detalhes da Fatura / Pagamento</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="row mb-2">
            <div class="col-md-4">
              <strong>Nº Fatura:</strong>
              <div id="detFatNumero">-</div>
            </div>
            <div class="col-md-4">
              <strong>Fornecedor/Cliente:</strong>
              <div id="detFatFornecedor">-</div>
            </div>
            <div class="col-md-4">
              <strong>Data:</strong>
              <div id="detFatData">-</div>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col-md-4">
              <strong>Total:</strong>
              <div id="detFatTotal">0,00 Kz</div>
            </div>
            <div class="col-md-4">
              <strong>Pago:</strong>
              <div id="detFatPago">0,00 Kz</div>
            </div>
            <div class="col-md-4">
              <strong>Em Aberto:</strong>
              <div id="detFatAberto">0,00 Kz</div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4">
              <strong>Estado:</strong>
              <div><span id="detFatEstado" class="badge badge-secondary">Pendente</span></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
          <button type="button" id="btnDetalhePagar" class="btn btn-primary" onclick="pagarFaturaFromDetalhe()">Pagar agora</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Adicionar Despesa -->
  <div class="modal fade" id="modalAddDespesa" tabindex="-1" role="dialog" aria-labelledby="modalAddDespesaLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAddDespesaLabel">Adicionar Despesa</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <form id="formAddDespesa">
            <div class="form-row">
              <div class="form-group col-md-4"><label>Data</label><input name="data" type="date" class="form-control form-control-sm"></div>
              <div class="form-group col-md-4"><label>Categoria</label><input name="categoria" class="form-control form-control-sm"></div>
              <div class="form-group col-md-4"><label>Valor</label><input name="valor" type="number" step="0.01" class="form-control form-control-sm" required></div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-8"><label>Descrição</label><input name="descricao" class="form-control form-control-sm"></div>
              <div class="form-group col-md-4"><label>Centro de Custo</label><input name="centro" class="form-control form-control-sm"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" id="btnSalvarDespesa" class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Adicionar Imposto -->
  <div class="modal fade" id="modalAddImposto" tabindex="-1" role="dialog" aria-labelledby="modalAddImpostoLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAddImpostoLabel">Registar/Declarar Imposto</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <form id="formAddImposto">
            <div class="form-row">
              <div class="form-group col-md-3"><label>Período</label><input name="periodo" class="form-control form-control-sm" placeholder="2025-10"></div>
              <div class="form-group col-md-3"><label>Imposto</label>
                <select name="imposto" class="form-control form-control-sm">
                  <option value="IVA">IVA</option>
                  <option value="IR">IR</option>
                  <option value="IS">IS</option>
                </select>
              </div>
              <div class="form-group col-md-3"><label>Base</label><input name="base" type="number" step="0.01" class="form-control form-control-sm"></div>
              <div class="form-group col-md-3"><label>Valor</label><input name="valor" type="number" step="0.01" class="form-control form-control-sm" required></div>
            </div>
            <div class="form-group"><label>Status</label>
              <select name="status" class="form-control form-control-sm">
                <option value="Declarado">Declarado</option>
                <option value="Pago">Pago</option>
                <option value="Pendente">Pendente</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" id="btnSalvarImposto" class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Movimentar Fundo -->
  <div class="modal fade" id="modalAddFundo" tabindex="-1" role="dialog" aria-labelledby="modalAddFundoLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAddFundoLabel">Movimentar Fundo</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <form id="formAddFundo">
            <div class="form-row">
              <div class="form-group col-md-4"><label>Data</label><input name="data" type="date" class="form-control form-control-sm"></div>
              <div class="form-group col-md-4"><label>Tipo</label>
                <select name="tipo" class="form-control form-control-sm">
                  <option value="Entrada">Entrada</option>
                  <option value="Saida">Saída</option>
                </select>
              </div>
              <div class="form-group col-md-4"><label>Valor</label><input name="valor" type="number" step="0.01" class="form-control form-control-sm" required></div>
            </div>
            <div class="form-group"><label>Descrição</label><input name="desc" class="form-control form-control-sm"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" id="btnSalvarFundo" class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Adicionar Banco -->
  <div class="modal fade" id="modalAddBanco" tabindex="-1" role="dialog" aria-labelledby="modalAddBancoLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAddBancoLabel">Adicionar Banco</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="formAddBanco">
            <div class="form-group">
              <label>Banco</label>
              <input name="banco" class="form-control form-control-sm" required>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Agência</label>
                <input name="agencia" class="form-control form-control-sm">
              </div>
              <div class="form-group col-md-6">
                <label>Conta</label>
                <input name="conta" class="form-control form-control-sm">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-8">
                <label>IBAN</label>
                <input name="iban" class="form-control form-control-sm">
              </div>
              <div class="form-group col-md-4">
                <label>Saldo</label>
                <input name="saldo" type="number" step="0.01" class="form-control form-control-sm">
              </div>
            </div>
            <div class="form-group">
              <label>Logo do Banco</label>
              <input id="logo_file" name="logo_file" type="file" accept="image/*" class="form-control-file">
              <img id="bancoLogoPreview" alt="Pré-visualização" style="display:none;margin-top:8px;height:48px;width:48px;object-fit:contain;border:1px solid #eaeaea;border-radius:6px;" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" id="btnSalvarBanco" class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Editar Banco -->
  <div class="modal fade" id="modalEditBanco" tabindex="-1" role="dialog" aria-labelledby="modalEditBancoLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditBancoLabel">Editar Banco</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="formEditBanco">
            <div class="form-group">
              <label>Banco</label>
              <input name="banco" class="form-control form-control-sm" required>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Agência</label>
                <input name="agencia" class="form-control form-control-sm">
              </div>
              <div class="form-group col-md-6">
                <label>Conta</label>
                <input name="conta" class="form-control form-control-sm">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-8">
                <label>IBAN</label>
                <input name="iban" class="form-control form-control-sm">
              </div>
              <div class="form-group col-md-4">
                <label>Saldo</label>
                <input name="saldo" type="number" step="0.01" class="form-control form-control-sm">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" id="btnSalvarBancoEdit" class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nova Fatura -->
  <div class="modal fade" id="modalNovaFatura" tabindex="-1" role="dialog" aria-labelledby="modalNovaFaturaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalNovaFaturaLabel">Nova Fatura</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="formNovaFatura">
            <div class="form-row">
              <div class="form-group col-md-4">
                <label>Número da Fatura *</label>
                <input name="numero" type="text" class="form-control form-control-sm" required placeholder="Ex: FT-2025-001">
              </div>
              <div class="form-group col-md-8">
                <label>Cliente *</label>
                <input name="cliente" type="text" class="form-control form-control-sm" required placeholder="Nome do cliente">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Data de Emissão *</label>
                <input name="dataEmissao" type="date" class="form-control form-control-sm" required>
              </div>
              <div class="form-group col-md-6">
                <label>Data de Vencimento *</label>
                <input name="dataVencimento" type="date" class="form-control form-control-sm" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-4">
                <label>Subtotal (Kz) *</label>
                <input name="subtotal" type="number" step="0.01" class="form-control form-control-sm" required placeholder="0.00">
              </div>
              <div class="form-group col-md-4">
                <label>Impostos (Kz)</label>
                <input name="impostos" type="number" step="0.01" class="form-control form-control-sm" placeholder="0.00" value="0">
              </div>
              <div class="form-group col-md-4">
                <label>Total (Kz) *</label>
                <input name="total" type="number" step="0.01" class="form-control form-control-sm" required placeholder="0.00" readonly>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Valor Pago (Kz)</label>
                <input name="valorPago" type="number" step="0.01" class="form-control form-control-sm" placeholder="0.00" value="0">
              </div>
              <div class="form-group col-md-6">
                <label>Estado</label>
                <select name="estado" class="form-control form-control-sm">
                  <option value="Pendente">Pendente</option>
                  <option value="Pago">Pago</option>
                  <option value="Parcialmente Pago">Parcialmente Pago</option>
                  <option value="Vencido">Vencido</option>
                  <option value="Cancelado">Cancelado</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>Descrição/Observações</label>
              <textarea name="descricao" class="form-control form-control-sm" rows="3" placeholder="Descrição dos serviços/produtos..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" id="btnSalvarFatura" class="btn btn-primary">Salvar Fatura</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nova Fatura Proforma -->
  <div class="modal fade" id="modalNovaProforma" tabindex="-1" role="dialog" aria-labelledby="modalNovaProformaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title" id="modalNovaProformaLabel"><i class="fas fa-file-invoice-dollar"></i> Nova Fatura Proforma</h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info alert-sm">
            <i class="fas fa-info-circle"></i> <strong>Fatura Proforma:</strong> Documento preliminar que indica a intenção de venda. Não tem valor fiscal.
          </div>
          <form id="formNovaProforma">
            <div class="form-row">
              <div class="form-group col-md-4">
                <label>Número da Proforma *</label>
                <input name="numero" type="text" class="form-control form-control-sm" required placeholder="Ex: PRF-2025-001">
              </div>
              <div class="form-group col-md-8">
                <label>Cliente *</label>
                <input name="cliente" type="text" class="form-control form-control-sm" required placeholder="Nome do cliente">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Data de Emissão *</label>
                <input name="dataEmissao" type="date" class="form-control form-control-sm" required>
              </div>
              <div class="form-group col-md-6">
                <label>Validade (dias)</label>
                <input name="validade" type="number" class="form-control form-control-sm" placeholder="30" value="30">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-4">
                <label>Subtotal (Kz) *</label>
                <input name="subtotal" type="number" step="0.01" class="form-control form-control-sm" required placeholder="0.00">
              </div>
              <div class="form-group col-md-4">
                <label>Impostos (Kz)</label>
                <input name="impostos" type="number" step="0.01" class="form-control form-control-sm" placeholder="0.00" value="0">
              </div>
              <div class="form-group col-md-4">
                <label>Total (Kz) *</label>
                <input name="total" type="number" step="0.01" class="form-control form-control-sm" required placeholder="0.00" readonly>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Moeda</label>
                <select name="moeda" class="form-control form-control-sm">
                  <option value="Kz">Kwanza (Kz)</option>
                  <option value="USD">Dólar Americano (USD)</option>
                  <option value="EUR">Euro (EUR)</option>
                </select>
              </div>
              <div class="form-group col-md-6">
                <label>Estado</label>
                <select name="estado" class="form-control form-control-sm">
                  <option value="Pendente">Pendente</option>
                  <option value="Aprovada">Aprovada</option>
                  <option value="Convertida">Convertida em Fatura</option>
                  <option value="Expirada">Expirada</option>
                  <option value="Cancelada">Cancelada</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>Condições de Pagamento</label>
              <input name="condicoesPagamento" type="text" class="form-control form-control-sm" placeholder="Ex: 50% antecipado, 50% na entrega">
            </div>

            <div class="form-group">
              <label>Descrição/Itens</label>
              <textarea name="descricao" class="form-control form-control-sm" rows="4" placeholder="Descrição detalhada dos serviços/produtos..."></textarea>
            </div>

            <div class="form-group">
              <label>Observações</label>
              <textarea name="observacoes" class="form-control form-control-sm" rows="2" placeholder="Observações adicionais..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" id="btnSalvarProforma" class="btn btn-info">Salvar Proforma</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
